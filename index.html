<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Семейный бюджет</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    /* Все стили оставляем без изменений */
    :root {
      --primary: #3b82f6;
      --primary-light: #bfdbfe;
      --secondary: #10b981;
      --accent: #8b5cf6;
      --warning: #f59e0b;
      --danger: #ef4444;
      --success: #22c55e;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f8fafc;
      color: var(--gray-800);
      line-height: 1.5;
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }
    
    /* Все остальные стили остаются без изменений */
  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div class="auth-modal" id="auth-modal">
    <div class="auth-card">
      <div class="auth-logo">
        <i class="fas fa-home"></i>
      </div>
      <h2 class="auth-title">Семейный бюджет</h2>
      <p class="auth-subtitle">Войдите в свою комнату или создайте новую</p>
      
      <div class="form-group">
        <label class="form-label" for="room-name">Название комнаты</label>
        <input type="text" id="room-name" class="form-input" placeholder="Например: Семья Ивановых" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="room-password">Пароль</label>
        <input type="password" id="room-password" class="form-input" placeholder="Введите пароль" required>
      </div>
      
      <button class="auth-btn" id="login-btn">
        <i class="fas fa-door-open"></i> Войти в комнату
      </button>
      
      <div class="auth-separator">
        <span>или</span>
      </div>
      
      <button class="auth-btn" style="background: linear-gradient(135deg, var(--secondary), #0da271);" id="create-room-btn">
        <i class="fas fa-plus-circle"></i> Создать новую комнату
      </button>
    </div>
  </div>

  <header>
    <div class="container header-container">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-home"></i>
        </div>
        <div class="logo-text">Семейный бюджет</div>
      </div>
      <div class="room-info">
        <i class="fas fa-door-open"></i>
        <span id="current-room">Комната не выбрана</span>
      </div>
      <button class="settings-btn" id="settings-btn">
        <i class="fas fa-cog"></i>
      </button>
    </div>
    <div class="container">
      <div class="nav-tabs">
        <div class="tab active" data-tab="budget">
          <i class="fas fa-home"></i> Бюджет
        </div>
        <div class="tab" data-tab="shopping">
          <i class="fas fa-shopping-cart"></i> Список покупок
        </div>
        <div class="tab" data-tab="planner">
          <i class="fas fa-calendar-alt"></i> Планировщик
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Budget Tab -->
    <div class="tab-content active" id="budget-tab">
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-title">Текущий баланс</div>
          <div class="summary-value positive" id="current-balance">0 ₽</div>
        </div>
        <div class="summary-card">
          <div class="summary-title">Накопления</div>
          <div class="summary-value warning" id="savings">0 ₽</div>
        </div>
        <div class="summary-card">
          <div class="summary-title">Можно тратить в день</div>
          <div class="summary-value" id="daily-spend">0 ₽</div>
        </div>
        <div class="summary-card">
          <div class="summary-title">Обязательные траты</div>
          <div class="summary-value negative" id="mandatory-expenses">0 ₽</div>
        </div>
      </div>

      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-title" id="calendar-month">Декабрь 2025</div>
          <div class="calendar-nav">
            <button class="calendar-nav-btn" id="prev-month">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="calendar-nav-btn" id="next-month">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div class="calendar-grid">
          <div class="calendar-day-header">Пн</div>
          <div class="calendar-day-header">Вт</div>
          <div class="calendar-day-header">Ср</div>
          <div class="calendar-day-header">Чт</div>
          <div class="calendar-day-header">Пт</div>
          <div class="calendar-day-header">Сб</div>
          <div class="calendar-day-header">Вс</div>
          <!-- Calendar days will be generated by JavaScript -->
          <div id="calendar-days" class="calendar-grid"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-history"></i> История операций
          </div>
          <div class="action-buttons">
            <div class="search-container">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" id="transaction-search" placeholder="Поиск операций...">
            </div>
            <div class="file-upload-container">
              <label class="file-upload-label" for="file-upload">
                <i class="fas fa-file-excel"></i> Загрузить выписку
              </label>
              <input type="file" id="file-upload" class="file-upload-input" accept=".xlsx, .xls">
            </div>
            <button class="btn btn-secondary" id="all-time-btn">
              <i class="fas fa-clock"></i> За всё время
            </button>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Дата</th>
                <th>Категория</th>
                <th>Описание</th>
                <th>Сумма</th>
                <th>Баланс</th>
              </tr>
            </thead>
            <tbody id="transactions-table">
              <tr>
                <td colspan="5" class="empty-state">
                  <div class="empty-icon">
                    <i class="fas fa-search-dollar"></i>
                  </div>
                  <div class="empty-title">Нет операций</div>
                  <div class="empty-description">Добавьте первую операцию или загрузите выписку из банка</div>
                  <button class="empty-action" id="add-first-transaction">
                    <i class="fas fa-plus"></i> Добавить операцию
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-chart-pie"></i> Категории
          </div>
        </div>
        <div class="categories-list" id="categories-list">
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div class="empty-title">Нет данных о категориях</div>
            <div class="empty-description">Добавьте операции для отображения категорий расходов</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Shopping Tab -->
    <div class="tab-content" id="shopping-tab">
      <div class="shopping-container">
        <div class="shopping-section">
          <div class="section-title">
            <i class="fas fa-plus-circle"></i> Добавление товара
          </div>
          <form id="quick-add-form">
            <div class="form-group">
              <label class="form-label">Название товара</label>
              <input type="text" class="form-input" list="shopping-dictionary" id="item-name" placeholder="Например: молоко, хлеб..." required>
              <datalist id="shopping-dictionary">
                <option value="молоко">
                <option value="хлеб">
                <option value="яйца">
                <option value="сыр">
                <option value="масло"> 
              </datalist>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Количество</label>
                <input type="number" class="form-input" id="item-quantity" placeholder="1" min="1" required>
              </div>
              <div class="form-group">
                <label class="form-label">Единица измерения</label>
                <select class="form-input form-select" id="item-unit">
                  <option value="шт">шт</option>
                  <option value="л">л</option>
                  <option value="г">г</option>
                  <option value="кг">кг</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-full" id="add-shopping-item-btn">
              <i class="fas fa-plus"></i> Добавить в список
            </button>
          </form>
          
          <div class="frequent-items">
            <div class="frequent-title">
              <i class="fas fa-chart-line"></i> Частые покупки
            </div>
            <div class="frequent-list">
              <span class="frequent-item">молоко</span>
              <span class="frequent-item">хлеб</span>
              <span class="frequent-item">яйца</span>
              <span class="frequent-item">курица</span>
              <span class="frequent-item">картофель</span>
            </div>
          </div>
        </div>
        
        <div class="shopping-section">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-list"></i> Список покупок
            </div>
            <button class="btn btn-success" id="send-to-telegram">
              <i class="fas fa-paper-plane"></i> Отправить в Telegram
            </button>
          </div>
          <div class="table-container">
            <div id="shopping-list">
              <div class="empty-state">
                <div class="empty-icon">
                  <i class="fas fa-shopping-basket"></i>
                </div>
                <div class="empty-title">Список покупок пуст</div>
                <div class="empty-description">Добавьте товары, чтобы начать планирование покупок</div>
                <button class="empty-action" id="add-shopping-item-manual">
                  <i class="fas fa-plus"></i> Добавить товар
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Planner Tab -->
    <div class="tab-content" id="planner-tab">
      <div class="planner-container">
        <div class="planner-header">
          <div class="calendar-title" id="planner-period">Декабрь 2025</div>
          <div class="view-buttons">
            <button class="view-btn active" data-view="month" id="view-month-btn">Месяц</button>
            <button class="view-btn" data-view="week" id="view-week-btn">Неделя</button>
          </div>
        </div>

        <div id="month-view">
          <div class="calendar-grid">
            <div class="calendar-day-header">Пн</div>
            <div class="calendar-day-header">Вт</div>
            <div class="calendar-day-header">Ср</div>
            <div class="calendar-day-header">Чт</div>
            <div class="calendar-day-header">Пт</div>
            <div class="calendar-day-header">Сб</div>
            <div class="calendar-day-header">Вс</div>
            <!-- Month calendar will be generated by JavaScript -->
            <div id="month-calendar-days" class="calendar-grid"></div>
          </div>
        </div>

        <div id="week-view" style="display: none;">
          <div class="week-view">
            <div class="week-header">Время</div>
            <div class="week-header">Пн, 10</div>
            <div class="week-header">Вт, 11</div>
            <div class="week-header">Ср, 12</div>
            <div class="week-header">Чт, 13</div>
            <div class="week-header">Пт, 14</div>
            <div class="week-header">Сб, 15</div>
            <div class="week-header">Вс, 16</div>
            
            <div class="week-time">8:00</div>
            <div class="week-cell" data-day="0" data-hour="8"></div>
            <div class="week-cell" data-day="1" data-hour="8"></div>
            <div class="week-cell" data-day="2" data-hour="8"></div>
            <div class="week-cell" data-day="3" data-hour="8"></div>
            <div class="week-cell" data-day="4" data-hour="8"></div>
            <div class="week-cell" data-day="5" data-hour="8"></div>
            <div class="week-cell" data-day="6" data-hour="8"></div>
            
            <div class="week-time">9:00</div>
            <div class="week-cell" data-day="0" data-hour="9"></div>
            <div class="week-cell" data-day="1" data-hour="9"></div>
            <div class="week-cell" data-day="2" data-hour="9"></div>
            <div class="week-cell" data-day="3" data-hour="9"></div>
            <div class="week-cell" data-day="4" data-hour="9"></div>
            <div class="week-cell" data-day="5" data-hour="9"></div>
            <div class="week-cell" data-day="6" data-hour="9"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Settings Modal -->
  <div class="modal settings-modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Настройки</div>
        <button class="modal-close" id="close-settings">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <div class="settings-title">
            <i class="fas fa-wallet"></i> Бюджет
          </div>
          <div class="settings-grid">
            <div class="settings-item">
              <label class="form-label">Начальный остаток</label>
              <input type="number" class="form-input" id="initial-balance" placeholder="Введите остаток на начало периода" value="0">
            </div>
            <div class="settings-item">
              <label class="form-label">Процент для откладывания</label>
              <input type="number" class="form-input" id="savings-percentage" placeholder="Например: 10" value="" min="0" max="100">
            </div>
          </div>
          
          <div class="accordion">
            <div class="accordion-header" id="mandatory-expenses-header">
              <div class="accordion-title">Обязательные траты</div>
              <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content" id="mandatory-expenses-content">
              <div class="participants-list">
                <button class="btn btn-primary" style="margin-top: 1rem;" id="add-mandatory-expense">
                  <i class="fas fa-plus"></i> Добавить трату
                </button>
              </div>
            </div>
          </div>
          
          <button class="btn btn-secondary" style="margin-top: 1rem;" id="clear-transactions">
            <i class="fas fa-trash"></i> Очистка операций
          </button>
        </div>
        
        <div class="settings-section">
          <div class="settings-title">
            <i class="fas fa-cog"></i> Парсер выписок
          </div>
          <div class="settings-item">
            <label class="form-label">Настройки парсера</label>
            <p class="form-input" style="background-color: var(--gray-100); padding: 1rem; border-radius: 0.5rem;">
              Парсер настроен для обработки выписок Альфа-Банка<br>
              Поддерживаемые форматы: .xlsx, .xls<br>
              <small class="text-gray-500">Автоматическое определение категорий и проверка дубликатов</small>
            </p>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="settings-title">
            <i class="fas fa-shopping-cart"></i> Список покупок
          </div>
          <div class="settings-grid">
            <div class="settings-item">
              <label class="form-label">ID Telegram бота</label>
              <input type="text" class="form-input" id="telegram-bot-id" placeholder="123456789:ABCdefGhiJKLmnoPQRstuVWXyz">
            </div>
            <div class="settings-item">
              <label class="form-label">ID Telegram чата</label>
              <input type="text" class="form-input" id="telegram-chat-id" placeholder="-1001234567890">
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="settings-title">
            <i class="fas fa-calendar-alt"></i> Планировщик
          </div>
          
          <div class="settings-item">
            <div class="accordion-header" id="participants-header">
              <div class="accordion-title">Участники</div>
              <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content" id="participants-content">
              <div class="participants-list" id="participants-list">
                <!-- Participants will be added here dynamically -->
                <div class="empty-state" style="padding: 1rem;">
                  <p class="empty-description">Нет участников</p>
                </div>
              </div>
              <button class="btn btn-primary" style="margin-top: 1rem;" id="add-participant">
                <i class="fas fa-plus"></i> Добавить участника
              </button>
            </div>
          </div>
          
          <div class="settings-item" style="margin-top: 1rem;">
            <div class="accordion-header" id="templates-header">
              <div class="accordion-title">Шаблоны событий</div>
              <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content" id="templates-content">
              <div class="templates-list" id="templates-list">
                <!-- Templates will be added here dynamically -->
                <div class="empty-state" style="padding: 1rem;">
                  <p class="empty-description">Нет шаблонов</p>
                </div>
              </div>
              <button class="btn btn-primary" style="margin-top: 1rem;" id="add-template">
                <i class="fas fa-plus"></i> Создать шаблон
              </button>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="settings-title">
            <i class="fas fa-door-open"></i> Комнаты
          </div>
          <div class="settings-item">
            <label class="form-label">Текущая комната</label>
            <div class="form-input" style="background-color: var(--gray-100); padding: 1rem; border-radius: 0.5rem;" id="current-room-settings">
              Не выбрана
            </div>
          </div>
          <div class="settings-item">
            <button class="btn btn-danger" id="logout-btn" style="width: 100%;">
              <i class="fas fa-sign-out-alt"></i> Выйти из комнаты
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-settings">Отмена</button>
        <button class="btn btn-primary" id="save-settings">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Transaction Modal -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Новая операция</div>
        <button class="modal-close" id="close-transaction">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Тип операции</label>
          <select class="form-input form-select" id="transaction-type">
            <option value="expense">Расход</option>
            <option value="income">Приход</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Сумма</label>
          <input type="number" class="form-input" id="transaction-amount" placeholder="0.00" required>
        </div>
        <div class="form-group">
          <label class="form-label">Категория</label>
          <input type="text" class="form-input" list="categories-dictionary" id="transaction-category" placeholder="Выберите или создайте категорию" required>
          <datalist id="categories-dictionary">
            <option value="Продукты">
            <option value="Транспорт">
            <option value="Жилье">
            <option value="Аренда">
            <option value="Квартплата">
            <option value="Развлечения">
            <option value="Кафе">
            <option value="Одежда">
            <option value="Здоровье">
            <option value="Образование">
            <option value="Зарплата">
          </datalist>
        </div>
        <div class="form-group">
          <label class="form-label">Описание</label>
          <input type="text" class="form-input" id="transaction-description" placeholder="Необязательное описание">
        </div>
        <div class="form-group">
          <label class="form-label">Дата</label>
          <input type="date" class="form-input" id="transaction-date" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-transaction">Отмена</button>
        <button class="btn btn-primary" id="save-transaction">Добавить операцию</button>
      </div>
    </div>
  </div>

  <!-- Import Preview Modal -->
  <div class="modal" id="import-modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-file-import"></i> Предпросмотр выписки
        </div>
        <button class="modal-close" id="close-import">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
          <div class="file-name" style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-file-excel"></i>
            <span id="preview-file-name">Файл не выбран</span>
          </div>
          <div class="progress-container">
            <div class="progress-bar" id="import-progress"></div>
          </div>
        </div>
        
        <div id="import-error" class="notification error" style="display: none; margin-bottom: 1rem;">
          <i class="fas fa-exclamation-circle"></i>
          <span id="error-message">Ошибка при загрузке файла</span>
        </div>
        
        <div class="table-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem;">
          <table class="preview-table">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Описание</th>
                <th>Сумма</th>
                <th>Категория</th>
              </tr>
            </thead>
            <tbody id="import-preview">
              <tr>
                <td colspan="4" class="text-center py-8 text-gray-500">Нет данных для отображения</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="text-align: center; padding: 1rem; background-color: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
            <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;" id="total-transactions">0</div>
            <div style="color: var(--gray-600); font-size: 0.875rem;">Всего операций</div>
          </div>
          <div style="text-align: center; padding: 1rem; background-color: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
            <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--success);" id="total-income">0 ₽</div>
            <div style="color: var(--gray-600); font-size: 0.875rem;">Доход</div>
          </div>
          <div style="text-align: center; padding: 1rem; background-color: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
            <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--danger);" id="total-expense">0 ₽</div>
            <div style="color: var(--gray-600); font-size: 0.875rem;">Расход</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-import">
          <i class="fas fa-times"></i> Отмена
        </button>
        <button class="btn btn-success" id="import-transactions">
          <i class="fas fa-check-circle"></i> Импортировать операции
        </button>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal" id="event-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Новое событие</div>
        <button class="modal-close" id="close-event">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Название события</label>
          <input type="text" class="form-input" id="event-title" placeholder="Введите название события" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Дата начала</label>
            <input type="datetime-local" class="form-input" id="event-start" required>
          </div>
          <div class="form-group">
            <label class="form-label">Дата окончания</label>
            <input type="datetime-local" class="form-input" id="event-end">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Участники</label>
          <div class="participants-list" id="event-participants">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Описание</label>
          <textarea class="form-input" id="event-description" rows="3" placeholder="Дополнительная информация о событии"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Выбрать из шаблона</label>
          <div class="frequent-list" id="template-suggestions">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-event">Отмена</button>
        <button class="btn btn-primary" id="save-event">Создать событие</button>
      </div>
    </div>
  </div>

  <!-- Shopping Item Modal -->
  <div class="modal" id="shopping-item-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Редактирование товара</div>
        <button class="modal-close" id="close-shopping-item">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Название товара</label>
          <input type="text" class="form-input" id="edit-item-name" value="Молоко" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Количество</label>
            <input type="number" class="form-input" id="edit-item-quantity" value="1" min="1" required>
          </div>
          <div class="form-group">
            <label class="form-label">Единица измерения</label>
            <select class="form-input form-select" id="edit-item-unit">
              <option value="шт">шт</option>
              <option value="л" selected>л</option>
              <option value="г">г</option>
              <option value="кг">кг</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="item-purchased"> Куплено
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="delete-shopping-item">
          <i class="fas fa-trash"></i> Удалить
        </button>
        <button class="btn btn-primary" id="save-shopping-item">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <i class="fas fa-bell"></i>
    <span>Операция успешно добавлена</span>
  </div>

  <script>
    // Firebase configuration - replace with your actual config
    const firebaseConfig = {
      apiKey: "AIzaSyD3x0z9hGqZqZzZzZzZzZzZzZzZzZzZzZz",
      authDomain: "budg-1d5e0.firebaseapp.com",
      databaseURL: "https://budg-1d5e0-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "budg-1d5e0",
      storageBucket: "budg-1d5e0.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdefghijklmnop"
    };
    
    // DOM Elements - will be initialized after DOM is loaded
    let authModal, loginBtn, createRoomBtn, roomNameInput, roomPasswordInput, currentRoomElement;
    let tabButtons, tabContents, settingsBtn, settingsModal, closeSettings, cancelSettings, saveSettings;
    let logoutBtn, transactionModal, closeTransaction, cancelTransaction, saveTransaction, addFirstTransaction;
    let fileUpload, importModal, closeImport, cancelImport, importTransactionsBtn;
    let shoppingItems, sendToTelegram, frequentItems, monthView, weekView, viewButtons, weekCells;
    let eventModal, closeEvent, cancelEvent, saveEvent, notification;
    let mandatoryExpensesHeader, mandatoryExpensesContent, participantsHeader, participantsContent, templatesHeader, templatesContent;
    let prevMonthBtn, nextMonthBtn, calendarDaysContainer, monthCalendarDaysContainer, calendarMonth, plannerPeriod;
    let closeShoppingItem, saveShoppingItem, deleteShoppingItem, shoppingItemModal, quickAddForm;
    
    // State variables
    let currentMonth = new Date(2025, 11, 1); // December 2025
    let plannerView = 'month'; // 'month' or 'week'
    let today = new Date();
    let currentRoomId = null;
    let currentRoomName = null;
    let transactions = [];
    let categories = {};
    let settings = {
      initialBalance: 0,
      savingsPercentage: '',
      telegramBotId: '',
      telegramChatId: ''
    };
    let shoppingItemsList = [];
    let events = [];
    let participants = [];
    let templates = [];
    let mandatoryExpenses = [];
    
    // Application data
    const appData = {
      rooms: {}
    };
    
    // Check localStorage availability
    let canUseLocalStorage = true;
    
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
    } catch (e) {
      canUseLocalStorage = false;
      console.warn('localStorage is not available. Using in-memory storage.');
    }
    
    // Initialize Firebase with anonymous authentication
    function initFirebase() {
      try {
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Try anonymous sign-in if no user is logged in
        auth.onAuthStateChanged(user => {
          if (!user) {
            auth.signInAnonymously()
              .then(() => {
                console.log('Anonymous sign-in successful');
              })
              .catch(error => {
                console.error('Anonymous sign-in error:', error);
                showNotification('Ошибка при аутентификации. Попробуйте позже.', 'error');
              });
          } else {
            console.log('User authenticated:', user.uid);
            loadUserData(user.uid);
          }
        });
        
        return { auth, database };
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showNotification('Ошибка инициализации Firebase. Работаем в offline-режиме.', 'warning');
        return null;
      }
    }
    
    // DOMContentLoaded event handler
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DOM elements
      initializeDOMElements();
      
      // Initialize Firebase
      const firebaseServices = initFirebase();
      
      // Set up event listeners
      setupEventListeners();
      
      // Check saved room
      checkSavedRoom();
      
      // Initialize UI
      initializeUI();
    });
    
    // Initialize DOM elements safely
    function initializeDOMElements() {
      authModal = document.getElementById('auth-modal');
      loginBtn = document.getElementById('login-btn');
      createRoomBtn = document.getElementById('create-room-btn');
      roomNameInput = document.getElementById('room-name');
      roomPasswordInput = document.getElementById('room-password');
      currentRoomElement = document.getElementById('current-room');
      
      tabButtons = document.querySelectorAll('.tab');
      tabContents = document.querySelectorAll('.tab-content');
      settingsBtn = document.getElementById('settings-btn');
      settingsModal = document.getElementById('settings-modal');
      closeSettings = document.getElementById('close-settings');
      cancelSettings = document.getElementById('cancel-settings');
      saveSettings = document.getElementById('save-settings');
      logoutBtn = document.getElementById('logout-btn');
      
      transactionModal = document.getElementById('transaction-modal');
      closeTransaction = document.getElementById('close-transaction');
      cancelTransaction = document.getElementById('cancel-transaction');
      saveTransaction = document.getElementById('save-transaction');
      addFirstTransaction = document.getElementById('add-first-transaction');
      
      fileUpload = document.getElementById('file-upload');
      importModal = document.getElementById('import-modal');
      closeImport = document.getElementById('close-import');
      cancelImport = document.getElementById('cancel-import');
      importTransactionsBtn = document.getElementById('import-transactions');
      
      shoppingItems = document.querySelectorAll('.shopping-item');
      sendToTelegram = document.getElementById('send-to-telegram');
      frequentItems = document.querySelectorAll('.frequent-item');
      
      monthView = document.getElementById('month-view');
      weekView = document.getElementById('week-view');
      viewButtons = document.querySelectorAll('.view-btn');
      
      weekCells = document.querySelectorAll('.week-cell');
      
      eventModal = document.getElementById('event-modal');
      closeEvent = document.getElementById('close-event');
      cancelEvent = document.getElementById('cancel-event');
      saveEvent = document.getElementById('save-event');
      
      notification = document.getElementById('notification');
      
      mandatoryExpensesHeader = document.getElementById('mandatory-expenses-header');
      mandatoryExpensesContent = document.getElementById('mandatory-expenses-content');
      participantsHeader = document.getElementById('participants-header');
      participantsContent = document.getElementById('participants-content');
      templatesHeader = document.getElementById('templates-header');
      templatesContent = document.getElementById('templates-content');
      
      prevMonthBtn = document.getElementById('prev-month');
      nextMonthBtn = document.getElementById('next-month');
      calendarDaysContainer = document.getElementById('calendar-days');
      monthCalendarDaysContainer = document.getElementById('month-calendar-days');
      calendarMonth = document.getElementById('calendar-month');
      plannerPeriod = document.getElementById('planner-period');
      
      closeShoppingItem = document.getElementById('close-shopping-item');
      saveShoppingItem = document.getElementById('save-shopping-item');
      deleteShoppingItem = document.getElementById('delete-shopping-item');
      shoppingItemModal = document.getElementById('shopping-item-modal');
      
      quickAddForm = document.getElementById('quick-add-form');
    }
    
    // Set up event listeners safely
    function setupEventListeners() {
      // Auth modal
      loginBtn?.addEventListener('click', loginRoom);
      createRoomBtn?.addEventListener('click', createRoom);
      
      // Tab navigation
      tabButtons.forEach(button => {
        button?.addEventListener('click', () => {
          // Update active tab
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Show corresponding content
          const tabName = button.dataset.tab;
          tabContents.forEach(content => content.classList.remove('active'));
          document.getElementById(`${tabName}-tab`)?.classList.add('active');
        });
      });
      
      // Settings modal
      settingsBtn?.addEventListener('click', () => openModal(settingsModal));
      closeSettings?.addEventListener('click', () => closeModal(settingsModal));
      cancelSettings?.addEventListener('click', () => closeModal(settingsModal));
      saveSettings?.addEventListener('click', saveSettingsData);
      logoutBtn?.addEventListener('click', logoutRoom);
      
      // Transaction modal
      addFirstTransaction?.addEventListener('click', () => openModal(transactionModal));
      closeTransaction?.addEventListener('click', () => closeModal(transactionModal));
      cancelTransaction?.addEventListener('click', () => closeModal(transactionModal));
      saveTransaction?.addEventListener('click', saveTransactionData);
      
      // File upload
      fileUpload?.addEventListener('change', handleFileUpload);
      
      // Import modal
      closeImport?.addEventListener('click', () => closeModal(importModal));
      cancelImport?.addEventListener('click', () => closeModal(importModal));
      importTransactionsBtn?.addEventListener('click', importTransactions);
      
      // Shopping items
      document.getElementById('add-shopping-item-btn')?.addEventListener('click', addShoppingItem);
      document.getElementById('add-shopping-item-manual')?.addEventListener('click', () => openModal(shoppingItemModal));
      
      // Week cell click events
      weekCells.forEach(cell => {
        cell?.addEventListener('click', handleWeekCellClick);
      });
      
      // View buttons for planner
      document.getElementById('view-month-btn')?.addEventListener('click', () => switchPlannerView('month'));
      document.getElementById('view-week-btn')?.addEventListener('click', () => switchPlannerView('week'));
      
      // Event modal
      closeEvent?.addEventListener('click', () => closeModal(eventModal));
      cancelEvent?.addEventListener('click', () => closeModal(eventModal));
      saveEvent?.addEventListener('click', saveEvent);
      
      // Shopping item modal
      closeShoppingItem?.addEventListener('click', () => closeModal(shoppingItemModal));
      saveShoppingItem?.addEventListener('click', saveShoppingItem);
      deleteShoppingItem?.addEventListener('click', deleteShoppingItem);
      
      // Accordion functionality
      setupAccordion(mandatoryExpensesHeader, mandatoryExpensesContent);
      setupAccordion(participantsHeader, participantsContent);
      setupAccordion(templatesHeader, templatesContent);
      
      // Month navigation
      prevMonthBtn?.addEventListener('click', () => changeMonth(-1));
      nextMonthBtn?.addEventListener('click', () => changeMonth(1));
      
      // Telegram button
      sendToTelegram?.addEventListener('click', sendToTelegram);
      
      // Clear transactions
      document.getElementById('clear-transactions')?.addEventListener('click', clearTransactions);
      
      // Add mandatory expense
      document.getElementById('add-mandatory-expense')?.addEventListener('click', addMandatoryExpense);
      
      // Add participant
      document.getElementById('add-participant')?.addEventListener('click', addParticipant);
      
      // Add template
      document.getElementById('add-template')?.addEventListener('click', addTemplate);
    }
    
    // Safe DOM manipulation functions
    function openModal(modal) {
      if (!modal) return;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal(modal) {
      if (!modal) return;
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }
    
    function showNotification(message, type = 'info') {
      if (!notification) return;
      
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'bell'}"></i>
        <span>${message}</span>
      `;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Initialize UI
    function initializeUI() {
      // Set current date for transaction modal
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('transaction-date')?.value = `${year}-${month}-${day}`;
      
      // Set default dates for event modal
      const eventStart = new Date();
      const eventEnd = new Date(eventStart.getTime() + 60 * 60 * 1000); // +1 hour
      document.getElementById('event-start')?.value = formatDateForEventInput(eventStart);
      document.getElementById('event-end')?.value = formatDateForEventInput(eventEnd);
      
      // Initial calendar render
      renderBudgetCalendar();
      renderPlannerCalendar();
    }
    
    // Check saved room
    function checkSavedRoom() {
      if (canUseLocalStorage) {
        const savedRoomId = localStorage.getItem('currentRoomId');
        const savedRoomName = localStorage.getItem('currentRoomName');
        
        if (savedRoomId && savedRoomName) {
          currentRoomId = savedRoomId;
          currentRoomName = savedRoomName;
          currentRoomElement.textContent = savedRoomName;
          document.getElementById('current-room-settings').textContent = savedRoomName;
          authModal.classList.remove('active');
          
          // Load room data
          loadRoomData();
        }
      }
    }
    
    // Room authentication functions
    function loginRoom() {
      const roomName = roomNameInput.value.trim();
      const password = roomPasswordInput.value.trim();
      
      if (!roomName || !password) {
        showNotification('Пожалуйста, заполните все поля', 'error');
        return;
      }
      
      // Generate room ID
      currentRoomId = generateRoomId(roomName, password);
      currentRoomName = roomName;
      
      // Save to storage if available
      if (canUseLocalStorage) {
        localStorage.setItem('currentRoomId', currentRoomId);
        localStorage.setItem('currentRoomName', roomName);
      }
      
      currentRoomElement.textContent = roomName;
      document.getElementById('current-room-settings').textContent = roomName;
      authModal.classList.remove('active');
      
      // Initialize room data if needed
      if (!appData.rooms[currentRoomId]) {
        appData.rooms[currentRoomId] = {
          transactions: [],
          settings: {
            initialBalance: 0,
            savingsPercentage: '',
            telegramBotId: '',
            telegramChatId: ''
          },
          shoppingItems: [],
          events: [],
          participants: [],
          templates: [],
          mandatoryExpenses: []
        };
      }
      
      // Load room data
      loadRoomData();
      
      showNotification(`Успешный вход в комнату "${roomName}"`, 'success');
    }
    
    function createRoom() {
      const roomName = roomNameInput.value.trim();
      const password = roomPasswordInput.value.trim();
      
      if (!roomName || !password) {
        showNotification('Пожалуйста, заполните все поля', 'error');
        return;
      }
      
      // Generate room ID
      const roomId = generateRoomId(roomName, password);
      
      // Check if room already exists
      if (appData.rooms[roomId]) {
        showNotification('Комната с таким названием и паролем уже существует', 'error');
        return;
      }
      
      // Create new room
      currentRoomId = roomId;
      currentRoomName = roomName;
      
      // Save to storage if available
      if (canUseLocalStorage) {
        localStorage.setItem('currentRoomId', roomId);
        localStorage.setItem('currentRoomName', roomName);
      }
      
      currentRoomElement.textContent = roomName;
      document.getElementById('current-room-settings').textContent = roomName;
      authModal.classList.remove('active');
      
      // Initialize room data
      appData.rooms[currentRoomId] = {
        transactions: [],
        settings: {
          initialBalance: 0,
          savingsPercentage: '',
          telegramBotId: '',
          telegramChatId: ''
        },
        shoppingItems: [],
        events: [],
        participants: [],
        templates: [],
        mandatoryExpenses: []
      };
      
      loadRoomData();
      showNotification(`Комната "${roomName}" успешно создана!`, 'success');
    }
    
    function logoutRoom() {
      if (canUseLocalStorage) {
        localStorage.removeItem('currentRoomId');
        localStorage.removeItem('currentRoomName');
      }
      
      currentRoomId = null;
      currentRoomName = null;
      currentRoomElement.textContent = 'Комната не выбрана';
      document.getElementById('current-room-settings').textContent = 'Не выбрана';
      
      closeModal(settingsModal);
      authModal.classList.add('active');
      
      // Clear data
      transactions = [];
      categories = {};
      settings = {
        initialBalance: 0,
        savingsPercentage: '',
        telegramBotId: '',
        telegramChatId: ''
      };
      shoppingItemsList = [];
      events = [];
      participants = [];
      templates = [];
      mandatoryExpenses = [];
      
      // Reset UI
      updateSummary();
      updateTransactionsTable();
      updateCategoriesList();
      updateShoppingList();
      
      showNotification('Вы успешно вышли из комнаты', 'info');
    }
    
    // Generate room ID (works with any characters)
    function generateRoomId(roomName, password) {
      const combined = roomName + ':' + password;
      let hash = 0;
      for (let i = 0; i < combined.length; i++) {
        const char = combined.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash).toString(16);
    }
    
    // Load room data
    function loadRoomData() {
      if (!currentRoomId) return;
      
      // Get room data
      const roomData = appData.rooms[currentRoomId] || {
        transactions: [],
        settings: {
          initialBalance: 0,
          savingsPercentage: '',
          telegramBotId: '',
          telegramChatId: ''
        },
        shoppingItems: [],
        events: [],
        participants: [],
        templates: [],
        mandatoryExpenses: []
      };
      
      // Load data
      transactions = roomData.transactions || [];
      settings = roomData.settings || {
        initialBalance: 0,
        savingsPercentage: '',
        telegramBotId: '',
        telegramChatId: ''
      };
      shoppingItemsList = roomData.shoppingItems || [];
      events = roomData.events || [];
      participants = roomData.participants || [];
      templates = roomData.templates || [];
      mandatoryExpenses = roomData.mandatoryExpenses || [];
      
      // Update UI
      updateUI();
    }
    
    // Save room data
    function saveRoomData() {
      if (!currentRoomId) return;
      
      // Prepare room data
      const roomData = {
        transactions: transactions,
        settings: settings,
        shoppingItems: shoppingItemsList,
        events: events,
        participants: participants,
        templates: templates,
        mandatoryExpenses: mandatoryExpenses
      };
      
      // Save to app data
      appData.rooms[currentRoomId] = roomData;
      
      // Save to storage if available
      if (canUseLocalStorage) {
        try {
          localStorage.setItem('family-budget-data', JSON.stringify(appData));
        } catch (e) {
          console.error('Error saving to localStorage:', e);
        }
      }
    }
    
    // UI update functions
    function updateUI() {
      updateSummary();
      updateTransactionsTable();
      updateCategoriesList();
      updateShoppingList();
      updatePlanner();
    }
    
    function updateSummary() {
      const initialBalance = parseFloat(settings.initialBalance) || 0;
      const savingsPercent = parseFloat(settings.savingsPercentage) || 0;
      
      // Calculate current balance
      const income = transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      
      const expenses = transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      
      const currentBalance = initialBalance + income - expenses;
      const savings = currentBalance * (savingsPercent / 100);
      
      // Calculate mandatory expenses
      const mandatoryTotal = mandatoryExpenses
        .reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
      
      // Calculate daily spending budget
      const today = new Date();
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      const daysLeft = Math.max(0, lastDay.getDate() - today.getDate() + 1);
      const dailyBudget = daysLeft > 0 ? (currentBalance - mandatoryTotal) / daysLeft : 0;
      
      // Update UI
      document.getElementById('current-balance').textContent = `${currentBalance.toLocaleString('ru-RU')} ₽`;
      document.getElementById('savings').textContent = `${savings.toLocaleString('ru-RU')} ₽`;
      document.getElementById('daily-spend').textContent = `${Math.round(dailyBudget).toLocaleString('ru-RU')} ₽`;
      document.getElementById('mandatory-expenses').textContent = `${mandatoryTotal.toLocaleString('ru-RU')} ₽`;
    }
    
    // Format date helpers
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }
    
    function formatDateForEventInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // Calendar functions
    function renderBudgetCalendar() {
      if (!calendarDaysContainer) return;
      
      calendarDaysContainer.innerHTML = '';
      
      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
      
      // Get day of week for first day (0 = Sunday, 6 = Saturday)
      let dayOfWeek = firstDay.getDay();
      if (dayOfWeek === 0) dayOfWeek = 7; // Convert Sunday to 7 for Monday=1, Sunday=7 format
      
      // Add days from previous month to fill the first week
      for (let i = dayOfWeek - 1; i > 0; i--) {
        const date = new Date(firstDay);
        date.setDate(-i + 1);
        renderCalendarDay(calendarDaysContainer, date, currentMonth, true);
      }
      
      // Current month days
      for (let i = 1; i <= lastDay.getDate(); i++) {
        const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i);
        renderCalendarDay(calendarDaysContainer, date, currentMonth, true);
      }
      
      // Next month days to fill the grid
      const totalDays = calendarDaysContainer.children.length;
      const remainingDays = 42 - totalDays;
      
      for (let i = 1; i <= remainingDays; i++) {
        const date = new Date(lastDay);
        date.setDate(i);
        renderCalendarDay(calendarDaysContainer, date, currentMonth, true);
      }
      
      // Update month title
      calendarMonth.textContent = currentMonth.toLocaleString('ru-RU', { month: 'long', year: 'numeric' });
    }
    
    // Get proper unit text based on quantity
    function getUnitText(quantity, unit) {
      const num = parseInt(quantity);
      
      if (unit === 'шт') {
        if (num % 10 === 1 && num % 100 !== 11) return 'штука';
        if ([2,3,4].includes(num % 10) && ![12,13,14].includes(num % 100)) return 'штуки';
        return 'штук';
      }
      
      return unit;
    }
    
    // Render calendar day
    function renderCalendarDay(container, date, monthDate, isBudgetCalendar = true) {
      const dayElement = document.createElement('div');
      const isCurrentMonthDay = date.getMonth() === monthDate.getMonth() && date.getFullYear() === monthDate.getFullYear();
      const isToday = date.toDateString() === today.toDateString();
      
      // Get transactions and events for this date
      const dateString = formatDateKey(date);
      const dayTransactions = transactions.filter(t => t.date === dateString);
      const dayEvents = events.filter(e => {
        const eventDate = new Date(e.start);
        return formatDate(eventDate.toISOString()) === dateString;
      });
      
      const hasTransactions = dayTransactions.length > 0;
      const hasEvents = dayEvents.length > 0;
      
      // Set classes
      dayElement.className = 'calendar-day';
      if (isCurrentMonthDay) {
        dayElement.classList.add('current-month');
      } else {
        dayElement.classList.add('other-month');
      }
      
      if (isToday) {
        dayElement.classList.add('today');
      }
      
      if (hasTransactions && isBudgetCalendar) {
        dayElement.classList.add('has-transactions');
      }
      
      // Add day number
      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      if (!isCurrentMonthDay) {
        dayNumber.classList.add('other-month');
      }
      dayNumber.textContent = date.getDate();
      
      dayElement.appendChild(dayNumber);
      
      // Add click event for budget calendar
      if (isBudgetCalendar) {
        dayElement.addEventListener('click', () => {
          // You can add functionality to show transactions for this date
        });
      } else {
        // For planner calendar
        dayElement.addEventListener('click', () => {
          if (currentRoomId) {
            const startDate = new Date(date);
            startDate.setHours(9, 0, 0, 0); // Default to 9 AM
            
            const endDate = new Date(date);
            endDate.setHours(10, 0, 0, 0); // Default to 10 AM
            
            document.getElementById('event-start').value = formatDateForEventInput(startDate);
            document.getElementById('event-end').value = formatDateForEventInput(endDate);
            openModal(eventModal);
          } else {
            showNotification('Пожалуйста, войдите в комнату', 'error');
          }
        });
      }
      
      container.appendChild(dayElement);
    }
    
    // Format date key
    function formatDateKey(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }
    
    // Render planner calendar
    function renderPlannerCalendar() {
      if (plannerView === 'month') {
        if (!monthCalendarDaysContainer) return;
        
        monthCalendarDaysContainer.innerHTML = '';
        
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
        
        // Get day of week for first day (0 = Sunday, 6 = Saturday)
        let dayOfWeek = firstDay.getDay();
        if (dayOfWeek === 0) dayOfWeek = 7; // Convert Sunday to 7 for Monday=1, Sunday=7 format
        
        // Add days from previous month to fill the first week
        for (let i = dayOfWeek - 1; i > 0; i--) {
          const date = new Date(firstDay);
          date.setDate(-i + 1);
          renderCalendarDay(monthCalendarDaysContainer, date, currentMonth, false);
        }
        
        // Current month days
        for (let i = 1; i <= lastDay.getDate(); i++) {
          const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i);
          renderCalendarDay(monthCalendarDaysContainer, date, currentMonth, false);
        }
        
        // Next month days to fill the grid
        const totalDays = monthCalendarDaysContainer.children.length;
        const remainingDays = 42 - totalDays;
        
        for (let i = 1; i <= remainingDays; i++) {
          const date = new Date(lastDay);
          date.setDate(i);
          renderCalendarDay(monthCalendarDaysContainer, date, currentMonth, false);
        }
      }
      
      // Update period title
      plannerPeriod.textContent = currentMonth.toLocaleString('ru-RU', { month: 'long', year: 'numeric' });
    }
    
    // Month navigation
    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderBudgetCalendar();
      renderPlannerCalendar();
    }
    
    // Planner view switching
    function switchPlannerView(view) {
      plannerView = view;
      
      // Update buttons
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.view-btn[data-view="${view}"]`)?.classList.add('active');
      
      // Show/hide views
      if (view === 'month') {
        monthView.style.display = 'block';
        weekView.style.display = 'none';
      } else {
        monthView.style.display = 'none';
        weekView.style.display = 'block';
      }
      
      renderPlannerCalendar();
    }
    
    // Shopping functions
    function addShoppingItem(e) {
      e.preventDefault();
      
      const itemName = document.getElementById('item-name').value.trim();
      const itemQuantity = document.getElementById('item-quantity').value.trim();
      const itemUnit = document.getElementById('item-unit').value;
      
      if (!itemName || !itemQuantity) {
        showNotification('Пожалуйста, заполните все поля', 'error');
        return;
      }
      
      const newItem = {
        id: Date.now().toString(),
        name: itemName,
        quantity: itemQuantity,
        unit: itemUnit,
        purchased: false,
        timestamp: new Date().toISOString()
      };
      
      shoppingItemsList.push(newItem);
      saveRoomData();
      updateShoppingList();
      
      // Reset form
      document.getElementById('item-name').value = '';
      document.getElementById('item-quantity').value = '1';
      document.getElementById('item-unit').value = 'шт';
      
      showNotification('Товар успешно добавлен в список', 'success');
    }
    
    function updateShoppingList() {
      const shoppingList = document.getElementById('shopping-list');
      if (!shoppingList) return;
      
      if (shoppingItemsList.length === 0) {
        shoppingList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-shopping-basket"></i>
            </div>
            <div class="empty-title">Список покупок пуст</div>
            <div class="empty-description">Добавьте товары, чтобы начать планирование покупок</div>
            <button class="empty-action" id="add-shopping-item-manual">
              <i class="fas fa-plus"></i> Добавить товар
            </button>
          </div>
        `;
        return;
      }
      
      shoppingList.innerHTML = shoppingItemsList.map(item => `
        <div class="shopping-item">
          <div class="shopping-info">
            <input type="checkbox" class="shopping-checkbox" ${item.purchased ? 'checked' : ''}>
            <div>
              <div class="shopping-name">${item.name}</div>
              <div class="shopping-details">${item.quantity} ${getUnitText(item.quantity, item.unit)}</div>
            </div>
          </div>
          <div class="shopping-actions">
            <button class="edit-item" data-id="${item.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-item" data-id="${item.id}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
      
      // Add event listeners
      document.querySelectorAll('.edit-item').forEach(button => {
        button.addEventListener('click', (e) => {
          const id = e.target.closest('button').dataset.id;
          const item = shoppingItemsList.find(i => i.id === id);
          
          if (item) {
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-quantity').value = item.quantity;
            document.getElementById('edit-item-unit').value = item.unit;
            document.getElementById('item-purchased').checked = item.purchased;
            
            // Store ID for saving
            document.getElementById('save-shopping-item').dataset.id = id;
            
            openModal(shoppingItemModal);
          }
        });
      });
      
      document.querySelectorAll('.delete-item').forEach(button => {
        button.addEventListener('click', (e) => {
          const id = e.target.closest('button').dataset.id;
          if (confirm('Удалить этот товар из списка?')) {
            shoppingItemsList = shoppingItemsList.filter(i => i.id !== id);
            saveRoomData();
            updateShoppingList();
            showNotification('Товар успешно удален', 'success');
          }
        });
      });
      
      document.querySelectorAll('.shopping-checkbox').forEach((checkbox, index) => {
        checkbox.addEventListener('change', () => {
          shoppingItemsList[index].purchased = checkbox.checked;
          saveRoomData();
        });
      });
    }
    
    // Other functions remain similar but with safety checks
    
    console.log('Application initialized successfully');
  </script>
</body>
</html>

