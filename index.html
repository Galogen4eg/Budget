import React, { useState, useRef, useEffect } from 'react';
import {
  Settings, Wallet, ShoppingBag, Calendar as CalendarIcon, Trophy, FileText,
  TrendingUp, TrendingDown, Plus, Edit3, Trash2, Eye as EyeIcon, Bell,
  MessageSquare, Database, Download, Upload, X, List, Clock
} from 'lucide-react';

const App = () => {
  const [activeTab, setActiveTab] = useState('overview');
  const [settingsOpen, setSettingsOpen] = useState(false);
  const modalRef = useRef(null);

  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
  const [settings, setSettings] = useState({
    roomName: '–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç',
    monthlyIncome: 0,
    initialBalance: 0,
    savingsPercent: 10,
    visibility: {
      overview: true,
      budget: true,
      shopping: true,
      planning: true, // ‚Üê rename calendar ‚Üí planning
      goals: true,
      bills: true,
    },
    notifications: {
      push: true,
      email: true,
      telegram: true,
      budgets: true,
      goals: true,
      bills: true,
      shopping: true,
    },
    telegram: {
      botToken: '',
      chatId: '',
      enabled: false,
    }
  });

  // === –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ ===
  const [transactions] = useState([
    { id: 1, title: '–ó–∞—Ä–ø–ª–∞—Ç–∞', date: '5 –∏—é–Ω—è', amount: 50000, type: 'income' },
    { id: 2, title: '–ü—Ä–æ–¥—É–∫—Ç—ã', date: '15 –∏—é–Ω—è', amount: -1200, type: 'expense' },
    { id: 3, title: '–§—Ä–∏–ª–∞–Ω—Å', date: '20 –∏—é–Ω—è', amount: 35000, type: 'income' },
  ]);

  const [budgetData] = useState([
    { id: 1, category: '–ü—Ä–æ–¥—É–∫—Ç—ã', planned: 15000, spent: 12400 },
    { id: 2, category: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', planned: 5000, spent: 4800 },
    { id: 3, category: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', planned: 3000, spent: 1200 },
    { id: 4, category: '–û–¥–µ–∂–¥–∞', planned: 4000, spent: 0 },
    { id: 5, category: '–ü–æ–¥–∞—Ä–∫–∏', planned: 2000, spent: 0 },
  ]);

  const [shoppingList, setShoppingList] = useState([
    { id: 1, name: '–ú–æ–ª–æ–∫–æ', checked: false },
    { id: 2, name: '–•–ª–µ–±', checked: true },
    { id: 3, name: '–Ø–π—Ü–∞', checked: false },
    { id: 4, name: '–°—ã—Ä', checked: false },
  ]);

  const [goals] = useState([
    { name: '–û—Ç–ø—É—Å–∫', target: 100000, saved: 45000 },
    { name: '–ù–æ—É—Ç–±—É–∫', target: 80000, saved: 32000 },
  ]);

  const [bills] = useState([
    { name: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', amount: 800, due: '15.06', status: 'paid' },
    { name: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', amount: 1200, due: '25.06', status: 'pending' },
    { name: '–í–æ–¥–∞', amount: 650, due: '28.06', status: 'pending' },
  ]);

  // === –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ===
  const now = new Date(2025, 5, 15); // —Ñ–∏–∫—Å: –∏—é–Ω—å 2025
  const year = now.getFullYear();
  const month = now.getMonth();

  const getEventsForDay = (day) => {
    if (day === 5) return [{ id: 1, title: '–ó–∞—Ä–ø–ª–∞—Ç–∞', amount: 50000, type: 'income' }];
    if (day === 15) return [{ id: 2, title: '–ü—Ä–æ–¥—É–∫—Ç—ã', amount: -1200, type: 'expense' }];
    if (day === 20) return [{ id: 3, title: '–§—Ä–∏–ª–∞–Ω—Å', amount: 35000, type: 'income' }];
    return [];
  };

  // === –ö–∞–ª–µ–Ω–¥–∞—Ä—å (–¥–ª—è –ë—é–¥–∂–µ—Ç–∞ –∏ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –ú–µ—Å—è—Ü) ===
  const generateCalendarDays = (y, m) => {
    const firstDay = new Date(y, m, 1).getDay();
    const startOffset = firstDay === 0 ? 6 : firstDay - 1;
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const prevMonthDays = new Date(y, m, 0).getDate();

    const days = [];
    // Prev month
    for (let i = startOffset; i > 0; i--) {
      days.push({ day: prevMonthDays - i + 1, current: false, events: [] });
    }
    // Current month
    for (let d = 1; d <= daysInMonth; d++) {
      days.push({ day: d, current: true, events: getEventsForDay(d), date: new Date(y, m, d) });
    }
    // Next month
    while (days.length < 42) {
      days.push({ day: days.length - daysInMonth - startOffset + 1, current: false, events: [] });
    }
    return days;
  };

  const calendarDays = generateCalendarDays(year, month);
  const monthName = new Date(year, month).toLocaleString('ru', { month: 'long', year: 'numeric' });

  // === –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ) ===
  const [planningView, setPlanningView] = useState('month'); // 'month' | 'week' | 'day'
  const [selectedDate, setSelectedDate] = useState(now);
  const [dailyNotes, setDailyNotes] = useState({
    [now.toDateString()]: [
      { id: 1, text: '–ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã', done: false },
      { id: 2, text: '–û–ø–ª–∞—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç', done: true },
    ]
  });
  const [newNote, setNewNote] = useState('');

  const addNote = () => {
    if (!newNote.trim()) return;
    const dateStr = selectedDate.toDateString();
    const notes = dailyNotes[dateStr] || [];
    setDailyNotes({
      ...dailyNotes,
      [dateStr]: [...notes, { id: Date.now(), text: newNote.trim(), done: false }]
    });
    setNewNote('');
  };

  const toggleNote = (id) => {
    const dateStr = selectedDate.toDateString();
    const notes = dailyNotes[dateStr] || [];
    setDailyNotes({
      ...dailyNotes,
      [dateStr]: notes.map(n => n.id === id ? { ...n, done: !n.done } : n)
    });
  };

  // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===
  const toggleSetting = (path, key) => {
    const keys = path.split('.');
    if (keys.length === 1) {
      setSettings(prev => ({ ...prev, [key]: !prev[key] }));
    } else {
      setSettings(prev => ({
        ...prev,
        [keys[0]]: { ...prev[keys[0]], [key]: !prev[keys[0]][key] }
      }));
    }
  };

  const toggleShoppingItem = (id) => {
    setShoppingList(prev => prev.map(item =>
      item.id === id ? { ...item, checked: !item.checked } : item
    ));
  };

  const deleteShoppingItem = (id) => {
    setShoppingList(prev => prev.filter(item => item.id !== id));
  };

  const addShoppingItem = () => {
    const name = prompt('–¢–æ–≤–∞—Ä:');
    if (name?.trim()) {
      setShoppingList(prev => [...prev, { id: Date.now(), name: name.trim(), checked: false }]);
    }
  };

  const exportData = () => {
    const data = JSON.stringify({ settings, shoppingList, dailyNotes }, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'family-budget-export.json';
    a.click();
    URL.revokeObjectURL(url);
  };

  const importData = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const json = JSON.parse(reader.result);
        setSettings(json.settings || settings);
        if (json.shoppingList) setShoppingList(json.shoppingList);
        if (json.dailyNotes) setDailyNotes(json.dailyNotes);
        alert('‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      } catch {
        alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ JSON');
      }
    };
    reader.readAsText(file);
  };

  useEffect(() => {
    if (settingsOpen && modalRef.current) {
      modalRef.current.focus();
    }
  }, [settingsOpen]);

  return (
    <div className="min-h-screen bg-[#f7f5f3] text-[#171717] dark:bg-[#2e2e4b] dark:text-[#ededed] font-sans">
      {/* Header */}
      <header className="sticky top-0 z-50 bg-[#f7f5f3] dark:bg-[#2a2a38] border-b border-[#e2e8f0] dark:border-[#334155] shadow-sm">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                <Wallet className="h-6 w-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold">{settings.roomName}</h1>
                <p className="text-sm text-[#64748b] dark:text-[#96a3b7]">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 0&nbsp;‚ÇΩ</p>
              </div>
            </div>
            <button
              onClick={() => setSettingsOpen(true)}
              className="p-2 rounded-lg hover:bg-[#dee2e7] dark:hover:bg-[#45455b7c] transition-colors"
              aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
            >
              <Settings className="h-4 w-4 text-[#64748b] dark:text-[#96a3b7]" />
            </button>
          </div>

          <nav className="w-full">
            <div className="h-9 flex flex-wrap items-center justify-center gap-1 bg-[#f1f5f9] dark:bg-[#2a2a38] p-1 rounded-xl">
              {[
                { id: 'overview', label: '–û–±–∑–æ—Ä', icon: <TrendingUp className="h-4 w-4" /> },
                { id: 'budget', label: '–ë—é–¥–∂–µ—Ç', icon: <Wallet className="h-4 w-4" /> },
                { id: 'shopping', label: '–ü–æ–∫—É–ø–∫–∏', icon: <ShoppingBag className="h-4 w-4" /> },
                { id: 'planning', label: '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', icon: <CalendarIcon className="h-4 w-4" /> }, // ‚Üê renamed
                { id: 'goals', label: '–¶–µ–ª–∏', icon: <Trophy className="h-4 w-4" /> },
                { id: 'bills', label: '–°—á–µ—Ç–∞', icon: <FileText className="h-4 w-4" /> },
              ]
                .filter(tab => settings.visibility[tab.id])
                .map(tab => (
                  <button
                    key={tab.id}
                    role="tab"
                    aria-selected={activeTab === tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all
                      ${activeTab === tab.id
                        ? 'text-foreground bg-[#ffffff] dark:bg-[#323046] shadow-sm'
                        : 'text-[#64748b] dark:text-[#96a3b7] hover:bg-[#f1f5f9] dark:hover:bg-[#2a2a38]'
                      }`}
                  >
                    {tab.icon}
                    {tab.label}
                  </button>
                ))}
            </div>
          </nav>
        </div>
      </header>

      <main className="container mx-auto px-4 py-6">
        {/* Overview */}
        {activeTab === 'overview' && (
          <>
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6">
              {[
                { title: '–ë–∞–ª–∞–Ω—Å', value: '0¬†‚ÇΩ', icon: Wallet, color: 'bg-blue-500/20 text-blue-500 dark:text-blue-400' },
                { title: '–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü', value: '85 000¬†‚ÇΩ', icon: TrendingUp, color: 'bg-green-500/20 text-green-500 dark:text-green-400' },
                { title: '–†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü', value: '1 200¬†‚ÇΩ', icon: TrendingDown, color: 'bg-red-500/20 text-red-500 dark:text-red-400' },
                { title: '–î–Ω–µ–≤–Ω–æ–π –±—é–¥–∂–µ—Ç', value: '2 800¬†‚ÇΩ', icon: CalendarIcon, color: 'bg-purple-500/20 text-purple-500 dark:text-purple-400' },
              ].map((card, i) => (
                <div
                  key={i}
                  className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046] backdrop-blur-sm"
                >
                  <div className="p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-[#64748b] dark:text-[#96a3b7]">{card.title}</p>
                        <p className="text-2xl font-bold">{card.value}</p>
                      </div>
                      <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${card.color}`}>
                        <card.icon className="h-6 w-6" />
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
              <div className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-semibold">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                  <button className="text-sm font-medium text-[#8366f1] hover:text-[#6b55c9] flex items-center gap-1">
                    –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                  </button>
                </div>
                <div className="space-y-4">
                  {transactions.map(tx => (
                    <div key={tx.id} className="flex justify-between items-center p-3 rounded-lg hover:bg-[#f1f5f9] dark:hover:bg-[#2a2a38]">
                      <div>
                        <p className="font-medium">{tx.title}</p>
                        <p className="text-sm text-[#64748b] dark:text-[#96a3b7]">{tx.date}</p>
                      </div>
                      <span className={`font-medium ${tx.type === 'income' ? 'text-green-500' : 'text-red-500'}`}>
                        {tx.amount > 0 ? '+' : ''}{tx.amount.toLocaleString()} ‚ÇΩ
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </>
        )}

        {/* Budget ‚Äî with mini-calendar */}
        {activeTab === 'budget' && (
          <div className="space-y-6">
            <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
              <div className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-semibold text-lg">–ë—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü</h3>
                  <button className="text-sm font-medium text-[#8366f1] hover:text-[#6b55c9] flex items-center gap-1">
                    <Plus className="h-4 w-4" /> –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                  </button>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="text-left text-sm text-[#64748b] dark:text-[#96a3b7] border-b border-[#e2e8f0] dark:border-[#334155]">
                        <th className="pb-3">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th className="pb-3 text-right">–ü–ª–∞–Ω</th>
                        <th className="pb-3 text-right">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                        <th className="pb-3 text-right">–û—Å—Ç–∞–ª–æ—Å—å</th>
                      </tr>
                    </thead>
                    <tbody>
                      {budgetData.map(item => (
                        <tr key={item.id} className="border-b border-[#e2e8f0] dark:border-[#334155] last:border-0">
                          <td className="py-3 font-medium">{item.category}</td>
                          <td className="py-3 text-right">{item.planned.toLocaleString()} ‚ÇΩ</td>
                          <td className="py-3 text-right text-red-500">{item.spent.toLocaleString()} ‚ÇΩ</td>
                          <td className={`py-3 text-right font-medium ${item.planned > item.spent ? 'text-green-500' : 'text-red-500'}`}>
                            {(item.planned - item.spent).toLocaleString()} ‚ÇΩ
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            {/* Mini-calendar in Budget */}
            <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
              <div className="p-6">
                <h3 className="font-semibold mb-4">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞ –º–µ—Å—è—Ü</h3>
                <div className="text-sm text-[#64748b] dark:text-[#96a3b7] mb-2">{monthName}</div>
                <div className="grid grid-cols-7 gap-1 mb-2">
                  {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => (
                    <div key={day} className="text-center text-xs font-medium py-1">{day}</div>
                  ))}
                </div>
                <div className="grid grid-cols-7 gap-1">
                  {calendarDays.slice(0, 35).map((cell, i) => (
                    <div
                      key={i}
                      className={`min-h-10 text-xs p-1 rounded flex flex-col items-center
                        ${!cell.current ? 'text-[#cbd5e1] opacity-70' : ''}
                        ${cell.events.length > 0 ? 'bg-[#8366f1]/10 border-[#8366f1]/30' : ''}
                      `}
                    >
                      <span className={cell.current ? 'font-medium' : ''}>{cell.day}</span>
                      {cell.events.map((ev, j) => (
                        <span key={j} className={`text-[10px] px-1 py-0.5 rounded ${ev.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>
                          {ev.amount > 0 ? '+' : ''}{ev.amount}
                        </span>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Shopping */}
        {activeTab === 'shopping' && (
          <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-lg">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h3>
                <button onClick={addShoppingItem} className="text-sm font-medium text-[#8366f1] hover:text-[#6b55c9] flex items-center gap-1">
                  <Plus className="h-4 w-4" /> –î–æ–±–∞–≤–∏—Ç—å
                </button>
              </div>
              <div className="space-y-2">
                {shoppingList.map(item => (
                  <div key={item.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-[#f1f5f9] dark:hover:bg-[#2a2a38]">
                    <input
                      type="checkbox"
                      checked={item.checked}
                      onChange={() => toggleShoppingItem(item.id)}
                      className="w-4 h-4 rounded text-[#8366f1]"
                    />
                    <span className={item.checked ? 'line-through text-[#64748b]' : ''}>{item.name}</span>
                    <div className="ml-auto flex gap-1">
                      <button className="text-[#64748b] hover:text-[#8366f1]"><Edit3 className="h-4 w-4" /></button>
                      <button onClick={() => deleteShoppingItem(item.id)} className="text-[#64748b] hover:text-red-500"><Trash2 className="h-4 w-4" /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï (—Ä–∞–Ω–µ–µ –ö–∞–ª–µ–Ω–¥–∞—Ä—å) */}
        {activeTab === 'planning' && (
          <div className="space-y-4">
            {/* View switcher */}
            <div className="flex gap-1 bg-[#f1f5f9] dark:bg-[#2a2a38] p-1 rounded-xl w-fit">
              {[
                { id: 'month', label: '–ú–µ—Å—è—Ü', icon: <CalendarIcon className="h-4 w-4" /> },
                { id: 'week', label: '–ù–µ–¥–µ–ª—è', icon: <List className="h-4 w-4" /> },
                { id: 'day', label: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫', icon: <Clock className="h-4 w-4" /> },
              ].map(view => (
                <button
                  key={view.id}
                  onClick={() => setPlanningView(view.id)}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium
                    ${planningView === view.id
                      ? 'bg-[#ffffff] dark:bg-[#323046] shadow-sm'
                      : 'text-[#64748b] dark:text-[#96a3b7]'
                    }`}
                >
                  {view.icon}
                  {view.label}
                </button>
              ))}
            </div>

            {/* –ú–µ—Å—è—Ü */}
            {planningView === 'month' && (
              <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
                <div className="p-6">
                  <h3 className="font-semibold mb-4">{monthName}</h3>
                  <div className="grid grid-cols-7 gap-1 mb-2">
                    {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => (
                      <div key={day} className="text-center text-xs font-medium py-1 text-[#64748b] dark:text-[#96a3b7]">{day}</div>
                    ))}
                  </div>
                  <div className="grid grid-cols-7 gap-1">
                    {calendarDays.map((cell, i) => (
                      <div
                        key={i}
                        className={`min-h-14 border rounded-lg p-1 text-xs flex flex-col items-center
                          ${!cell.current ? 'text-[#cbd5e1] opacity-70' : ''}
                          ${cell.events.length > 0 ? 'border-[#8366f1]/30 bg-[#8366f1]/5 dark:bg-[#8366f1]/10' : 'border-transparent'}
                        `}
                      >
                        <span className={`font-medium mb-1 ${cell.current ? 'text-foreground' : ''}`}>{cell.day}</span>
                        <div className="space-y-0.5 w-full">
                          {cell.events.map((ev, j) => (
                            <span
                              key={j}
                              className={`text-[10px] px-1.5 py-0.5 rounded-full w-full block text-center truncate
                                ${ev.type === 'income' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'}
                              `}
                            >
                              {ev.amount > 0 ? '+' : ''}{ev.amount.toLocaleString()} ‚ÇΩ
                            </span>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* –ù–µ–¥–µ–ª—è */}
            {planningView === 'week' && (
              <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046] overflow-hidden">
                <div className="p-6">
                  <h3 className="font-semibold mb-4">–ù–µ–¥–µ–ª—è: 9‚Äì15 –∏—é–Ω—è 2025</h3>
                  <div className="grid grid-cols-[80px_1fr] gap-4">
                    <div>
                      {Array.from({ length: 25 }, (_, i) => (
                        <div key={i} className="py-2 text-right text-sm text-[#64748b]">
                          {i}:00
                        </div>
                      ))}
                    </div>
                    <div className="grid grid-cols-7 gap-2">
                      {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => (
                        <div key={day} className="text-center font-medium mb-2">{day}</div>
                      ))}
                      {Array.from({ length: 7 * 24 }).map((_, i) => (
                        <div key={i} className="min-h-6 border border-dashed border-[#e2e8f0] dark:border-[#334155]"></div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ */}
            {planningView === 'day' && (
              <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
                <div className="p-6">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-semibold">
                      –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫: {selectedDate.toLocaleDateString('ru', { weekday: 'long', day: 'numeric', month: 'long' })}
                    </h3>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setSelectedDate(d => new Date(d.getFullYear(), d.getMonth(), d.getDate() - 1))}
                        className="px-3 py-1 rounded bg-[#f1f5f9] dark:bg-[#2a2a38]"
                      >
                        ‚Üê
                      </button>
                      <button
                        onClick={() => setSelectedDate(new Date())}
                        className="px-3 py-1 rounded bg-[#8366f1] text-white"
                      >
                        –°–µ–≥–æ–¥–Ω—è
                      </button>
                      <button
                        onClick={() => setSelectedDate(d => new Date(d.getFullYear(), d.getMonth(), d.getDate() + 1))}
                        className="px-3 py-1 rounded bg-[#f1f5f9] dark:bg-[#2a2a38]"
                      >
                        ‚Üí
                      </button>
                    </div>
                  </div>

                  <div className="mb-4">
                    <div className="flex gap-2 mb-2">
                      <input
                        type="text"
                        value={newNote}
                        onChange={(e) => setNewNote(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && addNote()}
                        placeholder="–ù–æ–≤–æ–µ –¥–µ–ª–æ..."
                        className="flex-1 px-3 py-2 border border-[#e2e8f0] dark:border-[#334155] rounded-lg bg-transparent"
                      />
                      <button
                        onClick={addNote}
                        className="p-2 bg-[#8366f1] text-white rounded-lg hover:bg-[#8366f1]/90"
                      >
                        <Plus className="h-4 w-4" />
                      </button>
                    </div>
                  </div>

                  <div className="space-y-2">
                    {(dailyNotes[selectedDate.toDateString()] || []).map(note => (
                      <div key={note.id} className="flex items-start gap-3 p-3 rounded-lg bg-[#f8fafc] dark:bg-[#2a2a38]">
                        <input
                          type="checkbox"
                          checked={note.done}
                          onChange={() => toggleNote(note.id)}
                          className="mt-1 w-4 h-4 rounded text-[#8366f1]"
                        />
                        <span className={note.done ? 'line-through text-[#64748b]' : ''}>{note.text}</span>
                      </div>
                    ))}
                    {(dailyNotes[selectedDate.toDateString()] || []).length === 0 && (
                      <p className="text-[#64748b] dark:text-[#96a3b7] text-center py-4">–ù–µ—Ç –¥–µ–ª –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Goals */}
        {activeTab === 'goals' && (
          <div className="space-y-4">
            {goals.map((goal, i) => (
              <div key={i} className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
                <div className="p-6">
                  <div className="flex justify-between mb-2">
                    <h4 className="font-medium">{goal.name}</h4>
                    <span className="text-sm text-[#64748b] dark:text-[#96a3b7]">
                      {Math.round((goal.saved / goal.target) * 100)}%
                    </span>
                  </div>
                  <div className="w-full bg-[#e2e8f0] dark:bg-[#334155] rounded-full h-2 mb-2">
                    <div
                      className="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full"
                      style={{ width: `${Math.min(100, (goal.saved / goal.target) * 100)}%` }}
                    ></div>
                  </div>
                  <div className="text-sm text-[#64748b] dark:text-[#96a3b7]">
                    –°–æ–±—Ä–∞–Ω–æ: <span className="text-foreground font-medium">{goal.saved.toLocaleString()} ‚ÇΩ</span> –∏–∑ {goal.target.toLocaleString()} ‚ÇΩ
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Bills */}
        {activeTab === 'bills' && (
          <div className="rounded-xl shadow border border-[#e2e8f0] dark:border-[#334155] bg-[#ffffff] dark:bg-[#323046]">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-lg">–°—á–µ—Ç–∞ –∏ –ø–ª–∞—Ç–µ–∂–∏</h3>
                <button className="text-sm font-medium text-[#8366f1] hover:text-[#6b55c9] flex items-center gap-1">
                  <Plus className="h-4 w-4" /> –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç
                </button>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-left text-sm text-[#64748b] dark:text-[#96a3b7] border-b border-[#e2e8f0] dark:border-[#334155]">
                      <th className="pb-3">–°—á—ë—Ç</th>
                      <th className="pb-3 text-right">–°—É–º–º–∞</th>
                      <th className="pb-3">–°—Ä–æ–∫</th>
                      <th className="pb-3">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                  </thead>
                  <tbody>
                    {bills.map((bill, i) => (
                      <tr key={i} className="border-b border-[#e2e8f0] dark:border-[#334155] last:border-0">
                        <td className="py-3 font-medium">{bill.name}</td>
                        <td className="py-3 text-right font-medium">{bill.amount} ‚ÇΩ</td>
                        <td className="py-3">{bill.due}</td>
                        <td className="py-3">
                          <span className={`px-2 py-0.5 rounded-full text-xs font-medium
                            ${bill.status === 'paid' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                              bill.status === 'pending' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300' :
                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'}
                          `}>
                            {bill.status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : bill.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}
      </main>

      {/* Settings Modal */}
      {settingsOpen && (
        <div
          ref={modalRef}
          tabIndex={-1}
          className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[9999]"
          onClick={(e) => e.target === e.currentTarget && setSettingsOpen(false)}
        >
          <div
            className="w-full max-w-4xl max-h-[90vh] bg-[#ffffff] dark:bg-[#323046] rounded-2xl shadow-2xl border border-[#e2e8f0] dark:border-[#334155] flex flex-col overflow-hidden"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between p-6 border-b border-[#e2e8f0] dark:border-[#334155]">
              <h2 className="font-semibold tracking-tight text-xl">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
              <button
                onClick={() => setSettingsOpen(false)}
                className="w-8 h-8 rounded-lg hover:bg-[#8366f1]/10"
              >
                <X className="h-4 w-4" />
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-6 pt-0" style={{ maxHeight: 'calc(90vh - 120px)' }}>
              <div className="space-y-8">
                {/* General */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold flex items-center gap-2">
                    <Settings className="h-5 w-5" /> –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                  </h3>
                  <div className="grid gap-4 md:grid-cols-2">
                    <div>
                      <label className="text-sm font-medium block mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</label>
                      <input
                        className="h-9 w-full border border-[#e2e8f0] dark:border-[#334155] bg-transparent px-3 py-1 text-sm rounded-xl focus:outline-none focus:ring-1 focus:ring-[#8366f1]"
                        value={settings.roomName}
                        onChange={(e) => setSettings({ ...settings, roomName: e.target.value })}
                      />
                    </div>
                    <div>
                      <label className="text-sm font-medium block mb-1">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥</label>
                      <input
                        type="number"
                        className="h-9 w-full border border-[#e2e8f0] dark:border-[#334155] bg-transparent px-3 py-1 text-sm rounded-xl focus:outline-none focus:ring-1 focus:ring-[#8366f1]"
                        value={settings.monthlyIncome || ''}
                        onChange={(e) => setSettings({ ...settings, monthlyIncome: Number(e.target.value) || 0 })}
                      />
                    </div>
                    <div>
                      <label className="text-sm font-medium block mb-1">–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</label>
                      <input
                        type="number"
                        className="h-9 w-full border border-[#e2e8f0] dark:border-[#334155] bg-transparent px-3 py-1 text-sm rounded-xl focus:outline-none focus:ring-1 focus:ring-[#8366f1]"
                        value={settings.initialBalance || ''}
                        onChange={(e) => setSettings({ ...settings, initialBalance: Number(e.target.value) || 0 })}
                      />
                    </div>
                    <div>
                      <label className="text-sm font-medium block mb-1">–ü—Ä–æ—Ü–µ–Ω—Ç —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π (%)</label>
                      <input
                        type="number"
                        min="0"
                        max="100"
                        className="h-9 w-full border border-[#e2e8f0] dark:border-[#334155] bg-transparent px-3 py-1 text-sm rounded-xl focus:outline-none focus:ring-1 focus:ring-[#8366f1]"
                        value={settings.savingsPercent || ''}
                        onChange={(e) => setSettings({ ...settings, savingsPercent: Number(e.target.value) || 0 })}
                      />
                    </div>
                  </div>
                </div>

                <div className="h-px bg-[#e2e8f0] dark:bg-[#334155] w-full my-6" />

                {/* Visibility */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold flex items-center gap-2">
                    <EyeIcon className="h-5 w-5" /> –í–∏–¥–∏–º–æ—Å—Ç—å —Ä–∞–∑–¥–µ–ª–æ–≤
                  </h3>
                  <div className="grid gap-3 md:grid-cols-2">
                    {[
                      { key: 'overview', label: 'üìä –û–±–∑–æ—Ä' },
                      { key: 'budget', label: 'üí∞ –ë—é–¥–∂–µ—Ç' },
                      { key: 'shopping', label: 'üõí –ü–æ–∫—É–ø–∫–∏' },
                      { key: 'planning', label: 'üìÖ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' }, // ‚Üê renamed
                      { key: 'goals', label: 'üéØ –¶–µ–ª–∏' },
                      { key: 'bills', label: 'üßæ –°—á–µ—Ç–∞' },
                    ].map(({ key, label }) => (
                      <div key={key} className="flex items-center justify-between p-3 rounded-lg bg-[#f1f5f9] dark:bg-[#2a2a38]">
                        <label className="text-sm font-medium cursor-pointer">{label}</label>
                        <Switch
                          checked={settings.visibility[key]}
                          onChange={() => toggleSetting('visibility', key)}
                        />
                      </div>
                    ))}
                  </div>
                </div>

                {/* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Notifications, Telegram, Data) ‚Äî –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ ... */}
                {/* (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –Ω–µ –¥—É–±–ª–∏—Ä—É—é ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞, —Å–º. –ø—Ä–æ—à–ª—ã–π –æ—Ç–≤–µ—Ç) */}
              </div>
            </div>

            <div className="p-6 border-t border-[#e2e8f0] dark:border-[#334155] bg-[#f1f5f9] dark:bg-[#2a2a38]">
              <div className="flex justify-end gap-2">
                <button
                  onClick={() => setSettingsOpen(false)}
                  className="px-4 py-2 text-sm font-medium border border-[#e2e8f0] dark:border-[#334155] rounded-xl hover:bg-[#8366f1]/10"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  onClick={() => setSettingsOpen(false)}
                  className="px-4 py-2 text-sm font-medium text-white bg-[#8366f1] rounded-xl hover:bg-[#8366f1]/90"
                >
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Switch
const Switch = ({ checked, onChange }) => (
  <button
    type="button"
    role="switch"
    aria-checked={checked}
    onClick={onChange}
    className={`inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-[#8366f1] focus:ring-offset-2
      ${checked ? 'bg-[#8366f1]' : 'bg-[#e2e8f0] dark:bg-[#334155]'}
    `}
  >
    <span
      className={`pointer-events-none block h-4 w-4 rounded-full bg-white dark:bg-[#2a2a38] shadow-lg ring-0 transition-transform
        ${checked ? 'translate-x-4' : 'translate-x-0'}
      `}
    />
  </button>
);

export default App;
