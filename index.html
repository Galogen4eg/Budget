<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</title>
    <meta name="description" content="–£—á—ë—Ç —Å–µ–º–µ–π–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π">
    <meta name="theme-color" content="#667eea">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script defer src="core.js"></script>
    <script defer src="rooms.js"></script>
    <script defer src="app.js"></script>
    <style>
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .header-gradient h1 { color: white; }
        .header-gradient nav a {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .header-gradient nav a.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 6px 16px rgba(255,255,255,0.4);
        }
        .header-gradient nav a.inactive {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
        }
        .header-gradient nav a.inactive:hover {
            background: rgba(255,255,255,0.25);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-4 px-3 md:py-8 md:px-4">
    <div class="max-w-5xl mx-auto">
        <header class="header-gradient text-center">
            <h1 class="text-2xl md:text-3xl font-medium mb-4">üë®‚Äçüë©‚Äçüëß –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h1>
            <nav class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-lg mx-auto">
                <a href="index.html" class="active" data-room-link="index.html">
                    üìä –ë—é–¥–∂–µ—Ç
                </a>
                <a href="shopping.html" class="inactive" data-room-link="shopping.html">
                    üõçÔ∏è –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
                </a>
            </nav>
            <div class="mt-4 flex flex-wrap items-center justify-center gap-3 text-sm font-medium">
                <span id="currentMonth" class="px-4 py-1 rounded-full bg-white/20 border border-white/30 text-white"></span>
                <span id="connectionStatus" class="text-white text-lg" title="–õ–æ–∫–∞–ª—å–Ω–æ">üî¥</span>
            </div>
        </header>

        <div id="roomInfo" class="hidden mb-4 p-4 bg-white rounded-xl border border-gray-200 flex flex-wrap items-center justify-between gap-3">
            <div>
                <div class="text-xs text-gray-500">–ö–æ–º–Ω–∞—Ç–∞</div>
                <div id="currentRoomId" class="font-mono font-medium text-gray-800"></div>
                <div class="text-xs text-gray-500 mt-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="currentUserName" class="font-medium"></span></div>
            </div>
            <div class="flex gap-2">
                <button onclick="copyRoomLink()" class="btn-secondary px-3 py-2 rounded-lg text-sm font-medium">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                <button onclick="leaveRoom()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-sm font-medium transition-colors">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div id="tabsContainer" class="flex justify-center gap-2 mb-4 flex-wrap"></div>

        <div id="personalContent">
            <div class="card p-4 md:p-6 mb-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-base font-medium text-gray-800 flex items-center gap-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ö–æ–¥ / —Ä–∞—Å—Ö–æ–¥</h2>
                    <button onclick="toggleAddSection()" id="toggleAddBtn" class="text-blue-600 hover-text-blue-700 text-sm font-medium">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
                </div>
                <div id="addSectionContent" class="hidden mt-4">
                    <div class="bg-green-50 rounded-lg p-4 mb-4 border border-green-200">
                        <h3 class="text-sm font-medium text-green-800 mb-3 flex items-center gap-2">üíµ –ü—Ä–∏—Ö–æ–¥</h3>
                        <div class="grid md:grid-cols-4 gap-3">
                            <input type="date" id="incomeDate" class="input-field w-full px-3 py-2 text-gray-800 text-sm">
                            <input type="text" id="incomeDescription" placeholder="–û—Ç–∫—É–¥–∞ (–∑–∞—Ä–ø–ª–∞—Ç–∞...)" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                            <div class="relative">
                                <input type="number" id="incomeAmount" placeholder="–°—É–º–º–∞" min="0" step="0.01" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">‚ÇΩ</span>
                            </div>
                            <button onclick="addIncome()" class="btn-success w-full px-3 py-2 rounded-lg font-medium text-sm">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                        <h3 class="text-sm font-medium text-red-800 mb-3 flex items-center gap-2">üí∏ –†–∞—Å—Ö–æ–¥</h3>
                        <div class="grid md-grid-cols-4 gap-3">
                            <input type="date" id="expenseDate" class="input-field w-full px-3 py-2 text-gray-800 text-sm">
                            <input type="text" id="expenseDescription" placeholder="–ù–∞ —á—Ç–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                            <div class="relative">
                                <input type="number" id="expenseAmount" placeholder="–°—É–º–º–∞" min="0" step="1" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">‚ÇΩ</span>
                            </div>
                            <button onclick="addExpense()" class="btn-primary w-full px-3 py-2 rounded-lg font-medium text-sm">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                        <div id="categoryChips" class="flex flex-wrap gap-2 mt-3"></div>
                        <div class="flex gap-2 mt-3">
                            <input type="text" id="newCategoryName" placeholder="‚ûï –°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚òï –ö–æ—Ñ–µ)" class="input-field flex-1 px-3 py-2 text-sm text-gray-800 placeholder-gray-400">
                            <button onclick="addCustomCategory()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <details>
                    <summary class="text-base font-medium text-gray-800 cursor-pointer flex items-center gap-2">ü§ñ –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (Gemini AI)</summary>
                    <div class="mt-3">
                        <p class="text-gray-600 text-sm mb-3">–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—ã–ø–∏—Å–∫–∏ –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ø–æ–º–æ—â—å—é –ò–ò.</p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <input type="password" id="geminiApiKey" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ API –∫–ª—é—á Gemini" class="input-field flex-1 px-3 py-2 text-sm">
                            <button onclick="saveGeminiKey()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button onclick="testGeminiKey()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                        </div>
                        <p class="text-gray-500 text-xs">–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com/app/apikey</a></p>
                        <div id="geminiStatus" class="mt-2 text-sm"></div>
                        <div class="mt-3 pt-3 border-t border-gray-200 space-y-2">
                            <button onclick="recategorizeOperations()" class="btn-secondary w-full px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                                üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                            </button>
                            <button onclick="reapplyLocalCategories()" class="btn-secondary w-full px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                                ‚ôªÔ∏è –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–±–µ–∑ –ò–ò)
                            </button>
                        </div>
                    </div>
                </details>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <h2 class="text-base font-medium text-gray-800 mb-3 flex items-center gap-2">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É –∏–∑ –±–∞–Ω–∫–∞</h2>
                <div class="flex items-center gap-3">
                    <label class="flex-1">
                        <div class="btn-primary px-4 py-2 rounded-lg font-medium text-center cursor-pointer flex items-center justify-center gap-2 text-sm">üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (Excel)</div>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelFile(event)">
                    </label>
                </div>
                <p class="text-blue-600 text-xs mt-2">–§–æ—Ä–º–∞—Ç: Excel (.xlsx, .xls, .csv)</p>
                <div id="undoImportContainer" class="hidden mt-3"></div>
                <div id="excelPreview" class="hidden mt-3">
                    <div class="bg-white border border-blue-200 rounded-lg p-3">
                        <h4 class="font-medium text-gray-800 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö:</h4>
                        <div class="text-sm text-gray-600 mb-2">–ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: <span id="excelRowCount" class="font-medium">0</span><span id="excelSkippedCount" class="text-gray-400 ml-2"></span></div>
                        <div id="excelPreviewTable" class="max-h-64 overflow-auto border border-gray-200 rounded bg-white mb-3"></div>
                        <div class="flex gap-2">
                            <button onclick="importExcelData()" class="btn-primary flex-1 px-4 py-2 rounded-lg font-medium text-sm">‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button onclick="cancelExcelImport()" class="btn-secondary px-4 py-2 rounded-lg font-medium text-sm">‚úï –û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-base font-medium text-gray-800 flex items-center gap-2">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ç—Ä–∞—Ç</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="changeMonth(-1)" class="btn-secondary px-2 py-1 rounded text-xs">‚Üê</button>
                        <span id="calendarMonth" class="text-gray-700 font-medium text-xs min-w-[80px] text-center"></span>
                        <button onclick="changeMonth(1)" class="btn-secondary px-2 py-1 rounded text-xs">‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid mb-1">
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–ü–Ω</div>
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–í—Ç</div>
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–°—Ä</div>
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–ß—Ç</div>
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–ü—Ç</div>
                    <div class="text-center text-amber-600 text-[10px] font-medium py-1">–°–±</div>
                    <div class="text-center text-red-500 text-[10px] font-medium py-1">–í—Å</div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
                <div class="flex justify-center gap-3 mt-3 text-[10px] text-gray-500">
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded bg-gradient-to-br from-green-100 to-green-200 border border-green-400"></div><span>–í –ª–∏–º–∏—Ç–µ</span></div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded bg-gradient-to-br from-red-100 to-red-200 border border-red-400"></div><span>–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ</span></div>
                    <button onclick="clearDayFilter()" id="clearFilterBtn" class="hidden text-blue-600 hover:text-blue-800 font-medium">‚úï –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                </div>
            </div>

            <div id="dayExpensesPanel" class="hidden card p-4 md:p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-base font-medium text-gray-800 flex items-center gap-2">üìã –û–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞ <span id="selectedDayTitle"></span></h2>
                    <button onclick="closeDayPanel()" class="text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
                </div>
                <div id="dayExpensesList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                    <span class="text-gray-600">–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å:</span>
                    <span id="dayTotal" class="text-xl font-medium text-gray-800">0 ‚ÇΩ</span>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-base font-medium text-gray-800 flex items-center gap-2">üìä –û–ø–µ—Ä–∞—Ü–∏–∏ <span id="tableFilterInfo" class="text-sm text-gray-400 font-normal"></span></h2>
                    <button onclick="clearMonthExpenses()" class="text-red-500 hover:text-red-600 text-sm font-medium px-2">üóëÔ∏è</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-200">
                                <th class="text-left py-3 px-2 font-medium text-gray-600">üìÖ –î–∞—Ç–∞</th>
                                <th class="text-left py-3 px-2 font-medium text-gray-600 hidden md:table-cell">–î–µ–Ω—å</th>
                                <th class="text-left py-3 px-2 font-medium text-gray-600">üìù –û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th class="text-right py-3 px-2 font-medium text-gray-600">üíµ –ü—Ä–∏—Ö–æ–¥</th>
                                <th class="text-right py-3 px-2 font-medium text-gray-600">üí∏ –†–∞—Å—Ö–æ–¥</th>
                                <th class="text-right py-3 px-2 font-medium text-gray-600">üí∞ –ë–∞–ª–∞–Ω—Å</th>
                                <th class="text-right py-3 px-2 font-medium text-gray-600 hidden lg:table-cell">üìà Max/–¥–µ–Ω—å</th>
                            </tr>
                        </thead>
                        <tbody id="dailyTableBody"></tbody>
                        <tfoot id="dailyTableFooter" class="bg-gray-50 border-t-2 border-gray-300"></tfoot>
                    </table>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <h2 class="text-base font-medium text-gray-800 mb-4 flex items-center gap-2">üìä –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
                <div id="categoryStats" class="space-y-2"><p class="text-gray-400 text-center py-4">–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞—Ç—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p></div>
            </div>

            <div class="hidden card p-4 md:p-6 mb-4">
                <h2 class="text-base font-medium text-gray-800 mb-3 flex items-center gap-2">üìà –ì—Ä–∞—Ñ–∏–∫: –ü–ª–∞–Ω vs –§–∞–∫—Ç</h2>
                <div class="relative" style="height: 200px;"><canvas id="budgetChart"></canvas></div>
            </div>

            <div class="hidden card p-4 md:p-6 mb-4">
                <details>
                    <summary class="text-base font-medium text-gray-800 cursor-pointer flex items-center gap-2">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤</summary>
                    <div class="mt-3">
                        <div class="relative" style="height: 200px;"><canvas id="comparisonChart"></canvas></div>
                        <div id="comparisonTable" class="mt-4 overflow-x-auto"></div>
                    </div>
                </details>
            </div>

            <div class="hidden card p-4 md:p-6 mb-4">
                <details>
                    <summary class="text-base font-medium text-gray-800 cursor-pointer flex items-center gap-2">üí≥ –õ–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</summary>
                    <div class="mt-3">
                        <div class="bg-gray-50 rounded-lg p-3 mb-3 border border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <input type="text" id="limitCategory" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (üçî –ï–¥–∞)" class="input-field px-3 py-2 text-sm">
                                <div class="relative">
                                    <input type="number" id="limitAmount" placeholder="–õ–∏–º–∏—Ç" min="0" class="input-field w-full px-3 py-2 text-sm">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">‚ÇΩ/–º–µ—Å</span>
                                </div>
                                <button onclick="addCategoryLimit()" class="btn-primary px-3 py-2 rounded-lg text-sm font-medium">+ –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç</button>
                            </div>
                        </div>
                        <div id="limitsContainer" class="space-y-2"></div>
                    </div>
                </details>
            </div>
        </div>

        <div id="totalContent" class="hidden">
            <div class="card p-4 md:p-6 mb-4">
                <h2 class="text-lg font-medium text-gray-800 mb-4 flex items-center gap-2">üìä –û–±—â–∞—è —Å–≤–æ–¥–∫–∞ —Å–µ–º—å–∏</h2>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üë®
                                                                                                                                 -center gap-2">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—é–¥–∂–µ—Ç–∞</h2>
                    <button onclick="toggleSettings()" id="toggleSettingsBtn" class="text-blue-600 hover-text-blue-700 text-sm font-medium">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
                </div>
                <div id="settingsContent" class="hidden mt-4">
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label class="text-gray-500 text-xs block mb-1">üè¶ –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</label>
                            <div class="relative">
                                <input type="number" id="savingsPercent" placeholder="0" min="0" max="100" step="1" class="input-field w-full px-3 py-2 text-gray-800 font-medium placeholder-gray-400">
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-gray-500 text-xs block mb-1">üìä –ò—Ç–æ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</label>
                            <div id="totalIncomeDisplay" class="px-3 py-2 bg-green-50 border border-green-200 rounded text-green-700 font-medium">0 ‚ÇΩ</div>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">üìã –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</h3>
                        <div class="bg-gray-50 rounded-lg p-3 mb-3 border border-gray-200">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <select id="newPaymentCategory" class="input-field w-full px-2 py-2 text-sm text-gray-800 bg-white">
                                    <option value="housing">üè† –ñ–∏–ª—å—ë</option>
                                    <option value="utilities">üí° –ö–æ–º–º—É–Ω–∞–ª–∫–∞</option>
                                    <option value="transport">üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                                    <option value="communication">üì± –°–≤—è–∑—å</option>
                                    <option value="subscriptions">üì∫ –ü–æ–¥–ø–∏—Å–∫–∏</option>
                                    <option value="credits">üí≥ –ö—Ä–µ–¥–∏—Ç—ã</option>
                                    <option value="insurance">üõ°Ô∏è –°—Ç—Ä–∞—Ö–æ–≤–∫–∏</option>
                                    <option value="education">üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                                    <option value="health">üè• –ó–¥–æ—Ä–æ–≤—å–µ</option>
                                    <option value="family">üë®‚Äçüë©‚Äçüëß –°–µ–º—å—è</option>
                                    <option value="pets">üêï –ü–∏—Ç–æ–º—Ü—ã</option>
                                    <option value="other">üì¶ –ü—Ä–æ—á–µ–µ</option>
                                </select>
                                <input type="text" id="newPaymentName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="input-field w-full px-2 py-2 text-sm text-gray-800 placeholder-gray-400">
                                <div class="relative">
                                    <input type="number" id="newPaymentAmount" placeholder="–°—É–º–º–∞" min="0" class="input-field w-full px-2 py-2 text-sm text-gray-800 placeholder-gray-400">
                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">‚ÇΩ</span>
                                </div>
                                <button onclick="addFixedPayment()" class="btn-primary w-full px-3 py-2 rounded-lg text-sm font-medium">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                        <div id="fixedPaymentsList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="p-2 bg-white rounded border">
                            <div class="text-gray-500 text-xs">–ú–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å</div>
                            <div id="savingsAmount" class="text-blue-600 font-medium text-sm">0</div>
                        </div>
                        <div class="p-2 bg-white rounded border">
                            <div class="text-gray-500 text-xs">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã</div>
                            <div id="fixedTotal" class="text-red-500 font-medium text-sm">0</div>
                        </div>
                        <div class="p-2 bg-white rounded border">
                            <div class="text-gray-500 text-xs">Max —Ç—Ä–∞—Ç—ã –Ω–∞ –¥–µ–Ω—å</div>
                            <div id="dailyLimit" class="text-amber-600 font-medium text-sm">0</div>
                        </div>
                        <div class="p-2 bg-white rounded border">
                            <div class="text-gray-500 text-xs">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                            <div id="actualBalance" class="text-purple-600 font-medium text-sm">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <details>
                    <summary class="text-base font-medium text-gray-800 cursor-pointer flex items-center gap-2">üîç –ü–æ–∏—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π</summary>
                    <div class="mt-3">
                        <div class="flex gap-2">
                            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é..." class="input-field flex-1 px-3 py-2 text-sm" oninput="searchOperations()">
                            <button onclick="clearSearch()" class="btn-secondary px-3 py-2 rounded-lg text-sm">‚úï</button>
                        </div>
                        <div id="searchResults" class="hidden mt-3 max-h-64 overflow-y-auto space-y-2"></div>
                    </div>
                </details>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-base font-medium text-gray-800 flex items-center gap-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ö–æ–¥ / —Ä–∞—Å—Ö–æ–¥</h2>
                    <button onclick="toggleAddSection()" id="toggleAddBtn" class="text-blue-600 hover-text-blue-700 text-sm font-medium">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
                </div>
                <div id="addSectionContent" class="hidden mt-4">
                    <div class="bg-green-50 rounded-lg p-4 mb-4 border border-green-200">
                        <h3 class="text-sm font-medium text-green-800 mb-3 flex items-center gap-2">üíµ –ü—Ä–∏—Ö–æ–¥</h3>
                        <div class="grid md:grid-cols-4 gap-3">
                            <input type="date" id="incomeDate" class="input-field w-full px-3 py-2 text-gray-800 text-sm">
                            <input type="text" id="incomeDescription" placeholder="–û—Ç–∫—É–¥–∞ (–∑–∞—Ä–ø–ª–∞—Ç–∞...)" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                            <div class="relative">
                                <input type="number" id="incomeAmount" placeholder="–°—É–º–º–∞" min="0" step="0.01" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">‚ÇΩ</span>
                            </div>
                            <button onclick="addIncome()" class="btn-success w-full px-3 py-2 rounded-lg font-medium text-sm">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                        <h3 class="text-sm font-medium text-red-800 mb-3 flex items-center gap-2">üí∏ –†–∞—Å—Ö–æ–¥</h3>
                        <div class="grid md-grid-cols-4 gap-3">
                            <input type="date" id="expenseDate" class="input-field w-full px-3 py-2 text-gray-800 text-sm">
                            <input type="text" id="expenseDescription" placeholder="–ù–∞ —á—Ç–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                            <div class="relative">
                                <input type="number" id="expenseAmount" placeholder="–°—É–º–º–∞" min="0" step="1" class="input-field w-full px-3 py-2 text-gray-800 placeholder-gray-400 text-sm">
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">‚ÇΩ</span>
                            </div>
                            <button onclick="addExpense()" class="btn-primary w-full px-3 py-2 rounded-lg font-medium text-sm">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                        <div id="categoryChips" class="flex flex-wrap gap-2 mt-3"></div>
                        <div class="flex gap-2 mt-3">
                            <input type="text" id="newCategoryName" placeholder="‚ûï –°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚òï –ö–æ—Ñ–µ)" class="input-field flex-1 px-3 py-2 text-sm text-gray-800 placeholder-gray-400">
                            <button onclick="addCustomCategory()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <details>
                    <summary class="text-base font-medium text-gray-800 cursor-pointer flex items-center gap-2">ü§ñ –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (Gemini AI)</summary>
                    <div class="mt-3">
                        <p class="text-gray-600 text-sm mb-3">–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—ã–ø–∏—Å–∫–∏ –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ø–æ–º–æ—â—å—é –ò–ò.</p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <input type="password" id="geminiApiKey" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ API –∫–ª—é—á Gemini" class="input-field flex-1 px-3 py-2 text-sm">
                            <button onclick="saveGeminiKey()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button onclick="testGeminiKey()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                        </div>
                        <p class="text-gray-500 text-xs">–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com/app/apikey</a></p>
                        <div id="geminiStatus" class="mt-2 text-sm"></div>
                        <div class="mt-3 pt-3 border-t border-gray-200 space-y-2">
                            <button onclick="recategorizeOperations()" class="btn-secondary w-full px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                                üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                            </button>
                            <button onclick="reapplyLocalCategories()" class="btn-secondary w-full px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                                ‚ôªÔ∏è –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–±–µ–∑ –ò–ò)
                            </button>
                        </div>
                    </div>
                </details>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <h2 class="text-base font-medium text-gray-800 mb-3 flex items-center gap-2">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É –∏–∑ –±–∞–Ω–∫–∞</h2>
                <div class="flex items-center gap-3">
                    <label class="flex-1">
                        <div class="btn-primary px-4 py-2 rounded-lg font-medium text-center cursor-pointer flex items-center justify-center gap-2 text-sm">üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (Excel)</div>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelFile(event)">
                    </label>
                </div>
                <p class="text-blue-600 text-xs mt-2">–§–æ—Ä–º–∞—Ç: Excel (.xlsx, .xls, .csv)</p>
                <div id="undoImportContainer" class="hidden mt-3"></div>
                <div id="excelPreview" class="hidden mt-3">
                    <div class="bg-white border border-blue-200 rounded-lg p-3">
                        <h4 class="font-medium text-gray-800 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö:</h4>
                        <div class="text-sm text-gray-600 mb-2">–ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: <span id="excelRowCount" class="font-medium">0</span><span id="excelSkippedCount" class="text-gray-400 ml-2"></span></div>
                        <div id="excelPreviewTable" class="max-h-64 overflow-auto border border-gray-200 rounded bg-white mb-3"></div>
                        <div class="flex gap-2">
                            <button onclick="importExcelData()" class="btn-primary flex-1 px-4 py-2 rounded-lg font-medium text-sm">‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button onclick="cancelExcelImport()" class="btn-secondary px-4 py-2 rounded-lg font-medium text-sm">‚úï –û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 md:p-6 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-base font-medium text-gray-800 flex items-center gap-2">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ç—Ä–∞—Ç</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="changeMonth(-1)" class="btn-secondary px-2 py-1 rounded text-xs">‚Üê</button>
                        <span id="calendarMonth" class="text-gray-700 font-medium text-xs min-w-[80px] text-center"></span>
                        <button onclick="changeMonth(1)" class="btn-secondary px-2 py-1 rounded text-xs">‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid mb-1">
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–ü–Ω</div>
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–í—Ç</div>
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">–°—Ä</div>
                    <div class="text-center text-gray-500 text-[10px] font-medium py-1">
... (truncated)
