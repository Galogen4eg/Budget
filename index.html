<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Семейный бюджет</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --primary: #4361ee;
      --accent: #06d6a0;
      --error: #ef476f;
      --surface: #ffffff;
      --surface-light: #f8fafc;
      --text: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f1f5f9;
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
    }
    /* Header */
    header {
      background: var(--surface);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .tabs-container {
      display: flex;
      justify-content: center;
      padding: 16px 0;
      position: relative;
    }
    .tabs {
      display: flex;
      gap: 8px;
      background: #f1f5f9;
      padding: 6px;
      border-radius: 16px;
      max-width: 500px;
    }
    .tab {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
    }
    .tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.25);
    }
    .tab:not(.active):hover {
      color: var(--text);
    }
    .settings-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .settings-btn:hover {
      background: var(--surface-light);
      transform: rotate(90deg);
    }
    /* Main Content */
    main {
      padding: 24px 0 40px;
    }
    .section {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }
    .section-title i {
      color: var(--primary);
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Tiles */
    .tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .tile {
      background: var(--surface);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }
    .tile:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .tile-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }
    .tile-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
    }
    .tile-value.positive { color: var(--success); }
    .tile-value.negative { color: var(--error); }
    .tile-value.primary { color: var(--primary); }
    /* Calendar Controls */
    .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .calendar-title {
      font-size: 18px;
      font-weight: 700;
    }
    .nav-buttons {
      display: flex;
      gap: 8px;
    }
    .nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: white;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn:hover {
      background: var(--surface-light);
    }
    /* Calendar */
    .calendar-container {
      overflow-x: auto;
    }
    .calendar {
      min-width: 700px;
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    .calendar th {
      padding: 12px 8px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      background: var(--surface-light);
    }
    .calendar td {
      width: 14.28%;
      height: 70px;
      vertical-align: top;
      padding: 6px;
      text-align: right;
      position: relative;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar td:hover {
      background: var(--surface-light);
    }
    .calendar-date {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      border-radius: 50%;
      font-weight: 500;
    }
    .calendar-date.has-transaction {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }
    .calendar-date.inactive {
      opacity: 0.5;
    }
    .transaction-dot {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 6px;
      height: 6px;
      background-color: var(--primary);
      border-radius: 50%;
    }
    /* Categories */
    .categories {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .category-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--surface-light);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
    }
    .category-item:hover {
      background: #eef2ff;
    }
    .category-name {
      font-weight: 600;
      color: var(--text);
    }
    .category-amount {
      font-weight: 700;
    }
    .category-amount.positive { color: var(--success); }
    .category-amount.negative { color: var(--error); }
    /* Transactions */
    .transactions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .period-buttons {
      display: flex;
      gap: 8px;
    }
    .period-btn {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
    }
    .period-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .transactions {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }
    .transactions th {
      text-align: left;
      padding: 12px 16px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 14px;
      border-bottom: 2px solid var(--border);
    }
    .transactions td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    .transaction-row:hover {
      background-color: var(--surface-light);
    }
    .transaction-amount.positive { color: var(--success); }
    .transaction-amount.negative { color: var(--error); }
    .transaction-balance {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
    }
    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
      font-size: 15px;
    }
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.2s;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }
    .btn {
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #3a56e4);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.25);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(67, 97, 238, 0.35);
    }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-outline:hover {
      background: var(--surface-light);
    }
    .btn-success {
      background: linear-gradient(135deg, var(--accent), #05c194);
      color: white;
    }
    .btn-danger {
      background: linear-gradient(135deg, var(--error), #e53e5f);
      color: white;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn-file {
      position: relative;
      overflow: hidden;
    }
    .btn-file input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    .file-upload-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    .file-upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface-light);
      border-radius: 8px;
      border: 1px dashed var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-upload-label:hover {
      background: var(--surface);
      border-color: var(--primary);
    }
    .file-upload-icon {
      color: var(--primary);
    }
    .file-name {
      margin-left: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    /* Shopping */
    .shopping-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    @media (max-width: 768px) {
      .shopping-grid {
        grid-template-columns: 1fr;
      }
    }
    .shopping-list {
      list-style: none;
    }
    .shopping-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      background: var(--surface-light);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
    }
    .shopping-item:hover {
      background: #eef2ff;
    }
    .shopping-item.bought {
      opacity: 0.7;
      background: #f8fafc;
    }
    .item-checkbox {
      margin-right: 16px;
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }
    .item-name {
      flex: 1;
      font-weight: 600;
      color: var(--text);
    }
    .item-quantity {
      color: var(--text-secondary);
      margin-right: 16px;
      font-weight: 500;
    }
    /* Event Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      transform: scale(0.9);
      transition: transform 0.3s;
      margin: 20px;
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }
    .modal-actions {
      display: flex;
      gap: 8px;
    }
    .modal-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--surface-light);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    .modal-action-btn:hover {
      background: var(--surface);
      color: var(--text);
    }
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close-modal:hover {
      background: var(--surface-light);
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    /* Planner */
    .planner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }
    .view-buttons {
      display: flex;
      gap: 8px;
    }
    .view-btn {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
    }
    .view-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .calendar-header-cell {
      background: white;
      padding: 10px;
      text-align: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .calendar-day {
      background: white;
      min-height: 80px;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar-day:hover {
      background: var(--surface-light);
    }
    .calendar-date-number {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .event-item {
      background: #eef2ff;
      border-left: 3px solid var(--primary);
      padding: 6px 8px;
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .event-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .event-time {
      color: var(--text-secondary);
    }
    /* Day View Planner */
    .day-view-container {
      display: flex;
      height: 600px;
      overflow: hidden;
    }
    .time-column {
      width: 60px;
      background: var(--surface-light);
      border-right: 1px solid var(--border);
    }
    .time-slot {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }
    .events-container {
      flex: 1;
      position: relative;
      overflow-y: auto;
    }
    .hour-row {
      height: 60px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    .day-event {
      position: absolute;
      left: 8px;
      right: 8px;
      background: #eef2ff;
      border-radius: 4px;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .day-event-title {
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .day-event-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    /* Responsive */
    @media (max-width: 600px) {
      .tabs-container {
        padding: 12px 0;
      }
      .tabs {
        gap: 4px;
      }
      .tab {
        padding: 8px 12px;
        font-size: 14px;
      }
      .tile {
        padding: 16px;
      }
      .tile-value {
        font-size: 20px;
      }
      .section {
        padding: 16px;
      }
      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      .transactions th,
      .transactions td {
        padding: 10px 12px;
        font-size: 14px;
      }
      .modal-content {
        width: 95%;
      }
    }
    /* Notification */
    #notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #notification.show {
      opacity: 1;
    }
    /* Participant color dot */
    .participant-color {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="tabs-container">
        <div class="tabs">
          <div class="tab active" data-tab="budget">
            <i class="fas fa-wallet"></i> Бюджет
          </div>
          <div class="tab" data-tab="shopping">
            <i class="fas fa-shopping-cart"></i> Покупки
          </div>
          <div class="tab" data-tab="planner">
            <i class="fas fa-calendar-alt"></i> Планировщик
          </div>
        </div>
        <div class="settings-btn" id="settingsBtn">
          <i class="fas fa-cog"></i>
        </div>
      </div>
    </div>
  </header>
  <main class="container">
    <!-- Budget Tab -->
    <div id="budgetTab" class="tab-content">
      <!-- Balance Tiles -->
      <div class="tiles">
        <div class="tile">
          <div class="tile-title">Текущий баланс</div>
          <div class="tile-value primary">12 450 ₽</div>
        </div>
        <div class="tile">
          <div class="tile-title">Накопления</div>
          <div class="tile-value positive">1 245 ₽</div>
        </div>
        <div class="tile">
          <div class="tile-title">Ежедневный лимит</div>
          <div class="tile-value">1 045 ₽</div>
        </div>
        <div class="tile">
          <div class="tile-title">Обязательные траты</div>
          <div class="tile-value negative">25 650 ₽</div>
        </div>
      </div>
      <!-- Calendar -->
      <div class="section">
        <div class="calendar-controls">
          <div class="calendar-title" id="budgetCalendarTitle">Октябрь 2025</div>
          <div class="nav-buttons">
            <button class="nav-btn" id="prevMonthBtn">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="nav-btn" id="nextMonthBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div class="calendar-container">
          <table class="calendar" id="budgetCalendar">
            <thead>
              <tr>
                <th>Пн</th>
                <th>Вт</th>
                <th>Ср</th>
                <th>Чт</th>
                <th>Пт</th>
                <th>Сб</th>
                <th>Вс</th>
              </tr>
            </thead>
            <tbody id="budgetCalendarBody">
              <!-- Calendar will be generated by JS -->
            </tbody>
          </table>
        </div>
      </div>
      <!-- Categories -->
      <div class="section">
        <div class="section-title">
          <i class="fas fa-tags"></i> Категории
        </div>
        <div class="categories" id="categoriesList">
          <!-- Categories will be generated by JS -->
        </div>
      </div>
      <!-- Transactions -->
      <div class="section">
        <div class="transactions-header">
          <div class="section-title">
            <i class="fas fa-exchange-alt"></i> История операций
          </div>
          <div class="period-buttons">
            <button class="period-btn active" id="currentMonthBtn">Текущий месяц</button>
            <button class="period-btn" id="allTimeBtn">За всё время</button>
          </div>
        </div>
        <table class="transactions">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Описание</th>
              <th>Категория</th>
              <th>Сумма</th>
              <th>Баланс</th>
            </tr>
          </thead>
          <tbody id="transactionsList">
            <!-- Transactions will be generated by JS -->
          </tbody>
        </table>
        <div class="file-upload-container">
          <label class="file-upload-label" for="fileUpload">
            <i class="fas fa-file-upload file-upload-icon"></i>
            <span id="uploadText">Загрузить выписку из банка</span>
            <span class="file-name" id="fileName"></span>
          </label>
          <input type="file" id="fileUpload" accept=".xlsx,.xls" style="display: none;">
        </div>
        <div class="btn-group" style="margin-top: 12px;">
          <button class="btn btn-success" id="addIncomeBtn">
            Доход
          </button>
          <button class="btn btn-danger" id="addExpenseBtn">
            Расход
          </button>
        </div>
      </div>
    </div>
    <!-- Shopping Tab -->
    <div id="shoppingTab" class="tab-content" style="display: none;">
      <div class="shopping-grid">
        <!-- Left Column -->
        <div>
          <div class="section">
            <div class="section-title">
              <i class="fas fa-plus-circle"></i> Быстрое добавление
            </div>
            <div class="form-group">
              <label class="form-label">Название</label>
              <input type="text" class="form-control" id="itemName" placeholder="Напр., Молоко">
            </div>
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label class="form-label">Количество</label>
                <input type="number" class="form-control" id="itemQuantity" placeholder="1" value="1" min="1">
              </div>
              <div>
                <label class="form-label">Ед. изм.</label>
                <select class="form-control" id="itemUnit">
                  <option value="pcs">шт.</option>
                  <option value="liters">л</option>
                  <option value="grams">г</option>
                  <option value="kg">кг</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" id="addItemBtn" style="width: 100%;">
              Добавить в список
            </button>
          </div>
          <div class="section">
            <div class="section-title">
              <i class="fas fa-chart-bar"></i> Топ покупок
            </div>
            <div id="topShoppingList" style="max-height: 200px; overflow-y: auto;">
              <!-- Top shopping items will be generated by JS -->
            </div>
          </div>
        </div>
        <!-- Right Column -->
        <div>
          <div class="section">
            <div class="section-title">
              <i class="fas fa-list"></i> Список покупок
            </div>
            <ul class="shopping-list" id="shoppingList">
              <!-- Shopping items will be generated by JS -->
            </ul>
            <button class="btn btn-success" id="sendToTelegramBtn" style="width: 100%; margin-top: 16px;">
              <i class="fas fa-paper-plane"></i> Отправить в Telegram
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Planner Tab -->
    <div id="plannerTab" class="tab-content" style="display: none;">
      <div class="section">
        <div class="planner-header">
          <div class="calendar-controls">
            <div class="calendar-title" id="plannerCalendarTitle">Декабрь 2025</div>
            <div class="nav-buttons">
              <button class="nav-btn" id="prevPlannerMonthBtn">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="nav-btn" id="nextPlannerMonthBtn">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="view-buttons">
            <button class="view-btn active" data-view="month">Месяц</button>
            <button class="view-btn" data-view="week">Неделя</button>
            <button class="view-btn" data-view="day">День</button>
          </div>
        </div>
        <div id="plannerCalendarContainer">
          <!-- Calendar will be generated by JS -->
          <div class="calendar-grid" id="plannerCalendar">
            <!-- Month view will be shown by default -->
          </div>
        </div>
        <!-- Events List -->
        <div class="section" id="eventsListSection">
          <div class="section-title">
            <i class="fas fa-list"></i> События
          </div>
          <div id="eventsList">
            <!-- Events will be generated by JS -->
          </div>
        </div>
        <button class="btn btn-primary" id="addEventBtn" style="margin-top: 20px;">
          Добавить событие
        </button>
      </div>
    </div>
  </main>
  <!-- Transaction Modal -->
  <div class="modal" id="transactionModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="transactionModalTitle">Новая операция</div>
        <button class="close-modal" id="closeTransactionModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Тип операции</label>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-success" id="incomeTypeBtn" style="flex: 1;">Доход</button>
            <button class="btn btn-danger" id="expenseTypeBtn" style="flex: 1;">Расход</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Сумма</label>
          <input type="number" class="form-control" id="transactionAmount" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Категория</label>
          <select class="form-control" id="transactionCategory">
            <option value="Продукты">Продукты</option>
            <option value="Транспорт">Транспорт</option>
            <option value="Жильё">Жильё</option>
            <option value="Здоровье">Здоровье</option>
            <option value="Развлечения">Развлечения</option>
            <option value="Доход">Доход</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Описание</label>
          <input type="text" class="form-control" id="transactionDescription" placeholder="Описание операции">
        </div>
        <div class="form-group">
          <label class="form-label">Дата</label>
          <input type="date" class="form-control" id="transactionDate">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelTransactionBtn">Отмена</button>
        <button class="btn btn-primary" id="saveTransactionBtn">Сохранить</button>
      </div>
    </div>
  </div>
  <!-- Shopping Item Modal -->
  <div class="modal" id="shoppingItemModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Редактировать товар</div>
        <button class="close-modal" id="closeShoppingItemModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Название</label>
          <input type="text" class="form-control" id="editItemName" placeholder="Название товара">
        </div>
        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label class="form-label">Количество</label>
            <input type="number" class="form-control" id="editItemQuantity" placeholder="1" min="1">
          </div>
          <div>
            <label class="form-label">Ед. изм.</label>
            <select class="form-control" id="editItemUnit">
              <option value="pcs">шт.</option>
              <option value="liters">л</option>
              <option value="grams">г</option>
              <option value="kg">кг</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="editItemBought" style="margin-right: 8px; width: 16px; height: 16px;">
            <span>Куплено</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelShoppingItemBtn">Отмена</button>
        <button class="btn btn-primary" id="saveShoppingItemBtn">Сохранить</button>
      </div>
    </div>
  </div>
  <!-- Event Modal -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Новое событие</div>
        <div class="modal-actions">
          <button class="modal-action-btn" id="copyEventBtn" title="Копировать">
            <i class="fas fa-copy"></i>
          </button>
          <button class="close-modal" id="closeEventModal">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Название</label>
          <input type="text" class="form-control" id="eventTitle" placeholder="Название события">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label">Дата и время начала</label>
            <input type="datetime-local" class="form-control" id="eventStart">
          </div>
          <div class="form-group">
            <label class="form-label">Дата и время окончания (необязательно)</label>
            <input type="datetime-local" class="form-control" id="eventEnd">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Участники</label>
          <div id="participantSelection" style="display: flex; flex-wrap: wrap; gap: 8px;">
            <!-- Participants will be generated by JS -->
          </div>
        </div>
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="isTemplate" style="margin-right: 8px; width: 16px; height: 16px;">
            <span>Сделать шаблоном</span>
          </label>
          <input type="text" class="form-control" id="templateName" placeholder="Название шаблона" style="margin-top: 8px; display: none;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelEventBtn">Отмена</button>
        <button class="btn btn-primary" id="saveEventBtn">Создать</button>
      </div>
    </div>
  </div>
  <!-- Add Participant Modal -->
  <div class="modal" id="addParticipantModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Добавить/редактировать участника</div>
        <button class="close-modal" id="closeAddParticipantModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Имя участника</label>
          <input type="text" class="form-control" id="newParticipantName" placeholder="Введите имя">
        </div>
        <div class="form-group">
          <label class="form-label">Цвет участника</label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #4361ee; cursor: pointer;" data-color="#4361ee"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #06d6a0; cursor: pointer;" data-color="#06d6a0"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ef476f; cursor: pointer;" data-color="#ef476f"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ffd166; cursor: pointer;" data-color="#ffd166"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #118ab2; cursor: pointer;" data-color="#118ab2"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #073b4c; cursor: pointer;" data-color="#073b4c"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #7209b7; cursor: pointer;" data-color="#7209b7"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #f15bb5; cursor: pointer;" data-color="#f15bb5"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #0077b6; cursor: pointer;" data-color="#0077b6"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #2a9d8f; cursor: pointer;" data-color="#2a9d8f"></div>
          </div>
          <input type="color" id="customColorPicker" value="#4361ee" style="margin-top: 12px; width: 100%; height: 40px; border: none; border-radius: 8px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelAddParticipantBtn">Отмена</button>
        <button class="btn btn-primary" id="saveParticipantBtn">Сохранить</button>
      </div>
    </div>
  </div>
  <!-- Edit Category Modal -->
  <div class="modal" id="editCategoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="editCategoryTitle">Редактировать категорию</div>
        <button class="close-modal" id="closeEditCategoryModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Название категории</label>
          <input type="text" class="form-control" id="editCategoryName" placeholder="Название категории">
        </div>
        <div class="form-group">
          <label class="form-label">Цвет категории</label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #4361ee; cursor: pointer;" data-color="#4361ee"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #06d6a0; cursor: pointer;" data-color="#06d6a0"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ef476f; cursor: pointer;" data-color="#ef476f"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ffd166; cursor: pointer;" data-color="#ffd166"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #118ab2; cursor: pointer;" data-color="#118ab2"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #073b4c; cursor: pointer;" data-color="#073b4c"></div>
          </div>
          <input type="color" id="categoryColorPicker" value="#4361ee" style="margin-top: 12px; width: 100%; height: 40px; border: none; border-radius: 8px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelEditCategoryBtn">Отмена</button>
        <button class="btn btn-primary" id="saveEditCategoryBtn">Сохранить</button>
      </div>
    </div>
  </div>
  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Настройки</div>
        <button class="close-modal" id="closeSettingsModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="notificationsEnabled" style="margin-right: 8px; width: 16px; height: 16px;" checked>
            <span>Включить уведомления</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">Участники семьи</label>
          <div id="familyMembersList" style="max-height: 200px; overflow-y: auto;">
            <!-- Family members will be generated by JS -->
          </div>
        </div>
        <button class="btn btn-primary" id="addFamilyMemberBtn">Добавить участника</button>
        <!-- Categories -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Категории</label>
          <div id="categoriesListSettings" style="max-height: 200px; overflow-y: auto;">
            <!-- Categories will be generated by JS -->
          </div>
        </div>
        <button class="btn btn-primary" id="addCategoryBtn">Добавить категорию</button>
        <!-- Shopping Settings -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="autoCompleteShopping" style="margin-right: 8px; width: 16px; height: 16px;" checked>
            <span>Автоподстановка покупок из словаря</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="sortShoppingByCategory" style="margin-right: 8px; width: 16px; height: 16px;">
            <span>Сортировать покупки по категориям</span>
          </label>
        </div>
        <!-- Telegram Integration -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Интеграция с Telegram</label>
          <div class="form-group">
            <input type="text" class="form-control" id="telegramToken" placeholder="Введите токен бота">
          </div>
          <div class="form-group">
            <input type="text" class="form-control" id="telegramChatId" placeholder="Введите ID чата">
          </div>
        </div>
        <!-- Export Settings -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Экспорт данных</label>
          <div class="btn-group">
            <button class="btn btn-outline" id="exportJsonBtn">Экспорт в JSON</button>
            <button class="btn btn-outline" id="exportExcelBtn">Экспорт в Excel</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelSettingsBtn">Отмена</button>
        <button class="btn btn-primary" id="saveSettingsBtn">Сохранить</button>
      </div>
    </div>
  </div>
  <!-- Notification -->
  <div id="notification">Действие выполнено успешно!</div>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/weekOfYear.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/localeData.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/locale/ru.js"></script>
  <script>
    // Load required Day.js plugins
    dayjs.extend(window.dayjs_plugin_weekOfYear);
    dayjs.extend(window.dayjs_plugin_localeData);
    dayjs.locale('ru');
    
    // State management
    let currentBudgetMonth = dayjs().startOf('month');
    let currentPlannerMonth = dayjs().startOf('month');
    let currentView = 'month';
    let editingTransactionId = null;
    let editingShoppingItemId = null;
    let editingEventId = null;
    let editingCategoryId = null;
    let selectedDate = dayjs();
    
    // Mock data
    const transactions = [
      { id: 1, date: dayjs('2025-10-17'), type: 'expense', amount: 2450, category: 'Продукты', description: 'Продукты' },
      { id: 2, date: dayjs('2025-10-09'), type: 'income', amount: 45000, category: 'Доход', description: 'Зарплата' },
      { id: 3, date: dayjs('2025-10-07'), type: 'expense', amount: 1200, category: 'Здоровье', description: 'Аптека' }
    ];
    
    const shoppingItems = [
      { id: 1, name: 'Молоко', quantity: 1, unit: 'pcs', isBought: false, category: 'Продукты' },
      { id: 2, name: 'Хлеб', quantity: 2, unit: 'pcs', isBought: false, category: 'Продукты' },
      { id: 3, name: 'Яйца', quantity: 10, unit: 'pcs', isBought: true, category: 'Продукты' },
      { id: 4, name: 'Сыр', quantity: 0.5, unit: 'kg', isBought: false, category: 'Продукты' }
    ];
    
    const participants = [
      { id: 1, name: 'Анна', color: '#4361ee' },
      { id: 2, name: 'Иван', color: '#06d6a0' }
    ];
    
    const events = [
      { id: 1, title: 'Ужин', start: dayjs('2025-12-07T19:00:00'), end: dayjs('2025-12-07T21:00:00'), participantIds: [1] },
      { id: 2, title: 'Фильм', start: dayjs('2025-12-09T20:00:00'), end: dayjs('2025-12-09T22:00:00'), participantIds: [2] }
    ];
    
    const categories = [
      { id: 1, name: 'Продукты', color: '#4361ee' },
      { id: 2, name: 'Транспорт', color: '#06d6a0' },
      { id: 3, name: 'Жильё', color: '#ef476f' },
      { id: 4, name: 'Здоровье', color: '#ffd166' },
      { id: 5, name: 'Развлечения', color: '#118ab2' },
      { id: 6, name: 'Доход', color: '#073b4c' }
    ];
    
    // Settings
    let settings = {
      notificationsEnabled: true,
      familyMembers: [...participants],
      categories: [...categories],
      autoCompleteShopping: true,
      sortShoppingByCategory: false,
      telegramToken: '',
      telegramChatId: ''
    };
    
    // Load settings from localStorage
    function loadSettings() {
      const savedSettings = localStorage.getItem('budgetAppSettings');
      if (savedSettings) {
        const parsedSettings = JSON.parse(savedSettings);
        // Preserve existing categories but keep their colors
        if (parsedSettings.categories) {
          parsedSettings.categories.forEach(savedCat => {
            const existingCat = settings.categories.find(c => c.id === savedCat.id);
            if (existingCat) {
              existingCat.color = savedCat.color;
            }
          });
        }
        
        settings = {...settings, ...parsedSettings};
      }
    }
    
    // Save settings to localStorage
    function saveSettings() {
      localStorage.setItem('budgetAppSettings', JSON.stringify(settings));
    }
    
    // Initialize settings
    loadSettings();
    
    // DOM Elements
    const budgetTab = document.getElementById('budgetTab');
    const shoppingTab = document.getElementById('shoppingTab');
    const plannerTab = document.getElementById('plannerTab');
    const budgetCalendarTitle = document.getElementById('budgetCalendarTitle');
    const budgetCalendarBody = document.getElementById('budgetCalendarBody');
    const categoriesList = document.getElementById('categoriesList');
    const transactionsList = document.getElementById('transactionsList');
    const shoppingList = document.getElementById('shoppingList');
    const topShoppingList = document.getElementById('topShoppingList');
    const plannerCalendar = document.getElementById('plannerCalendar');
    const plannerCalendarContainer = document.getElementById('plannerCalendarContainer');
    const plannerCalendarTitle = document.getElementById('plannerCalendarTitle');
    const eventsList = document.getElementById('eventsList');
    const eventsListSection = document.getElementById('eventsListSection');
    const fileNameElement = document.getElementById('fileName');
    const uploadTextElement = document.getElementById('uploadText');
    
    // Modals
    const transactionModal = document.getElementById('transactionModal');
    const shoppingItemModal = document.getElementById('shoppingItemModal');
    const eventModal = document.getElementById('eventModal');
    const settingsModal = document.getElementById('settingsModal');
    const addParticipantModal = document.getElementById('addParticipantModal');
    const editCategoryModal = document.getElementById('editCategoryModal');
    const notification = document.getElementById('notification');
    const fileUpload = document.getElementById('fileUpload');
    
    // Initialize the app
    function init() {
      renderBudgetMonth();
      renderCategories();
      renderTransactions();
      renderShoppingList();
      renderTopShoppingList();
      renderPlanner();
      renderEventsList();
      setupEventListeners();
    }
    
    // Render budget calendar
    function renderBudgetMonth() {
      const year = currentBudgetMonth.year();
      const month = currentBudgetMonth.month();
      budgetCalendarTitle.textContent = currentBudgetMonth.format('MMMM YYYY');
      
      // Clear existing calendar
      budgetCalendarBody.innerHTML = '';
      
      // Get first day of month and last day
      const firstDay = currentBudgetMonth.startOf('month');
      const lastDay = currentBudgetMonth.endOf('month');
      const startDate = firstDay.startOf('week');
      
      // Create calendar rows
      let date = startDate;
      for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('td');
          const dayNum = date.date();
          const isCurrentMonth = date.month() === month;
          const isToday = date.isSame(dayjs(), 'day') && date.month() === month && date.year() === currentBudgetMonth.year();
          
          if (!isCurrentMonth) {
            cell.classList.add('inactive');
          }
          
          // Calculate total expenses for this day
          const dayTransactions = transactions.filter(tx =>
            tx.date.date() === dayNum &&
            tx.date.month() === month &&
            tx.date.year() === year
          );
          
          const totalExpenses = dayTransactions.reduce((sum, tx) => sum + (tx.type === 'expense' ? tx.amount : 0), 0);
          const hasTransactions = dayTransactions.length > 0;
          
          cell.innerHTML = `
            <div class="calendar-date ${isCurrentMonth ? '' : 'text-gray-400'} ${hasTransactions ? 'has-transaction' : ''} ${isToday ? 'bg-blue-100 text-blue-800' : ''}">
              ${dayNum}
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
              ${totalExpenses > 0 ? totalExpenses.toLocaleString('ru-RU') + ' ₽' : ''}
            </div>
          `;
          
          cell.dataset.date = date.format('YYYY-MM-DD');
          cell.addEventListener('click', () => {
            const clickedDate = dayjs(cell.dataset.date);
            openTransactionModal(null, clickedDate);
          });
          
          row.appendChild(cell);
          date = date.add(1, 'day');
        }
        
        budgetCalendarBody.appendChild(row);
        
        // Stop if we've passed the end of the month
        if (date.month() > month && date.date() > 7) break;
      }
    }
    
    // Render categories
    function renderCategories() {
      categoriesList.innerHTML = '';
      
      settings.categories.forEach(category => {
        const catTransactions = transactions.filter(tx => tx.category === category.name);
        const amount = catTransactions.reduce((sum, tx) => {
          return sum + (tx.type === 'income' ? tx.amount : -tx.amount);
        }, 0);
        
        const item = document.createElement('div');
        item.className = 'category-item';
        item.dataset.categoryId = category.id;
        item.innerHTML = `
          <div class="category-name" style="display: flex; align-items: center; gap: 8px;">
            <span class="participant-color" style="background-color: ${category.color};"></span>
            ${category.name}
          </div>
          <div class="category-amount ${amount >= 0 ? 'positive' : 'negative'}">
            ${amount >= 0 ? '+' : ''}${amount.toLocaleString('ru-RU')} ₽
          </div>
        `;
        
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          editingCategoryId = category.id;
          openEditCategoryModal(category);
        });
        
        categoriesList.appendChild(item);
      });
    }
    
    // Render transactions
    function renderTransactions() {
      transactionsList.innerHTML = '';
      
      const sortedTransactions = [...transactions].sort((a, b) => b.date.unix() - a.date.unix());
      
      sortedTransactions.forEach(tx => {
        const row = document.createElement('tr');
        row.className = 'transaction-row';
        row.innerHTML = `
          <td>${tx.date.format('DD.MM.YYYY')}</td>
          <td>${tx.description}</td>
          <td>
            <span style="display: flex; align-items: center; gap: 6px;">
              <span class="participant-color" style="background-color: ${getCategoryColor(tx.category)};"></span>
              ${tx.category}
            </span>
          </td>
          <td class="transaction-amount ${tx.type === 'income' ? 'positive' : 'negative'}">
            ${tx.type === 'income' ? '+' : '-'}${tx.amount.toLocaleString('ru-RU')} ₽
          </td>
          <td class="transaction-balance">${calculateBalanceAfter(tx.id).toLocaleString('ru-RU')} ₽</td>
        `;
        
        row.addEventListener('click', () => openTransactionModal(tx));
        transactionsList.appendChild(row);
      });
    }
    
    // Get category color
    function getCategoryColor(categoryName) {
      const category = settings.categories.find(cat => cat.name === categoryName);
      return category ? category.color : '#4361ee';
    }
    
    // Render shopping list
    function renderShoppingList() {
      shoppingList.innerHTML = '';
      
      // Sort items: not bought first, bought last
      const sortedItems = [...shoppingItems].sort((a, b) => {
        if (a.isBought === b.isBought) return 0;
        return a.isBought ? 1 : -1;
      });
      
      sortedItems.forEach(item => {
        const li = document.createElement('li');
        li.className = `shopping-item ${item.isBought ? 'bought' : ''}`;
        li.dataset.itemId = item.id;
        
        li.innerHTML = `
          <input type="checkbox" class="item-checkbox" ${item.isBought ? 'checked' : ''}>
          <div class="item-name" ${item.isBought ? 'style="text-decoration: line-through; color: #94a3b8;"' : ''}>
            ${item.name}
          </div>
          <div class="item-quantity">${item.quantity} ${getUnitLabel(item.unit, item.quantity)}</div>
        `;
        
        // Event listeners
        const checkbox = li.querySelector('.item-checkbox');
        const nameElement = li.querySelector('.item-name');
        
        li.addEventListener('click', (e) => {
          if (e.target !== checkbox) {
            openShoppingItemModal(item);
          }
        });
        
        checkbox.addEventListener('change', () => {
          item.isBought = checkbox.checked;
          if (checkbox.checked) {
            nameElement.style.textDecoration = 'line-through';
            nameElement.style.color = '#94a3b8';
            li.classList.add('bought');
          } else {
            nameElement.style.textDecoration = 'none';
            nameElement.style.color = '';
            li.classList.remove('bought');
          }
          
          showNotification(checkbox.checked ? 'Товар отмечен как купленный' : 'Товар возвращен в список');
          renderShoppingList(); // Re-sort the list
        });
        
        shoppingList.appendChild(li);
      });
    }
    
    // Render top shopping list
    function renderTopShoppingList() {
      topShoppingList.innerHTML = '';
      
      const groupedItems = {};
      shoppingItems.forEach(item => {
        if (groupedItems[item.name]) {
          groupedItems[item.name].quantity += item.quantity;
        } else {
          groupedItems[item.name] = {
            name: item.name,
            quantity: item.quantity,
            unit: item.unit
          };
        }
      });
      
      const sortedItems = Object.values(groupedItems).sort((a, b) => b.quantity - a.quantity);
      
      sortedItems.slice(0, 10).forEach(item => {
        const div = document.createElement('div');
        div.className = 'category-item';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <span>${item.name}</span>
            <span style="color: var(--text-secondary);">${item.quantity} ${getUnitLabel(item.unit, item.quantity)}</span>
          </div>
        `;
        
        div.addEventListener('click', () => {
          document.getElementById('itemName').value = item.name;
          showNotification(`Выбрано: ${item.name}`);
        });
        
        topShoppingList.appendChild(div);
      });
    }
    
    // Render planner based on current view
    function renderPlanner() {
      if (currentView === 'day') {
        renderPlannerDay();
      } else if (currentView === 'week') {
        renderPlannerWeek();
      } else {
        renderPlannerMonth();
      }
    }
    
    // Render planner for month view
    function renderPlannerMonth() {
      const year = currentPlannerMonth.year();
      const month = currentPlannerMonth.month();
      plannerCalendarTitle.textContent = currentPlannerMonth.format('MMMM YYYY');
      
      // Clear existing calendar
      plannerCalendar.innerHTML = '';
      
      // Add header
      ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
        const headerCell = document.createElement('div');
        headerCell.className = 'calendar-header-cell';
        headerCell.textContent = day;
        plannerCalendar.appendChild(headerCell);
      });
      
      // Get first day of month and last day
      const firstDay = currentPlannerMonth.startOf('month');
      const lastDay = currentPlannerMonth.endOf('month');
      const startDate = firstDay.startOf('week');
      
      // Create calendar days
      let date = startDate;
      for (let i = 0; i < 42; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        const dayNum = date.date();
        const isCurrentMonth = date.month() === month;
        const isToday = date.isSame(dayjs(), 'day') && date.month() === month && date.year() === currentPlannerMonth.year();
        
        dayCell.innerHTML = `
          <div class="calendar-date-number ${isCurrentMonth ? '' : 'text-gray-400'} ${isToday ? 'text-blue-600 font-bold' : ''}">
            ${dayNum}
          </div>
        `;
        
        // Add events for this day
        const dayEvents = events.filter(e =>
          e.start.date() === dayNum &&
          e.start.month() === month &&
          e.start.year() === year
        );
        
        dayEvents.forEach(event => {
          const participant = participants.find(p => p.id === event.participantIds[0]);
          const eventColor = participant ? participant.color : '#4361ee';
          
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event-item';
          eventDiv.style.borderLeftColor = eventColor;
          eventDiv.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${formatTime(event.start)}</div>
          `;
          
          eventDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            openEventModal(event);
          });
          
          dayCell.appendChild(eventDiv);
        });
        
        dayCell.dataset.date = date.format('YYYY-MM-DD');
        dayCell.addEventListener('click', () => {
          selectedDate = date;
          openEventModal(null, date);
          renderEventsList();
        });
        
        if (!isCurrentMonth) {
          dayCell.style.opacity = '0.5';
        }
        
        plannerCalendar.appendChild(dayCell);
        date = date.add(1, 'day');
        
        // Stop if we've passed the end of the month and have 6 full weeks
        if (i >= 34 && date.month() > month) break;
      }
    }
    
    // Render planner for week view
    function renderPlannerWeek() {
      const currentDate = selectedDate.startOf('week');
      plannerCalendarTitle.textContent = `Неделя ${currentDate.format('DD')} - ${currentDate.add(6, 'day').format('DD MMMM YYYY')}`;
      
      // Clear existing calendar
      plannerCalendar.innerHTML = '';
      
      // Add header
      for (let i = 0; i < 7; i++) {
        const day = currentDate.add(i, 'day');
        const isToday = day.isSame(dayjs(), 'day');
        const headerCell = document.createElement('div');
        headerCell.className = 'calendar-header-cell';
        headerCell.innerHTML = `
          <div>${day.format('ddd')}</div>
          <div class="${isToday ? 'text-blue-600 font-bold' : ''}">${day.format('DD')}</div>
        `;
        plannerCalendar.appendChild(headerCell);
      }
      
      // Create day cells for the week
      for (let i = 0; i < 7; i++) {
        const dayDate = currentDate.add(i, 'day');
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        const isToday = dayDate.isSame(dayjs(), 'day');
        
        if (isToday) {
          dayCell.style.background = 'rgba(67, 97, 238, 0.1)';
          dayCell.style.borderRadius = '8px';
        }
        
        // Add events for this day
        const dayEvents = events.filter(e =>
          e.start.date() === dayDate.date() &&
          e.start.month() === dayDate.month() &&
          e.start.year() === dayDate.year()
        );
        
        dayEvents.forEach(event => {
          const participant = participants.find(p => p.id === event.participantIds[0]);
          const eventColor = participant ? participant.color : '#4361ee';
          
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event-item';
          eventDiv.style.borderLeftColor = eventColor;
          eventDiv.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${formatTime(event.start)}</div>
          `;
          
          eventDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            openEventModal(event);
          });
          
          dayCell.appendChild(eventDiv);
        });
        
        dayCell.dataset.date = dayDate.format('YYYY-MM-DD');
        dayCell.addEventListener('click', () => {
          selectedDate = dayDate;
          openEventModal(null, dayDate);
          renderEventsList();
        });
        
        plannerCalendar.appendChild(dayCell);
      }
    }
    
    // Render planner for day view
    function renderPlannerDay() {
      const dayDate = selectedDate;
      plannerCalendarTitle.textContent = dayDate.format('dddd, DD MMMM YYYY');
      
      // Clear existing calendar
      plannerCalendarContainer.innerHTML = `
        <div class="day-view-container">
          <div class="time-column" id="timeColumn"></div>
          <div class="events-container" id="dayEventsContainer">
            <div id="dayGrid" style="position: relative; height: 100%;"></div>
          </div>
        </div>
      `;
      
      const dayGrid = document.getElementById('dayGrid');
      const timeColumn = document.getElementById('timeColumn');
      const dayEventsContainer = document.getElementById('dayEventsContainer');
      
      // Set height based on time range
      const startHour = 8; // Default start hour
      const endHour = 22; // Default end hour
      const hoursToShow = endHour - startHour;
      
      dayEventsContainer.style.height = `${hoursToShow * 60}px`;
      dayGrid.style.height = `${hoursToShow * 60}px`;
      
      // Create time slots
      for (let hour = startHour; hour <= endHour; hour++) {
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
        timeColumn.appendChild(timeSlot);
        
        if (hour < endHour) {
          const hourRow = document.createElement('div');
          hourRow.className = 'hour-row';
          hourRow.dataset.hour = hour;
          dayGrid.appendChild(hourRow);
        }
      }
      
      // Add events
      const dayEvents = events.filter(e => 
        e.start.date() === dayDate.date() &&
        e.start.month() === dayDate.month() &&
        e.start.year() === dayDate.year()
      );
      
      dayEvents.forEach(event => {
        const participant = participants.find(p => p.id === event.participantIds[0]);
        const eventColor = participant ? participant.color : '#4361ee';
        
        const startHour = event.start.hour();
        const startMinute = event.start.minute();
        const endHour = event.end ? event.end.hour() : startHour + 1;
        const endMinute = event.end ? event.end.minute() : 0;
        
        const topPosition = (startHour - startHour) * 60 + startMinute;
        const duration = ((endHour - startHour) * 60) + (endMinute - startMinute);
        const height = Math.max(30, duration); // Minimum height of 30px
        
        const eventElement = document.createElement('div');
        eventElement.className = 'day-event';
        eventElement.style.top = `${topPosition}px`;
        eventElement.style.height = `${height}px`;
        eventElement.style.backgroundColor = `${eventColor}15`; // Add transparency
        eventElement.style.borderColor = eventColor;
        eventElement.style.borderLeftWidth = '3px';
        
        eventElement.innerHTML = `
          <div class="day-event-title">${event.title}</div>
          <div class="day-event-time">
            ${formatTime(event.start)} ${event.end ? '- ' + formatTime(event.end) : ''}
            ${participant ? `<span style="color: ${eventColor}; margin-left: 8px;">${participant.name}</span>` : ''}
          </div>
        `;
        
        eventElement.addEventListener('click', () => openEventModal(event));
        dayGrid.appendChild(eventElement);
      });
      
      // Handle clicks on empty time slots
      dayGrid.addEventListener('click', (e) => {
        if (e.target === dayGrid) {
          const rect = dayGrid.getBoundingClientRect();
          const y = e.clientY - rect.top;
          const hour = startHour + Math.floor(y / 60);
          const minute = Math.round((y % 60) / 15) * 15; // Round to nearest 15 minutes
          
          const clickDate = dayDate.hour(hour).minute(minute);
          openEventModal(null, clickDate);
        }
      });
    }
    
    // Render events list
    function renderEventsList() {
      eventsList.innerHTML = '';
      
      let filteredEvents = [];
      
      if (currentView === 'month') {
        const year = currentPlannerMonth.year();
        const month = currentPlannerMonth.month();
        filteredEvents = events.filter(e =>
          e.start.year() === year &&
          e.start.month() === month
        );
      } else if (currentView === 'week') {
        const weekStart = selectedDate.startOf('week');
        const weekEnd = weekStart.add(6, 'day');
        filteredEvents = events.filter(e =>
          e.start.isAfter(weekStart.subtract(1, 'day')) &&
          e.start.isBefore(weekEnd.add(1, 'day'))
        );
      } else {
        const dayStart = selectedDate.startOf('day');
        const dayEnd = selectedDate.endOf('day');
        filteredEvents = events.filter(e =>
          e.start.isAfter(dayStart.subtract(1, 'day')) &&
          e.start.isBefore(dayEnd.add(1, 'day'))
        );
      }
      
      filteredEvents.sort((a, b) => a.start.unix() - b.start.unix());
      
      if (filteredEvents.length === 0) {
        eventsList.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">Нет событий</div>';
        return;
      }
      
      filteredEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'category-item';
        
        const participant = participants.find(p => p.id === event.participantIds[0]);
        const eventColor = participant ? participant.color : '#4361ee';
        
        eventDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="participant-color" style="background-color: ${eventColor};"></div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--text);">${event.title}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">
                ${event.start.format('DD.MM.YYYY, HH:mm')} ${event.end ? '- ' + event.end.format('HH:mm') : ''}
                ${participant ? ` | ${participant.name}` : ''}
              </div>
            </div>
          </div>
        `;
        
        eventDiv.addEventListener('click', () => openEventModal(event));
        eventsList.appendChild(eventDiv);
      });
    }
    
    // Open edit category modal
    function openEditCategoryModal(category) {
      if (!category) {
        document.getElementById('editCategoryTitle').textContent = 'Новая категория';
        document.getElementById('editCategoryName').value = '';
        document.getElementById('categoryColorPicker').value = '#4361ee';
        editingCategoryId = null;
      } else {
        document.getElementById('editCategoryTitle').textContent = 'Редактировать категорию';
        document.getElementById('editCategoryName').value = category.name;
        document.getElementById('categoryColorPicker').value = category.color;
        editingCategoryId = category.id;
      }
      
      // Setup color options
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', () => {
          document.getElementById('categoryColorPicker').value = option.dataset.color;
        });
      });
      
      editCategoryModal.classList.add('active');
    }
    
    // Save category
    function saveCategory() {
      const name = document.getElementById('editCategoryName').value.trim();
      const color = document.getElementById('categoryColorPicker').value;
      
      if (!name) {
        showNotification('Пожалуйста, введите название категории');
        return;
      }
      
      if (editingCategoryId) {
        // Update existing category
        const categoryIndex = settings.categories.findIndex(c => c.id === editingCategoryId);
        if (categoryIndex !== -1) {
          settings.categories[categoryIndex] = {
            ...settings.categories[categoryIndex],
            name,
            color
          };
          showNotification('Категория обновлена');
        }
      } else {
        // Add new category
        const newCategory = {
          id: Date.now(),
          name,
          color
        };
        settings.categories.push(newCategory);
        showNotification('Категория добавлена');
      }
      
      renderCategories();
      saveSettings();
      editCategoryModal.classList.remove('active');
    }
    
    // Open transaction modal
    function openTransactionModal(transaction = null, date = null) {
      editingTransactionId = transaction ? transaction.id : null;
      
      document.getElementById('transactionModalTitle').textContent =
        transaction ? 'Редактировать операцию' : 'Новая операция';
      
      if (transaction) {
        document.getElementById('transactionAmount').value = transaction.amount;
        document.getElementById('transactionCategory').value = transaction.category;
        document.getElementById('transactionDescription').value = transaction.description;
        document.getElementById('transactionDate').value = transaction.date.format('YYYY-MM-DD');
        
        if (transaction.type === 'income') {
          document.getElementById('incomeTypeBtn').classList.add('active');
          document.getElementById('expenseTypeBtn').classList.remove('active');
        } else {
          document.getElementById('expenseTypeBtn').classList.add('active');
          document.getElementById('incomeTypeBtn').classList.remove('active');
        }
      } else {
        document.getElementById('transactionAmount').value = '';
        document.getElementById('transactionCategory').value = 'Продукты';
        document.getElementById('transactionDescription').value = '';
        document.getElementById('transactionDate').value = date ? date.format('YYYY-MM-DD') : dayjs().format('YYYY-MM-DD');
        document.getElementById('incomeTypeBtn').classList.remove('active');
        document.getElementById('expenseTypeBtn').classList.add('active');
      }
      
      transactionModal.classList.add('active');
    }
    
    // Open shopping item modal
    function openShoppingItemModal(item) {
      editingShoppingItemId = item.id;
      document.getElementById('editItemName').value = item.name;
      document.getElementById('editItemQuantity').value = item.quantity;
      document.getElementById('editItemUnit').value = item.unit;
      document.getElementById('editItemBought').checked = item.isBought;
      shoppingItemModal.classList.add('active');
    }
    
    // Open event modal
    function openEventModal(event = null, date = null) {
      editingEventId = event ? event.id : null;
      
      if (event) {
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventStart').value = event.start.format('YYYY-MM-DDTHH:mm');
        document.getElementById('eventEnd').value = event.end ? event.end.format('YYYY-MM-DDTHH:mm') : '';
        document.getElementById('isTemplate').checked = false;
        document.getElementById('templateName').style.display = 'none';
      } else {
        document.getElementById('eventTitle').value = '';
        if (date) {
          const start = date;
          const end = date.add(1, 'hour');
          
          document.getElementById('eventStart').value = start.format('YYYY-MM-DDTHH:mm');
          document.getElementById('eventEnd').value = end.format('YYYY-MM-DDTHH:mm');
        } else {
          const now = dayjs();
          document.getElementById('eventStart').value = now.format('YYYY-MM-DDTHH:mm');
          document.getElementById('eventEnd').value = now.add(1, 'hour').format('YYYY-MM-DDTHH:mm');
        }
        document.getElementById('isTemplate').checked = false;
        document.getElementById('templateName').style.display = 'none';
      }
      
      // Render participants
      const participantSelection = document.getElementById('participantSelection');
      participantSelection.innerHTML = '';
      
      participants.forEach(participant => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline participant-btn';
        btn.innerHTML = `
          <span class="participant-color" style="background-color: ${participant.color};"></span>
          ${participant.name}
        `;
        
        if (event && event.participantIds.includes(participant.id)) {
          btn.classList.add('active');
        }
        
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
        });
        
        btn.dataset.participantId = participant.id;
        participantSelection.appendChild(btn);
      });
      
      eventModal.classList.add('active');
    }
    
    // Open settings modal
    function openSettingsModal() {
      document.getElementById('notificationsEnabled').checked = settings.notificationsEnabled;
      document.getElementById('autoCompleteShopping').checked = settings.autoCompleteShopping;
      document.getElementById('sortShoppingByCategory').checked = settings.sortShoppingByCategory;
      document.getElementById('telegramToken').value = settings.telegramToken;
      document.getElementById('telegramChatId').value = settings.telegramChatId;
      
      renderFamilyMembers();
      renderSettingsCategories();
      
      settingsModal.classList.add('active');
    }
    
    // Render family members in settings
    function renderFamilyMembers() {
      const familyMembersList = document.getElementById('familyMembersList');
      familyMembersList.innerHTML = '';
      
      settings.familyMembers.forEach(member => {
        const memberDiv = document.createElement('div');
        memberDiv.style.display = 'flex';
        memberDiv.style.alignItems = 'center';
        memberDiv.style.justifyContent = 'space-between';
        memberDiv.style.padding = '8px';
        memberDiv.style.borderBottom = '1px solid var(--border)';
        
        memberDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="participant-color" style="background-color: ${member.color};"></div>
            <span>${member.name}</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-outline edit-member-btn" data-id="${member.id}" style="padding: 4px 8px; font-size: 12px;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline remove-member-btn" data-id="${member.id}" style="padding: 4px 8px; font-size: 12px;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        familyMembersList.appendChild(memberDiv);
      });
      
      // Add event listeners
      document.querySelectorAll('.edit-member-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const memberId = parseInt(e.currentTarget.dataset.id);
          const member = settings.familyMembers.find(m => m.id === memberId);
          if (member) {
            document.getElementById('newParticipantName').value = member.name;
            document.getElementById('customColorPicker').value = member.color;
            editingParticipantId = memberId;
            addParticipantModal.classList.add('active');
          }
        });
      });
      
      document.querySelectorAll('.remove-member-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const memberId = parseInt(e.currentTarget.dataset.id);
          removeFamilyMember(memberId);
        });
      });
    }
    
    // Render categories in settings
    function renderSettingsCategories() {
      const categoriesListSettings = document.getElementById('categoriesListSettings');
      categoriesListSettings.innerHTML = '';
      
      settings.categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.style.display = 'flex';
        categoryDiv.style.alignItems = 'center';
        categoryDiv.style.justifyContent = 'space-between';
        categoryDiv.style.padding = '8px';
        categoryDiv.style.borderBottom = '1px solid var(--border)';
        
        categoryDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="participant-color" style="background-color: ${category.color};"></div>
            <span>${category.name}</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-outline edit-category-btn" data-id="${category.id}" style="padding: 4px 8px; font-size: 12px;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline remove-category-btn" data-id="${category.id}" style="padding: 4px 8px; font-size: 12px;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        categoriesListSettings.appendChild(categoryDiv);
      });
      
      // Add event listeners
      document.querySelectorAll('.edit-category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const categoryId = parseInt(e.currentTarget.dataset.id);
          const category = settings.categories.find(c => c.id === categoryId);
          if (category) {
            openEditCategoryModal(category);
          }
        });
      });
      
      document.querySelectorAll('.remove-category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const categoryId = parseInt(e.currentTarget.dataset.id);
          removeCategory(categoryId);
        });
      });
    }
    
    // Remove family member
    function removeFamilyMember(id) {
      settings.familyMembers = settings.familyMembers.filter(m => m.id !== id);
      renderFamilyMembers();
    }
    
    // Add/edit family member
    function saveParticipant() {
      const name = document.getElementById('newParticipantName').value.trim();
      const color = document.getElementById('customColorPicker').value;
      
      if (!name) {
        showNotification('Пожалуйста, введите имя участника');
        return;
      }
      
      if (editingParticipantId) {
        // Update existing member
        const memberIndex = settings.familyMembers.findIndex(m => m.id === editingParticipantId);
        if (memberIndex !== -1) {
          settings.familyMembers[memberIndex] = {
            ...settings.familyMembers[memberIndex],
            name,
            color
          };
          showNotification('Участник обновлен');
        }
      } else {
        // Add new member
        const newMember = {
          id: Date.now(),
          name,
          color
        };
        settings.familyMembers.push(newMember);
        showNotification('Участник добавлен');
      }
      
      renderFamilyMembers();
      saveSettings();
      addParticipantModal.classList.remove('active');
    }
    
    // Remove category
    function removeCategory(id) {
      settings.categories = settings.categories.filter(c => c.id !== id);
      renderSettingsCategories();
      renderCategories();
      saveSettings();
      showNotification('Категория удалена');
    }
    
    // Save event
    function saveEvent() {
      const title = document.getElementById('eventTitle').value.trim();
      
      if (!title) {
        showNotification('Пожалуйста, введите название события');
        return;
      }
      
      const startStr = document.getElementById('eventStart').value;
      if (!startStr) {
        showNotification('Пожалуйста, выберите дату и время начала');
        return;
      }
      
      const start = dayjs(startStr);
      const endStr = document.getElementById('eventEnd').value;
      const end = endStr ? dayjs(endStr) : null;
      
      if (end && end.unix() <= start.unix()) {
        showNotification('Время окончания должно быть позже начала');
        return;
      }
      
      // Get selected participants
      const selectedParticipants = [];
      document.querySelectorAll('.participant-btn.active').forEach(btn => {
        selectedParticipants.push(parseInt(btn.dataset.participantId));
      });
      
      if (selectedParticipants.length === 0) {
        selectedParticipants.push(participants[0].id);
      }
      
      if (editingEventId) {
        // Update existing event
        const eventIndex = events.findIndex(e => e.id === editingEventId);
        if (eventIndex !== -1) {
          events[eventIndex] = {
            ...events[eventIndex],
            title,
            start,
            end,
            participantIds: selectedParticipants
          };
          showNotification('Событие обновлено');
        }
      } else {
        // Add new event
        const newEvent = {
          id: Date.now(),
          title,
          start,
          end,
          participantIds: selectedParticipants
        };
        events.push(newEvent);
        showNotification(`Событие "${title}" создано`);
      }
      
      renderPlanner();
      renderEventsList();
      eventModal.classList.remove('active');
    }
    
    // Show notification
    function showNotification(message) {
      if (!settings.notificationsEnabled) return;
      
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Format time
    function formatTime(date) {
      return date.format('HH:mm');
    }
    
    // Get unit label
    function getUnitLabel(unit, count) {
      const n = Math.abs(count);
      if (unit === 'pcs') {
        if (n % 10 === 1 && n % 100 !== 11) return 'шт.';
        if ([2, 3, 4].includes(n % 10) && ![12, 13, 14].includes(n % 10)) return 'шт.';
        return 'шт.';
      }
      return unit === 'liters' ? 'л' : unit === 'grams' ? 'г' : 'кг';
    }
    
    // Calculate balance after transaction
    function calculateBalanceAfter(transactionId) {
      const targetTransaction = transactions.find(t => t.id === transactionId);
      if (!targetTransaction) {
        return 0;
      }
      
      let balance = 0;
      transactions
        .filter(tx => tx.date.unix() <= targetTransaction.date.unix())
        .forEach(tx => {
          balance += tx.type === 'income' ? tx.amount : -tx.amount;
        });
      
      return balance;
    }
    
    // Handle file upload
    function setupFileUpload() {
      fileUpload.addEventListener('change', function(e) {
        if (this.files && this.files.length > 0) {
          const file = this.files[0];
          fileNameElement.textContent = file.name;
          uploadTextElement.textContent = 'Файл выбран:';
          showNotification('Файл выписки загружен. В реальном приложении здесь будет обработка данных.');
        } else {
          fileNameElement.textContent = '';
          uploadTextElement.textContent = 'Загрузить выписку из банка';
        }
      });
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
          
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(tabId + 'Tab').style.display = 'block';
          
          // Re-render planner when switching to planner tab
          if (tabId === 'planner') {
            renderPlanner();
            renderEventsList();
          }
        });
      });
      
      // Budget calendar navigation
      document.getElementById('prevMonthBtn').addEventListener('click', () => {
        currentBudgetMonth = currentBudgetMonth.subtract(1, 'month');
        renderBudgetMonth();
        renderCategories();
        renderTransactions();
      });
      
      document.getElementById('nextMonthBtn').addEventListener('click', () => {
        currentBudgetMonth = currentBudgetMonth.add(1, 'month');
        renderBudgetMonth();
        renderCategories();
        renderTransactions();
      });
      
      // Planner calendar navigation
      document.getElementById('prevPlannerMonthBtn').addEventListener('click', () => {
        currentPlannerMonth = currentPlannerMonth.subtract(1, 'month');
        selectedDate = currentPlannerMonth;
        renderPlanner();
        renderEventsList();
      });
      
      document.getElementById('nextPlannerMonthBtn').addEventListener('click', () => {
        currentPlannerMonth = currentPlannerMonth.add(1, 'month');
        selectedDate = currentPlannerMonth;
        renderPlanner();
        renderEventsList();
      });
      
      // View switching for planner
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.getAttribute('data-view');
          renderPlanner();
          renderEventsList();
        });
      });
      
      // Close modals
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('.modal').classList.remove('active');
        });
      });
      
      // Cancel buttons
      document.querySelectorAll('.modal-footer .btn-outline').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('.modal').classList.remove('active');
        });
      });
      
      // Save transaction
      document.getElementById('saveTransactionBtn').addEventListener('click', () => {
        const amount = parseFloat(document.getElementById('transactionAmount').value);
        const category = document.getElementById('transactionCategory').value;
        const description = document.getElementById('transactionDescription').value;
        const dateStr = document.getElementById('transactionDate').value;
        const type = document.getElementById('incomeTypeBtn').classList.contains('active') ? 'income' : 'expense';
        
        if (!amount || amount <= 0) {
          showNotification('Пожалуйста, введите сумму больше 0');
          return;
        }
        
        if (editingTransactionId) {
          const index = transactions.findIndex(tx => tx.id === editingTransactionId);
          if (index !== -1) {
            transactions[index] = {
              ...transactions[index],
              amount,
              category,
              description,
              date: dayjs(dateStr)
            };
          }
          showNotification('Операция обновлена');
        } else {
          const newTransaction = {
            id: Date.now(),
            date: dayjs(dateStr),
            type,
            amount,
            category,
            description
          };
          transactions.push(newTransaction);
          showNotification('Операция добавлена');
        }
        
        renderBudgetMonth();
        renderCategories();
        renderTransactions();
        transactionModal.classList.remove('active');
      });
      
      // Save shopping item
      document.getElementById('saveShoppingItemBtn').addEventListener('click', () => {
        const name = document.getElementById('editItemName').value.trim();
        const quantity = parseFloat(document.getElementById('editItemQuantity').value);
        const unit = document.getElementById('editItemUnit').value;
        const isBought = document.getElementById('editItemBought').checked;
        
        if (!name) {
          showNotification('Пожалуйста, введите название товара');
          return;
        }
        
        if (!quantity || quantity <= 0) {
          showNotification('Количество должно быть больше 0');
          return;
        }
        
        const item = shoppingItems.find(i => i.id === editingShoppingItemId);
        if (item) {
          item.name = name;
          item.quantity = quantity;
          item.unit = unit;
          item.isBought = isBought;
          renderShoppingList();
          renderTopShoppingList();
          showNotification('Товар обновлен');
        }
        
        shoppingItemModal.classList.remove('active');
      });
      
      // Add shopping item
      document.getElementById('addItemBtn').addEventListener('click', () => {
        const name = document.getElementById('itemName').value.trim();
        const quantity = parseFloat(document.getElementById('itemQuantity').value);
        const unit = document.getElementById('itemUnit').value;
        
        if (!name) {
          showNotification('Пожалуйста, введите название товара');
          return;
        }
        
        if (!quantity || quantity <= 0) {
          showNotification('Количество должно быть больше 0');
          return;
        }
        
        const newItem = {
          id: Date.now(),
          name,
          quantity,
          unit,
          isBought: false,
          category: 'Продукты'
        };
        
        shoppingItems.push(newItem);
        renderShoppingList();
        renderTopShoppingList();
        showNotification(`Добавлено: ${name}`);
        
        // Clear form
        document.getElementById('itemName').value = '';
        document.getElementById('itemQuantity').value = '1';
      });
      
      // Add event button
      document.getElementById('addEventBtn').addEventListener('click', () => {
        openEventModal();
      });
      
      // Save event button
      document.getElementById('saveEventBtn').addEventListener('click', saveEvent);
      
      // Copy event button
      document.getElementById('copyEventBtn').addEventListener('click', () => {
        if (editingEventId) {
          const originalEvent = events.find(e => e.id === editingEventId);
          if (originalEvent) {
            const newEvent = {
              ...originalEvent,
              id: Date.now(),
              title: originalEvent.title + ' (копия)'
            };
            
            openEventModal(newEvent);
            showNotification('Событие скопировано');
          }
        } else {
          // Copy current form data
          const title = document.getElementById('eventTitle').value;
          const start = dayjs(document.getElementById('eventStart').value);
          const end = document.getElementById('eventEnd').value ? dayjs(document.getElementById('eventEnd').value) : null;
          
          if (!title || !start.isValid()) {
            showNotification('Заполните форму перед копированием');
            return;
          }
          
          const newEvent = {
            id: Date.now(),
            title: title + ' (копия)',
            start: dayjs(start),
            end: end ? dayjs(end) : null,
            participantIds: []
          };
          
          // Get selected participants
          document.querySelectorAll('.participant-btn.active').forEach(btn => {
            newEvent.participantIds.push(parseInt(btn.dataset.participantId));
          });
          
          openEventModal(newEvent);
          showNotification('Событие скопировано');
        }
      });
      
      // Settings button
      document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
      
      // Save settings button
      document.getElementById('saveSettingsBtn').addEventListener('click', () => {
        settings.notificationsEnabled = document.getElementById('notificationsEnabled').checked;
        settings.autoCompleteShopping = document.getElementById('autoCompleteShopping').checked;
        settings.sortShoppingByCategory = document.getElementById('sortShoppingByCategory').checked;
        settings.telegramToken = document.getElementById('telegramToken').value;
        settings.telegramChatId = document.getElementById('telegramChatId').value;
        
        saveSettings();
        showNotification('Настройки сохранены');
        settingsModal.classList.remove('active');
      });
      
      // Add family member button
      document.getElementById('addFamilyMemberBtn').addEventListener('click', () => {
        document.getElementById('newParticipantName').value = '';
        document.getElementById('customColorPicker').value = '#4361ee';
        editingParticipantId = null;
        addParticipantModal.classList.add('active');
      });
      
      // Save participant button
      document.getElementById('saveParticipantBtn').addEventListener('click', saveParticipant);
      
      // Add category button
      document.getElementById('addCategoryBtn').addEventListener('click', () => {
        openEditCategoryModal(null);
      });
      
      // Save category button
      document.getElementById('saveEditCategoryBtn').addEventListener('click', saveCategory);
      
      // File upload
      setupFileUpload();
      
      // Income/Expense type buttons
      document.getElementById('incomeTypeBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('expenseTypeBtn').classList.remove('active');
      });
      
      document.getElementById('expenseTypeBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('incomeTypeBtn').classList.remove('active');
      });
      
      // Add income/expense buttons
      document.getElementById('addIncomeBtn').addEventListener('click', () => {
        openTransactionModal(null);
        document.getElementById('incomeTypeBtn').classList.add('active');
        document.getElementById('expenseTypeBtn').classList.remove('active');
      });
      
      document.getElementById('addExpenseBtn').addEventListener('click', () => {
        openTransactionModal(null);
        document.getElementById('expenseTypeBtn').classList.add('active');
        document.getElementById('incomeTypeBtn').classList.remove('active');
      });
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>