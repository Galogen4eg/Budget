<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Семейный бюджет</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Все CSS стили остаются без изменений */
    :root {
      --primary: #3b82f6;
      --primary-light: #bfdbfe;
      --secondary: #10b981;
      --accent: #8b5cf6;
      --warning: #f59e0b;
      --danger: #ef4444;
      --success: #22c55e;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f8fafc;
      color: var(--gray-800);
      line-height: 1.5;
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }
    
    /* Все остальные стили остаются без изменений */
  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div class="auth-modal" id="auth-modal">
    <div class="auth-card">
      <div class="auth-logo">
        <i class="fas fa-home"></i>
      </div>
      <h2 class="auth-title">Семейный бюджет</h2>
      <p class="auth-subtitle">Войдите в свою комнату или создайте новую</p>
      
      <div class="form-group">
        <label class="form-label" for="room-name">Название комнаты</label>
        <input type="text" id="room-name" class="form-input" placeholder="Например: Семья Ивановых" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="room-password">Пароль</label>
        <input type="password" id="room-password" class="form-input" placeholder="Введите пароль" required>
      </div>
      
      <button class="auth-btn" id="login-btn">
        <i class="fas fa-door-open"></i> Войти в комнату
      </button>
      
      <div class="auth-separator">
        <span>или</span>
      </div>
      
      <button class="auth-btn" style="background: linear-gradient(135deg, var(--secondary), #0da271);" id="create-room-btn">
        <i class="fas fa-plus-circle"></i> Создать новую комнату
      </button>
    </div>
  </div>

  <!-- Все остальные элементы HTML остаются без изменений -->
  
  <script>
    // State variables
    let currentRoomId = null;
    let currentRoomName = null;
    let currentRoomPassword = null;
    let transactions = [];
    let shoppingItemsList = [];
    let events = [];
    
    // DOM Elements
    const authModal = document.getElementById('auth-modal');
    const loginBtn = document.getElementById('login-btn');
    const createRoomBtn = document.getElementById('create-room-btn');
    const roomNameInput = document.getElementById('room-name');
    const roomPasswordInput = document.getElementById('room-password');
    const currentRoomElement = document.getElementById('current-room');
    const currentRoomSettings = document.getElementById('current-room-settings');
    const logoutBtn = document.getElementById('logout-btn');
    
    // Generate room ID using a hash function that works with any characters
    function generateRoomId(roomName, password) {
      const combined = roomName + ':' + password;
      let hash = 0;
      for (let i = 0; i < combined.length; i++) {
        const char = combined.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash).toString(16);
    }

    // Check if we can use localStorage
    let canUseLocalStorage = true;
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
    } catch (e) {
      canUseLocalStorage = false;
      console.warn('localStorage is not available. Using in-memory storage.');
    }

    // Load data from storage
    function loadData() {
      if (canUseLocalStorage) {
        const savedRoomId = localStorage.getItem('currentRoomId');
        const savedRoomName = localStorage.getItem('currentRoomName');
        const savedRoomPassword = localStorage.getItem('currentRoomPassword');
        
        if (savedRoomId && savedRoomName && savedRoomPassword) {
          currentRoomId = savedRoomId;
          currentRoomName = savedRoomName;
          currentRoomPassword = savedRoomPassword;
          currentRoomElement.textContent = currentRoomName;
          currentRoomSettings.textContent = currentRoomName;
          authModal.classList.remove('active');
          loadRoomData();
        }
      }
    }

    // Save current room info to storage
    function saveCurrentRoom() {
      if (canUseLocalStorage) {
        localStorage.setItem('currentRoomId', currentRoomId);
        localStorage.setItem('currentRoomName', currentRoomName);
        localStorage.setItem('currentRoomPassword', currentRoomPassword);
      }
    }

    // Load room data from storage
    function loadRoomData() {
      if (!currentRoomId) return;
      
      if (canUseLocalStorage) {
        const roomData = JSON.parse(localStorage.getItem(`room_${currentRoomId}`)) || {
          transactions: [],
          shoppingItems: [],
          events: []
        };
        
        transactions = roomData.transactions || [];
        shoppingItemsList = roomData.shoppingItems || [];
        events = roomData.events || [];
        
        updateUI();
      }
    }

    // Save room data to storage
    function saveRoomData() {
      if (!currentRoomId || !canUseLocalStorage) return;
      
      const roomData = {
        transactions: transactions,
        shoppingItems: shoppingItemsList,
        events: events
      };
      
      localStorage.setItem(`room_${currentRoomId}`, JSON.stringify(roomData));
    }

    // Handle login
    loginBtn.addEventListener('click', () => {
      const roomName = roomNameInput.value.trim();
      const password = roomPasswordInput.value.trim();
      
      if (!roomName || !password) {
        showNotification('Пожалуйста, заполните все поля', 'error');
        return;
      }
      
      // Generate room ID
      const roomId = generateRoomId(roomName, password);
      
      // Check if room exists
      if (canUseLocalStorage) {
        const roomExists = localStorage.getItem(`room_${roomId}`);
        
        if (roomExists) {
          currentRoomId = roomId;
          currentRoomName = roomName;
          currentRoomPassword = password;
          
          // Save current room info
          saveCurrentRoom();
          
          currentRoomElement.textContent = roomName;
          currentRoomSettings.textContent = roomName;
          authModal.classList.remove('active');
          
          loadRoomData();
          showNotification(`Успешный вход в комнату "${roomName}"`, 'success');
        } else {
          showNotification('Комната не найдена. Проверьте название и пароль или создайте новую комнату', 'error');
        }
      }
    });

    // Handle room creation
    createRoomBtn.addEventListener('click', () => {
      const roomName = roomNameInput.value.trim();
      const password = roomPasswordInput.value.trim();
      
      if (!roomName || !password) {
        showNotification('Пожалуйста, заполните все поля', 'error');
        return;
      }
      
      // Generate room ID
      const roomId = generateRoomId(roomName, password);
      
      // Check if room already exists
      if (canUseLocalStorage && localStorage.getItem(`room_${roomId}`)) {
        showNotification('Комната с таким названием и паролем уже существует', 'error');
        return;
      }
      
      // Create new room
      currentRoomId = roomId;
      currentRoomName = roomName;
      currentRoomPassword = password;
      
      // Save current room info
      saveCurrentRoom();
      
      // Initialize room data
      if (canUseLocalStorage) {
        const roomData = {
          transactions: [],
          shoppingItems: [],
          events: []
        };
        localStorage.setItem(`room_${roomId}`, JSON.stringify(roomData));
      }
      
      currentRoomElement.textContent = roomName;
      currentRoomSettings.textContent = roomName;
      authModal.classList.remove('active');
      
      showNotification(`Комната "${roomName}" успешно создана!`, 'success');
    });

    // Handle logout
    logoutBtn.addEventListener('click', () => {
      if (canUseLocalStorage) {
        localStorage.removeItem('currentRoomId');
        localStorage.removeItem('currentRoomName');
        localStorage.removeItem('currentRoomPassword');
      }
      
      currentRoomId = null;
      currentRoomName = null;
      currentRoomPassword = null;
      transactions = [];
      shoppingItemsList = [];
      events = [];
      
      currentRoomElement.textContent = 'Комната не выбрана';
      currentRoomSettings.textContent = 'Не выбрана';
      authModal.classList.add('active');
      
      updateUI();
      showNotification('Вы успешно вышли из комнаты', 'info');
    });

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      
      // Все остальные обработчики событий остаются без изменений
    });

    // Все остальные функции (updateUI, updateSummary, etc.) остаются без изменений
    // В этих функциях нужно заменить обращения к Firebase на работу с localStorage
  </script>
</body>
</html>

