<!DOCTYPE html>
<html lang="ru" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyHub - –°–µ–º–µ–π–Ω—ã–π –û—Ä–≥–∞–Ω–∞–π–∑–µ—Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: {
                            blue: '#007AFF',
                            green: '#34C759',
                            red: '#FF3B30',
                            orange: '#FF9500',
                            yellow: '#FFCC00',
                            purple: '#AF52DE',
                            teal: '#5AC8FA',
                            gray: '#8E8E93',
                            bg: '#F5F5F7', // Slightly warmer Apple gray
                            card: '#FFFFFF',
                            darkBg: '#000000',
                            darkCard: '#1C1C1E',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 8px 30px rgba(0,0,0,0.04)',
                        'glow': '0 0 20px rgba(0,122,255,0.15)'
                    }
                }
            }
        }
    </script>
    <style>
        /* Apple-like Customizations */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F5F5F7;
            color: #1D1D1F;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #000000;
            color: #F5F5F7;
        }
        
        /* Modern Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .dark .glass {
            background: rgba(28, 28, 30, 0.85);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Card Styling */
        .card {
            background-color: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.06);
        }
        .dark .card {
            background-color: #1C1C1E;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
        }

        /* Interactive Elements */
        .ios-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .ios-btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }
        
        .ios-input {
            background-color: #F2F2F7;
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 14px 16px;
            width: 100%;
            outline: none;
            font-size: 15px;
            transition: all 0.2s;
        }
        .ios-input:focus {
            background-color: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(0,122,255,0.1);
        }
        .dark .ios-input {
            background-color: #2C2C2E;
            color: white;
        }
        .dark .ios-input:focus {
            background-color: #3A3A3C;
            box-shadow: 0 0 0 4px rgba(10,132,255,0.2);
        }

        /* Sidebar Styling */
        .sidebar-link {
            position: relative;
            overflow: hidden;
        }
        .sidebar-link.active {
            background-color: rgba(0,122,255,0.1);
            color: #007AFF;
            font-weight: 600;
        }
        .dark .sidebar-link.active {
            background-color: rgba(10,132,255,0.2);
            color: #5AC8FA;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #D1D1D6;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #48484A;
        }
        
        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #E5E5EA;
            border-radius: 0 0 20px 20px;
            overflow: hidden;
        }
        .dark .calendar-grid {
            background-color: #38383A;
        }
        .calendar-day {
            min-height: 110px;
            background-color: white;
            transition: background-color 0.2s;
        }
        .dark .calendar-day {
            background-color: #1C1C1E;
        }
        .calendar-day:hover {
            background-color: #F9F9F9;
        }
        .dark .calendar-day:hover {
            background-color: #252527;
        }
        
        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-ios-blue selection:text-white">

    <!-- Sidebar -->
    <aside class="w-72 bg-white/80 dark:bg-ios-darkCard/80 backdrop-blur-xl border-r border-gray-200 dark:border-gray-800 flex flex-col justify-between hidden md:flex transition-colors duration-300 z-20">
        <div>
            <div class="p-8 pb-4">
                <h1 class="text-3xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-ios-blue to-ios-purple flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-ios-blue to-ios-teal text-white flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    </div>
                    FamilyHub
                </h1>
                <p class="text-xs font-medium text-gray-400 mt-2 px-1 tracking-wide uppercase">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–º–æ–º</p>
            </div>
            <nav class="px-4 space-y-2 mt-4">
                <button onclick="router.navigate('dashboard')" id="nav-dashboard" class="sidebar-link w-full flex items-center gap-4 px-5 py-3.5 rounded-2xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-all group">
                    <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="text-[15px] font-medium">–û–±–∑–æ—Ä</span>
                </button>
                <button onclick="router.navigate('budget')" id="nav-budget" class="sidebar-link w-full flex items-center gap-4 px-5 py-3.5 rounded-2xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-all group">
                    <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="text-[15px] font-medium">–ë—é–¥–∂–µ—Ç</span>
                </button>
                <button onclick="router.navigate('calendar')" id="nav-calendar" class="sidebar-link w-full flex items-center gap-4 px-5 py-3.5 rounded-2xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-all group">
                    <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="text-[15px] font-medium">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                </button>
                <button onclick="router.navigate('shopping')" id="nav-shopping" class="sidebar-link w-full flex items-center gap-4 px-5 py-3.5 rounded-2xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-all group">
                    <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="text-[15px] font-medium">–ü–æ–∫—É–ø–∫–∏</span>
                </button>
                <button onclick="router.navigate('settings')" id="nav-settings" class="sidebar-link w-full flex items-center gap-4 px-5 py-3.5 rounded-2xl text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 transition-all group">
                    <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="text-[15px] font-medium">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </button>
            </nav>
        </div>
        <div class="p-6 border-t border-gray-100 dark:border-gray-800">
            <div class="flex items-center gap-4 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-colors cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 text-gray-600 dark:text-gray-200 flex items-center justify-center font-bold shadow-sm">–°</div>
                <div class="text-sm">
                    <p class="font-semibold text-gray-800 dark:text-white">–°–µ–º—å—è –ò–≤–∞–Ω–æ–≤—ã—Ö</p>
                    <p class="text-xs text-gray-500">Premium –î–æ—Å—Ç—É–ø</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Mobile Header -->
    <div class="md:hidden fixed top-0 w-full glass z-50 flex justify-between items-center px-5 py-4">
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-ios-blue to-ios-purple">FamilyHub</h1>
        <button id="mobile-menu-btn" class="p-2 -mr-2 rounded-lg text-gray-600 dark:text-gray-300">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </div>

    <!-- Mobile Nav Menu -->
    <div id="mobile-menu" class="hidden fixed inset-0 z-40 bg-white/95 dark:bg-black/95 backdrop-blur-xl pt-24 px-8 space-y-6 md:hidden transition-all duration-300">
         <button onclick="router.navigate('dashboard'); toggleMobileMenu()" class="w-full text-left text-2xl font-semibold py-2 border-b border-gray-100 dark:border-gray-800 dark:text-white flex items-center gap-4">
             <span class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900 text-purple-500 flex items-center justify-center text-sm">üè†</span> –û–±–∑–æ—Ä
         </button>
         <button onclick="router.navigate('budget'); toggleMobileMenu()" class="w-full text-left text-2xl font-semibold py-2 border-b border-gray-100 dark:border-gray-800 dark:text-white flex items-center gap-4">
             <span class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-500 flex items-center justify-center text-sm">‚ÇΩ</span> –ë—é–¥–∂–µ—Ç
         </button>
         <button onclick="router.navigate('calendar'); toggleMobileMenu()" class="w-full text-left text-2xl font-semibold py-2 border-b border-gray-100 dark:border-gray-800 dark:text-white flex items-center gap-4">
             <span class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900 text-red-500 flex items-center justify-center text-sm">üìÖ</span> –ö–∞–ª–µ–Ω–¥–∞—Ä—å
         </button>
         <button onclick="router.navigate('shopping'); toggleMobileMenu()" class="w-full text-left text-2xl font-semibold py-2 border-b border-gray-100 dark:border-gray-800 dark:text-white flex items-center gap-4">
             <span class="w-8 h-8 rounded-lg bg-green-100 dark:bg-green-900 text-green-500 flex items-center justify-center text-sm">üõí</span> –ü–æ–∫—É–ø–∫–∏
         </button>
         <button onclick="router.navigate('settings'); toggleMobileMenu()" class="w-full text-left text-2xl font-semibold py-2 border-b border-gray-100 dark:border-gray-800 dark:text-white flex items-center gap-4">
             <span class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-500 flex items-center justify-center text-sm">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
         </button>
         <button onclick="toggleMobileMenu()" class="mt-12 w-full py-4 bg-gray-100 dark:bg-gray-800 rounded-2xl text-ios-blue font-bold text-lg shadow-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden pt-20 md:pt-0 bg-ios-bg dark:bg-black relative">
        <!-- Background decoration -->
        <div class="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-blue-50/50 to-transparent dark:from-blue-900/10 dark:to-transparent pointer-events-none"></div>
        
        <div id="app-content" class="p-6 md:p-10 max-w-7xl mx-auto space-y-8 relative z-10">
            <!-- Content Injected via JS -->
        </div>
    </main>

    <!-- Global Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4 transition-opacity duration-300">
        <div id="modal-content" class="bg-white dark:bg-[#1C1C1E] w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-100 opacity-100 border border-gray-100 dark:border-gray-700">
            <!-- Modal Body -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 right-6 md:bottom-6 md:top-auto md:right-6 bg-white dark:bg-[#2C2C2E] text-gray-900 dark:text-white px-5 py-4 rounded-2xl shadow-soft border border-gray-100 dark:border-gray-700 transform translate-x-full md:translate-x-0 md:translate-y-32 transition-transform duration-500 z-[60] flex items-center gap-3 min-w-[300px]">
        <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center text-lg">‚úì</div>
        <div>
            <h4 class="font-bold text-sm">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h4>
            <p id="toast-message" class="text-sm text-gray-500 dark:text-gray-400">–û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞</p>
        </div>
    </div>

    <script>
        // --- Data Layer (Mock Backend) ---
        
        const DB = {
            init() {
                if(!localStorage.getItem('familyHub_transactions')) localStorage.setItem('familyHub_transactions', JSON.stringify([]));
                if(!localStorage.getItem('familyHub_events')) localStorage.setItem('familyHub_events', JSON.stringify([]));
                if(!localStorage.getItem('familyHub_shopping')) localStorage.setItem('familyHub_shopping', JSON.stringify([
                    { id: 1, name: '–ú–æ–ª–æ–∫–æ', qty: 2, unit: '–ª', category: 'dairy', shopId: 1, checked: false, priority: 'normal', price: 80 },
                    { id: 2, name: '–•–ª–µ–±', qty: 1, unit: '—à—Ç', category: 'bakery', shopId: 1, checked: true, priority: 'normal', price: 40 },
                    { id: 3, name: '–ú—è—Å–æ –¥–ª—è —à–∞—à–ª—ã–∫–∞', qty: 2, unit: '–∫–≥', category: 'meat', shopId: 3, checked: false, priority: 'urgent', price: 650 }
                ]));
                if(!localStorage.getItem('familyHub_shops')) localStorage.setItem('familyHub_shops', JSON.stringify([
                    { id: 1, name: '–ü—è—Ç—ë—Ä–æ—á–∫–∞' },
                    { id: 2, name: '–ú–∞–≥–Ω–∏—Ç' },
                    { id: 3, name: '–ê—à–∞–Ω' },
                    { id: 4, name: '–í–∫—É—Å–í–∏–ª–ª' }
                ]));
                if(!localStorage.getItem('familyHub_participants')) localStorage.setItem('familyHub_participants', JSON.stringify([
                    {id: 1, name: '–ú–∞–º–∞', role: 'admin', color: '#FF3B30'}, 
                    {id: 2, name: '–ü–∞–ø–∞', role: 'admin', color: '#007AFF'}, 
                    {id: 3, name: '–°—ã–Ω', role: 'member', color: '#34C759'}, 
                    {id: 4, name: '–î–æ—á—å', role: 'member', color: '#FF9500'}, 
                ]));
                if(!localStorage.getItem('familyHub_settings')) localStorage.setItem('familyHub_settings', JSON.stringify({
                    darkMode: false,
                    currency: '‚ÇΩ',
                    notifications: { enabled: true, dnd: false, time: '15' },
                    telegram: { connected: false },
                    // Global/Sidebar widget prefs
                    widgets: [
                        { id: 'calendar', name: '–ö–∞–ª–µ–Ω–¥–∞—Ä—å', enabled: true },
                        { id: 'budget', name: '–ë–∞–ª–∞–Ω—Å', enabled: true },
                        { id: 'chart', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤', enabled: true },
                        { id: 'shopping', name: '–ü–æ–∫—É–ø–∫–∏', enabled: false }
                    ]
                }));
                
                // Dashboard specific config
                if(!localStorage.getItem('familyHub_dashboard')) localStorage.setItem('familyHub_dashboard', JSON.stringify({
                    widgets: [
                        { id: 'budget_overview', type: 'budget_overview', name: '–§–∏–Ω–∞–Ω—Å—ã', enabled: true, size: 'large' },
                        { id: 'today_schedule', type: 'today_schedule', name: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è', enabled: true, size: 'large' },
                        { id: 'shopping_summary', type: 'shopping_summary', name: '–ü–æ–∫—É–ø–∫–∏', enabled: true, size: 'small' },
                        { id: 'quick_actions', type: 'quick_actions', name: '–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è', enabled: true, size: 'medium' },
                        { id: 'recent_transactions', type: 'recent_transactions', name: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏', enabled: true, size: 'medium' }
                    ]
                }));

                // Apply theme on load
                const settings = this.get('settings');
                if(settings.darkMode) document.documentElement.classList.add('dark');
            },

            get(collection) {
                return JSON.parse(localStorage.getItem(`familyHub_${collection}`)) || [];
            },

            save(collection, data) {
                localStorage.setItem(`familyHub_${collection}`, JSON.stringify(data));
            },

            add(collection, item) {
                const data = this.get(collection);
                item.id = Date.now(); // Simple ID
                data.push(item);
                this.save(collection, data);
                return item;
            },

            update(collection, id, updates) {
                const data = this.get(collection);
                const index = data.findIndex(i => i.id === Number(id));
                if (index !== -1) {
                    data[index] = { ...data[index], ...updates };
                    this.save(collection, data);
                }
            },

            delete(collection, id) {
                let data = this.get(collection);
                data = data.filter(i => i.id !== Number(id));
                this.save(collection, data);
            }
        };

        DB.init();

        // --- Utils ---
        const formatCurrency = (amount) => {
            const currency = DB.get('settings').currency || '‚ÇΩ';
            return `${parseFloat(amount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, " ")} ${currency}`;
        };

        const formatDate = (dateStr) => {
            if(!dateStr) return '';
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return new Date(dateStr).toLocaleDateString('ru-RU', options);
        };

        const showToast = (msg, isSuccess=true) => {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            
            // Animation for desktop (bottom) and mobile (top/side)
            if(window.innerWidth >= 768) {
                toast.classList.remove('translate-y-32');
                setTimeout(() => toast.classList.add('translate-y-32'), 3000);
            } else {
                toast.classList.remove('translate-x-full');
                setTimeout(() => toast.classList.add('translate-x-full'), 3000);
            }
        };

        // --- Modules ---

        // 0. Dashboard Module
        const Dashboard = {
            render() {
                const config = DB.get('dashboard');
                const widgets = config.widgets.filter(w => w.enabled);
                const participants = DB.get('participants');
                const admin = participants.find(p => p.role === 'admin') || participants[0] || { name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' };
                
                // Greeting Logic
                const hour = new Date().getHours();
                let greeting = '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
                if (hour < 12) greeting = '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
                else if (hour >= 18) greeting = '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
                
                const dateStr = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });

                return `
                    <div class="space-y-6 animate-fade-in h-full flex flex-col">
                        <!-- Header -->
                        <div class="flex justify-between items-end flex-shrink-0">
                            <div>
                                <h1 class="text-3xl font-bold dark:text-white tracking-tight">${greeting}, ${admin.name.split(' ')[0]}!</h1>
                                <p class="text-gray-500 dark:text-gray-400 capitalize mt-1">${dateStr}</p>
                            </div>
                            <button onclick="Dashboard.openSettings()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 transition-colors text-gray-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </button>
                        </div>

                        <!-- Widget Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-min grid-flow-dense pb-10">
                            ${widgets.map(w => this.renderWidget(w)).join('')}
                        </div>
                    </div>
                `;
            },

            renderWidget(widget) {
                // Wrapper - Optimized col-spans for dense grid
                let colSpan = 'col-span-1';
                let rowSpan = '';
                
                switch(widget.type) {
                    case 'budget_overview': 
                        colSpan = 'md:col-span-2 lg:col-span-2'; 
                        break;
                    case 'today_schedule': 
                        colSpan = 'md:col-span-1 lg:col-span-2'; 
                        // rowSpan = 'row-span-2'; // Removing explicit row-span to fit better automatically
                        break;
                    case 'recent_transactions':
                        colSpan = 'md:col-span-1 lg:col-span-2';
                        break;
                    // others default to col-span-1
                }

                // If on mobile, everything is col-span-1 (handled by grid-cols-1 default)

                const contentMap = {
                    'budget_overview': this.getBudgetContent(),
                    'today_schedule': this.getScheduleContent(),
                    'shopping_summary': this.getShoppingContent(),
                    'quick_actions': this.getQuickActionsContent(),
                    'recent_transactions': this.getTransactionsContent()
                };

                return `
                    <div class="card p-6 flex flex-col justify-between ${colSpan} ${rowSpan} hover:shadow-lg transition-shadow duration-300 border border-gray-100 dark:border-white/5 h-full min-h-[180px]">
                        ${contentMap[widget.type] || ''}
                    </div>
                `;
            },

            getBudgetContent() {
                const transactions = DB.get('transactions');
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const thisMonthTx = transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const income = thisMonthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = thisMonthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                // Total Balance (All time)
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = totalIncome - totalExpense;

                // Progress (Simple logic: assuming 80% of income is budget limit for demo)
                const limit = income > 0 ? income * 0.8 : 50000; 
                const percent = Math.min(100, (expense / limit) * 100);

                return `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wide">–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h3>
                            <div class="text-3xl font-extrabold text-gray-900 dark:text-white mt-1">${formatCurrency(balance)}</div>
                            <p class="text-xs text-gray-400 mt-1">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
                        </div>
                        <button onclick="router.navigate('budget')" class="p-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 dark:bg-green-900/10 p-3 rounded-xl">
                            <p class="text-xs text-green-600 font-bold mb-1">–î–æ—Ö–æ–¥—ã (–º–µ—Å)</p>
                            <p class="text-lg font-bold text-gray-900 dark:text-white">+${formatCurrency(income)}</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/10 p-3 rounded-xl">
                            <p class="text-xs text-red-600 font-bold mb-1">–†–∞—Å—Ö–æ–¥—ã (–º–µ—Å)</p>
                            <p class="text-lg font-bold text-gray-900 dark:text-white">-${formatCurrency(expense)}</p>
                        </div>
                    </div>

                    <div>
                         <div class="flex justify-between text-xs font-medium mb-2">
                            <span class="text-gray-500">–†–∞—Å—Ö–æ–¥ –±—é–¥–∂–µ—Ç–∞</span>
                            <span class="text-gray-900 dark:text-white">${Math.round(percent)}%</span>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400 mt-2">
                            <span>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${formatCurrency(expense)}</span>
                            <span>–õ–∏–º–∏—Ç: ~${formatCurrency(limit)}</span>
                        </div>
                    </div>
                `;
            },

            getScheduleContent() {
                const events = DB.get('events');
                const todayStr = new Date().toISOString().split('T')[0];
                const todayEvents = events
                    .filter(e => e.date === todayStr)
                    .sort((a,b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
                
                const participants = DB.get('participants');

                return `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold dark:text-white">–°–µ–≥–æ–¥–Ω—è</h3>
                        <button onclick="router.navigate('calendar')" class="text-sm font-bold text-blue-500 hover:underline">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto space-y-3 pr-1 max-h-[250px] hide-scrollbar">
                        ${todayEvents.length === 0 ? `
                            <div class="flex flex-col items-center justify-center h-full text-center text-gray-400">
                                <p class="mb-2 text-2xl">‚òïÔ∏è</p>
                                <p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –ø–ª–∞–Ω–æ–≤ –Ω–µ—Ç</p>
                                <button onclick="Calendar.openAddModal('${todayStr}')" class="mt-4 text-xs bg-gray-100 dark:bg-white/10 px-3 py-1.5 rounded-lg font-bold text-gray-600 dark:text-white hover:bg-gray-200 transition-colors">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        ` : todayEvents.map(e => {
                            const p = participants.find(x => x.id == e.participantId) || { color: '#ccc' };
                            return `
                                <div class="flex items-start gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group cursor-pointer" onclick="Calendar.openDayModal('${todayStr}')">
                                    <div class="w-1.5 h-10 rounded-full mt-1 flex-shrink-0" style="background-color: ${p.color}"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between">
                                            <h4 class="font-bold text-gray-900 dark:text-white truncate">${e.title}</h4>
                                            <span class="text-xs font-medium text-gray-400 flex-shrink-0 ml-2">${e.time || '–í–µ—Å—å –¥–µ–Ω—å'}</span>
                                        </div>
                                        <p class="text-xs text-gray-500 truncate mt-0.5 flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full inline-block" style="background-color: ${p.color}"></span> ${p.name}
                                            ${e.location ? `‚Ä¢ üìç ${e.location}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${todayEvents.length > 0 ? `
                        <button onclick="Calendar.openAddModal('${todayStr}')" class="w-full mt-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-900 dark:hover:text-white hover:bg-gray-50 dark:hover:bg-white/5 rounded-xl transition-colors dashed-border">
                            + –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
                        </button>
                    ` : ''}
                `;
            },

            getShoppingContent() {
                const items = DB.get('shopping');
                const active = items.filter(i => !i.checked);
                const count = active.length;
                const total = active.reduce((sum, i) => sum + (parseFloat(i.price || 0) * (parseFloat(i.qty) || 1)), 0);

                // Group by shop for summary
                const shops = DB.get('shops');
                const byShop = {};
                active.forEach(i => {
                    const sName = shops.find(s => s.id == i.shopId)?.name || '–†–∞–∑–Ω–æ–µ';
                    byShop[sName] = (byShop[sName] || 0) + 1;
                });
                const topShops = Object.entries(byShop).sort((a,b) => b[1] - a[1]).slice(0, 2);

                return `
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold dark:text-white flex items-center gap-2">
                                <span class="bg-orange-100 dark:bg-orange-900/30 text-orange-600 p-1 rounded-lg">üõí</span>
                                –ü–æ–∫—É–ø–∫–∏
                            </h3>
                            <span class="bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300">${count}</span>
                        </div>
                        
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <p class="text-2xl font-extrabold text-gray-900 dark:text-white">${count}</p>
                                <p class="text-xs text-gray-400">–¢–æ–≤–∞—Ä–æ–≤ –≤ —Å–ø–∏—Å–∫–µ</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-gray-900 dark:text-white">~${formatCurrency(total)}</p>
                                <p class="text-xs text-gray-400">–°—É–º–º–∞</p>
                            </div>
                        </div>

                        <div class="space-y-2 mb-4">
                             ${topShops.map(([name, c]) => `
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-500">üè™ ${name}</span>
                                    <span class="font-bold dark:text-white">${c}</span>
                                </div>
                             `).join('')}
                             ${active.length === 0 ? '<p class="text-xs text-green-500 font-medium">–í—Å—ë –∫—É–ø–ª–µ–Ω–æ! üéâ</p>' : ''}
                        </div>

                        <button onclick="router.navigate('shopping')" class="w-full py-2 bg-black dark:bg-white text-white dark:text-black rounded-xl font-bold text-sm shadow-lg hover:opacity-90 transition-opacity">
                            –û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫
                        </button>
                    </div>
                `;
            },

            getQuickActionsContent() {
                return `
                    <div>
                        <h3 class="font-bold dark:text-white mb-4 flex items-center gap-2">
                            <span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 p-1 rounded-lg">‚ö°</span>
                            –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="Budget.openModal()" class="flex flex-col items-center justify-center p-3 bg-gray-50 dark:bg-white/5 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-xl transition-colors group">
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform">üí∞</div>
                                <span class="text-xs font-bold text-gray-600 dark:text-gray-300">–†–∞—Å—Ö–æ–¥</span>
                            </button>
                            <button onclick="Calendar.openAddModal()" class="flex flex-col items-center justify-center p-3 bg-gray-50 dark:bg-white/5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors group">
                                <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform">üìÖ</div>
                                <span class="text-xs font-bold text-gray-600 dark:text-gray-300">–°–æ–±—ã—Ç–∏–µ</span>
                            </button>
                            <button onclick="Shopping.openAddModal()" class="flex flex-col items-center justify-center p-3 bg-gray-50 dark:bg-white/5 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-xl transition-colors group">
                                <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform">üõí</div>
                                <span class="text-xs font-bold text-gray-600 dark:text-gray-300">–¢–æ–≤–∞—Ä</span>
                            </button>
                            <button onclick="Shopping.openScanner()" class="flex flex-col items-center justify-center p-3 bg-gray-50 dark:bg-white/5 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-xl transition-colors group">
                                <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform">üì∑</div>
                                <span class="text-xs font-bold text-gray-600 dark:text-gray-300">–°–∫–∞–Ω</span>
                            </button>
                        </div>
                    </div>
                `;
            },

            getTransactionsContent() {
                const transactions = DB.get('transactions')
                    .sort((a,b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 4);

                return `
                    <div>
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold dark:text-white text-sm uppercase text-gray-400">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                        </div>
                        <div class="space-y-3">
                            ${transactions.length === 0 ? '<p class="text-xs text-gray-400">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>' : 
                            transactions.map(t => `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs ${t.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                                            ${t.type === 'income' ? '‚Üì' : '‚Üë'}
                                        </div>
                                        <div class="min-w-0">
                                            <p class="text-sm font-bold text-gray-900 dark:text-white truncate max-w-[100px]">${t.description}</p>
                                            <p class="text-[10px] text-gray-500">${formatDate(t.date)}</p>
                                        </div>
                                    </div>
                                    <span class="text-sm font-bold ${t.type === 'income' ? 'text-green-500' : 'text-gray-900 dark:text-white'}">
                                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            openSettings() {
                const config = DB.get('dashboard');
                // Ensure unique IDs and clean structure
                
                const renderList = () => {
                    return config.widgets.map((w, index) => `
                        <div class="widget-item flex items-center justify-between p-3 bg-gray-50 dark:bg-white/5 rounded-xl border border-gray-100 dark:border-white/5 group transition-all" 
                             draggable="true" 
                             data-index="${index}"
                             ondragstart="Dashboard.dragStart(event)" 
                             ondragover="Dashboard.dragOver(event)" 
                             ondrop="Dashboard.drop(event)"
                             ondragenter="this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20')"
                             ondragleave="this.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20')"
                        >
                            <div class="flex items-center gap-3">
                                <div class="cursor-grab active:cursor-grabbing p-2 text-gray-400 hover:text-gray-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                                </div>
                                <span class="font-bold text-gray-900 dark:text-white select-none">${w.name}</span>
                            </div>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" class="sr-only peer" ${w.enabled ? 'checked' : ''} onchange="Dashboard.toggleWidget('${w.id}')">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    `).join('');
                };

                const modalHtml = `
                    <div class="p-6">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold dark:text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –û–±–∑–æ—Ä–∞</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞.</p>
                        
                        <div id="widget-settings-list" class="space-y-2 max-h-[400px] overflow-y-auto">
                            ${renderList()}
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button onclick="closeModal()" class="px-6 py-2 bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white font-bold rounded-xl hover:bg-gray-200 transition-colors">–ì–æ—Ç–æ–≤–æ</button>
                        </div>
                    </div>
                `;
                openModal(modalHtml);
            },

            toggleWidget(id) {
                const config = DB.get('dashboard');
                const w = config.widgets.find(x => x.id === id);
                if(w) {
                    w.enabled = !w.enabled;
                    DB.save('dashboard', config);
                    router.refresh();
                }
            },

            dragStart(e) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', e.target.getAttribute('data-index'));
                e.target.style.opacity = '0.5';
            },

            dragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            },

            drop(e) {
                e.stopPropagation();
                e.preventDefault();
                
                // Get Dragged Index
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                
                // Get Target Index (traverse up to find the row)
                let target = e.target;
                while (target && !target.hasAttribute('data-index')) {
                    target = target.parentElement;
                }
                
                // Reset Styles
                document.querySelectorAll('.widget-item').forEach(el => {
                    el.style.opacity = '1';
                    el.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
                });

                if (target) {
                    const toIndex = parseInt(target.getAttribute('data-index'));
                    
                    if (fromIndex !== toIndex && !isNaN(fromIndex) && !isNaN(toIndex)) {
                        // Reorder Data
                        const config = DB.get('dashboard');
                        const item = config.widgets.splice(fromIndex, 1)[0];
                        config.widgets.splice(toIndex, 0, item);
                        DB.save('dashboard', config);
                        
                        // Re-render Settings List
                        this.openSettings(); 
                        
                        // Refresh Dashboard Background
                        router.refresh();
                    }
                }
                return false;
            }
        };

        // 1. Budget Module
        const Budget = {
            render() {
                const transactions = DB.get('transactions').sort((a,b) => new Date(b.date) - new Date(a.date));
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = income - expense;
                
                // Get widget settings
                const settings = DB.get('settings');
                const widgets = settings.widgets || [];
                // If widgets are not set (migration issue), default to true for core features
                const showBalance = widgets.find(w => w.id === 'budget') ? widgets.find(w => w.id === 'budget').enabled : true;
                const showChart = widgets.find(w => w.id === 'chart') ? widgets.find(w => w.id === 'chart').enabled : true;

                // Simple Category Analysis
                const categories = {};
                transactions.filter(t => t.type === 'expense').forEach(t => {
                    categories[t.category] = (categories[t.category] || 0) + parseFloat(t.amount);
                });
                const maxCatVal = Math.max(...Object.values(categories), 1); // Avoid div by zero

                return `
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold dark:text-white tracking-tight">–§–∏–Ω–∞–Ω—Å—ã</h2>
                        <p class="text-gray-500 dark:text-gray-400">–û–±–∑–æ—Ä –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å–µ–º—å–∏</p>
                    </div>

                    ${showBalance ? `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="card p-6 bg-gradient-to-br from-white to-blue-50 dark:from-[#1C1C1E] dark:to-[#252527] border-0">
                            <h3 class="text-blue-500 text-sm font-semibold uppercase tracking-wider mb-2">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h3>
                            <p class="text-4xl font-extrabold text-gray-900 dark:text-white">${formatCurrency(balance)}</p>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                <h3 class="text-gray-500 text-sm font-medium">–î–æ—Ö–æ–¥—ã</h3>
                            </div>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white">+${formatCurrency(income)}</p>
                        </div>
                        <div class="card p-6">
                             <div class="flex items-center gap-3 mb-2">
                                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                <h3 class="text-gray-500 text-sm font-medium">–†–∞—Å—Ö–æ–¥—ã</h3>
                            </div>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white">-${formatCurrency(expense)}</p>
                        </div>
                    </div>
                    ` : ''}

                    <div class="grid grid-cols-1 ${showChart ? 'lg:grid-cols-3' : 'lg:grid-cols-1'} gap-8">
                        <!-- Transactions List -->
                        <div class="${showChart ? 'lg:col-span-2' : ''} card p-8">
                            <div class="flex justify-between items-end mb-6">
                                <div>
                                    <h2 class="text-xl font-bold dark:text-white">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
                                </div>
                                <button onclick="Budget.openModal()" class="ios-btn bg-black dark:bg-white text-white dark:text-black px-5 py-2.5 rounded-full text-sm font-bold shadow-lg hover:shadow-xl flex items-center gap-2">
                                    <span>+</span> –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${transactions.length === 0 ? '<div class="p-8 text-center bg-gray-50 dark:bg-white/5 rounded-2xl"><p class="text-gray-400">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p></div>' : 
                                transactions.map(t => `
                                    <div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-white/5 rounded-2xl transition-all group border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm ${t.type === 'income' ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400'}">
                                                ${t.type === 'income' ? '‚Üì' : '‚Üë'}
                                            </div>
                                            <div>
                                                <p class="font-semibold text-gray-900 dark:text-white text-base">${t.description}</p>
                                                <p class="text-xs text-gray-500 font-medium">${t.category} ‚Ä¢ ${formatDate(t.date)}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <span class="font-bold text-lg ${t.type === 'income' ? 'text-green-500' : 'text-gray-900 dark:text-white'}">
                                                ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                                            </span>
                                            <button onclick="Budget.delete(${t.id})" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all opacity-0 group-hover:opacity-100">
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Mini Chart -->
                        ${showChart ? `
                        <div class="card p-8 h-fit">
                             <h2 class="text-xl font-bold dark:text-white mb-6">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
                             <div class="space-y-6">
                                ${Object.keys(categories).length === 0 ? '<p class="text-gray-400 text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö.</p>' :
                                Object.entries(categories).map(([cat, val]) => `
                                    <div>
                                        <div class="flex justify-between text-sm mb-2 font-medium">
                                            <span class="text-gray-700 dark:text-gray-300">${cat}</span>
                                            <span class="text-gray-900 dark:text-white font-bold">${formatCurrency(val)}</span>
                                        </div>
                                        <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-2.5 overflow-hidden">
                                            <div class="bg-ios-blue h-full rounded-full transition-all duration-1000 ease-out" style="width: ${(val/maxCatVal)*100}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                             </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            },

            openModal() {
                const modalHtml = `
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold dark:text-white">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">‚úï</button>
                        </div>
                        <form onsubmit="Budget.submit(event)">
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                                    <div class="grid grid-cols-2 gap-4">
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="type" value="expense" checked class="peer sr-only">
                                            <div class="p-3 text-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 peer-checked:bg-red-500 peer-checked:text-white transition-all font-medium">
                                                –†–∞—Å—Ö–æ–¥
                                            </div>
                                        </label>
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="type" value="income" class="peer sr-only">
                                            <div class="p-3 text-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 peer-checked:bg-green-500 peer-checked:text-white transition-all font-medium">
                                                –î–æ—Ö–æ–¥
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–°—É–º–º–∞</label>
                                    <input type="number" step="0.01" name="amount" required class="ios-input text-lg font-semibold" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <input type="text" name="description" required class="ios-input" placeholder="–ü—Ä–æ–¥—É–∫—Ç—ã, –ö–∞—Ñ–µ, –ó–∞—Ä–ø–ª–∞—Ç–∞...">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <div class="relative">
                                        <select name="category" class="ios-input appearance-none">
                                            <option value="–ü—Ä–æ–¥—É–∫—Ç—ã">–ü—Ä–æ–¥—É–∫—Ç—ã</option>
                                            <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                                            <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                                            <option value="–î–æ–º">–î–æ–º</option>
                                            <option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
                                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                                        </select>
                                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">‚ñº</div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–î–∞—Ç–∞</label>
                                    <input type="date" name="date" required class="ios-input" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="mt-8 pt-4 border-t border-gray-100 dark:border-gray-700 flex gap-3 justify-end">
                                <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors font-medium">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" class="px-8 py-3 bg-ios-blue text-white rounded-xl hover:bg-blue-600 transition-colors font-bold shadow-lg shadow-blue-500/30">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                `;
                openModal(modalHtml);
            },

            submit(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                DB.add('transactions', data);
                closeModal();
                router.refresh();
                showToast('–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            },

            delete(id) {
                if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                    DB.delete('transactions', id);
                    router.refresh();
                }
            }
        };

        // 2. Calendar Module
        const Calendar = {
            currentDate: new Date(),
            
            render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Mon=0, Sun=6 fix for RU
                
                const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
                const dayNames = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

                const events = DB.get('events');
                const participants = DB.get('participants');

                let gridHtml = '';
                // Empty cells
                for(let i=0; i<startDayOfWeek; i++) {
                    gridHtml += `<div class="bg-gray-50/50 dark:bg-zinc-900/50 border-b border-r border-gray-200 dark:border-gray-700 min-h-[120px]"></div>`;
                }
                
                // Days
                for(let d=1; d<=daysInMonth; d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayEvents = events.filter(e => e.date === dateStr);
                    const isToday = d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();

                    gridHtml += `
                        <div class="calendar-day border-b border-r border-gray-200 dark:border-gray-700 p-3 overflow-hidden cursor-pointer relative group" onclick="Calendar.openDayModal('${dateStr}')">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm font-semibold w-7 h-7 flex items-center justify-center rounded-full ${isToday ? 'bg-ios-red text-white shadow-md' : 'text-gray-700 dark:text-gray-300'}">${d}</span>
                                <button class="opacity-0 group-hover:opacity-100 text-ios-blue text-xs font-bold transition-opacity p-1 bg-blue-50 dark:bg-blue-900/30 rounded">+</button>
                            </div>
                            <div class="space-y-1.5 mt-2">
                                ${dayEvents.map(e => {
                                    const p = participants.find(p => p.id == e.participantId) || {color: '#8E8E93'};
                                    return `
                                        <div class="text-[10px] text-white px-2 py-1 rounded-md truncate shadow-sm font-medium" style="background-color: ${p.color};">
                                            ${e.title}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Fill remaining
                const totalCells = startDayOfWeek + daysInMonth;
                const remaining = 7 - (totalCells % 7);
                if(remaining < 7) {
                    for(let i=0; i<remaining; i++) {
                        gridHtml += `<div class="bg-gray-50/50 dark:bg-zinc-900/50 border-b border-r border-gray-200 dark:border-gray-700"></div>`;
                    }
                }

                return `
                     <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-bold dark:text-white tracking-tight">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
                            <p class="text-gray-500 dark:text-gray-400">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∏ –≤—Å—Ç—Ä–µ—á</p>
                        </div>
                        <div class="flex items-center bg-white dark:bg-gray-800 rounded-xl p-1 shadow-sm border border-gray-200 dark:border-gray-700">
                             <button onclick="Calendar.changeMonth(-1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                             </button>
                             <span class="px-6 font-bold text-gray-800 dark:text-white min-w-[140px] text-center select-none">${monthNames[month]} ${year}</span>
                             <button onclick="Calendar.changeMonth(1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                             </button>
                        </div>
                    </div>

                    <div class="card overflow-hidden shadow-soft border-0">
                        <div class="grid grid-cols-7 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-[#2C2C2E]">
                            ${dayNames.map(d => `<div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">${d}</div>`).join('')}
                        </div>
                        <div class="calendar-grid bg-gray-200 dark:bg-gray-700 border-l border-t border-gray-200 dark:border-gray-700">
                            ${gridHtml}
                        </div>
                    </div>
                `;
            },

            changeMonth(delta) {
                this.currentDate.setMonth(this.currentDate.getMonth() + delta);
                router.refresh();
            },

            openAddModal(dateStr = '') {
                const participants = DB.get('participants');
                if(!dateStr) dateStr = new Date().toISOString().split('T')[0];
                
                const modalHtml = `
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold dark:text-white">–°–æ–±—ã—Ç–∏–µ</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        <form onsubmit="Calendar.submit(event)">
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" name="title" required class="ios-input text-lg font-semibold" placeholder="–í—Å—Ç—Ä–µ—á–∞, –£–∂–∏–Ω...">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–î–∞—Ç–∞</label>
                                        <input type="date" name="date" required class="ios-input" value="${dateStr}">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–í—Ä–µ–º—è</label>
                                        <input type="time" name="time" class="ios-input" value="12:00">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–ö—Ç–æ —É—á–∞—Å—Ç–≤—É–µ—Ç</label>
                                    <div class="flex flex-wrap gap-3">
                                        ${participants.map(p => `
                                            <label class="cursor-pointer group">
                                                <input type="radio" name="participantId" value="${p.id}" class="peer sr-only" required>
                                                <div class="pl-2 pr-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 peer-checked:ring-2 ring-offset-2 dark:ring-offset-[#1C1C1E] transition-all flex items-center gap-2 bg-gray-50 dark:bg-gray-800" style="--tw-ring-color: ${p.color}">
                                                    <div class="w-4 h-4 rounded-full shadow-sm" style="background-color: ${p.color}"></div>
                                                    <span class="text-sm font-medium dark:text-white">${p.name}</span>
                                                </div>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–ó–∞–º–µ—Ç–∫–∏</label>
                                    <textarea name="description" class="ios-input resize-none" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                                </div>
                            </div>
                            <div class="mt-8 pt-4 border-t border-gray-100 dark:border-gray-700 flex gap-3 justify-end">
                                <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors font-medium">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" class="px-8 py-3 bg-ios-blue text-white rounded-xl hover:bg-blue-600 transition-colors font-bold shadow-lg shadow-blue-500/30">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                `;
                openModal(modalHtml);
            },

            openDayModal(dateStr) {
                 const events = DB.get('events').filter(e => e.date === dateStr);
                 if(events.length === 0) {
                     this.openAddModal(dateStr);
                     return;
                 }
                 
                 const participants = DB.get('participants');
                 const displayDate = new Date(dateStr).toLocaleDateString('ru-RU', {weekday: 'long', month: 'long', day: 'numeric'});

                 const modalHtml = `
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold dark:text-white capitalize">${displayDate}</h3>
                            <button onclick="closeModal(); Calendar.openAddModal('${dateStr}')" class="text-ios-blue font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 px-3 py-1 rounded-lg transition-colors">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                        <div class="space-y-3 max-h-[400px] overflow-y-auto pr-1">
                            ${events.map(e => {
                                const p = participants.find(p => p.id == e.participantId) || {};
                                return `
                                    <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800 p-4 rounded-2xl border-l-[6px] shadow-sm" style="border-left-color: ${p.color}">
                                        <div>
                                            <h4 class="font-bold text-gray-900 dark:text-white text-lg">${e.title}</h4>
                                            <div class="flex items-center gap-2 text-sm text-gray-500 mt-1">
                                                <span>${e.time || '–í–µ—Å—å –¥–µ–Ω—å'}</span>
                                                <span>‚Ä¢</span>
                                                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full" style="background-color: ${p.color}"></div> ${p.name}</span>
                                            </div>
                                        </div>
                                        <button onclick="Calendar.delete(${e.id})" class="text-gray-300 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition-all">‚úï</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-8 text-center">
                             <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                 `;
                 openModal(modalHtml);
            },

            submit(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                DB.add('events', data);
                closeModal();
                router.refresh();
                showToast('–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
            },

            delete(id) {
                if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?')) {
                    DB.delete('events', id);
                    closeModal();
                    router.refresh();
                }
            }
        };

        // 3. Shopping Module (Enhanced)
        const Shopping = {
            state: {
                viewMode: 'category', // category, list
                showCompleted: true
            },

            render() {
                const allItems = DB.get('shopping');
                const shops = DB.get('shops') || [];
                // Default Categories if not set
                const categories = [
                    { id: 'dairy', name: '–ú–æ–ª–æ—á–Ω—ã–µ', icon: 'ü•õ', color: 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' },
                    { id: 'produce', name: '–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã', icon: 'üçé', color: 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' },
                    { id: 'meat', name: '–ú—è—Å–æ –∏ —Ä—ã–±–∞', icon: 'ü•©', color: 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' },
                    { id: 'bakery', name: '–•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞', icon: 'ü•ñ', color: 'bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400' },
                    { id: 'grocery', name: '–ë–∞–∫–∞–ª–µ—è', icon: 'üçù', color: 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400' },
                    { id: 'household', name: '–ë—ã—Ç–æ–≤–æ–µ', icon: 'üßª', color: 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400' },
                    { id: 'other', name: '–ü—Ä–æ—á–µ–µ', icon: 'üì¶', color: 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400' },
                ];

                const activeItems = allItems.filter(i => !i.checked);
                const completedItems = allItems.filter(i => i.checked);
                
                const totalCost = activeItems.reduce((sum, i) => sum + (parseFloat(i.price || 0) * (parseFloat(i.qty) || 1)), 0);

                const renderItem = (item) => {
                    const priorityIcon = {
                        urgent: '<span class="text-red-500" title="–°—Ä–æ—á–Ω–æ">üî•</span>',
                        high: '<span class="text-orange-500" title="–í–∞–∂–Ω–æ">‚ö°</span>',
                        normal: '',
                        low: '<span class="text-gray-400" title="–ù–µ —Å—Ä–æ—á–Ω–æ">‚Üì</span>'
                    }[item.priority || 'normal'];

                    const shopName = shops.find(s => s.id == item.shopId)?.name || '';

                    return `
                        <div class="group flex items-center gap-3 p-3 bg-white dark:bg-[#2C2C2E] border-b border-gray-100 dark:border-white/5 last:border-0 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors cursor-pointer" onclick="Shopping.openEditModal(${item.id})">
                             <div class="relative flex items-center" onclick="event.stopPropagation(); Shopping.toggle(${item.id})">
                                <div class="w-6 h-6 rounded-full border-2 ${item.checked ? 'bg-ios-green border-ios-green' : 'border-gray-300 dark:border-gray-500'} flex items-center justify-center transition-all">
                                    <svg class="w-3.5 h-3.5 text-white ${item.checked ? 'opacity-100' : 'opacity-0'} transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-[15px] font-medium text-gray-900 dark:text-white truncate ${item.checked ? 'line-through text-gray-400 dark:text-gray-500' : ''}">
                                        ${item.name}
                                    </span>
                                    ${priorityIcon}
                                </div>
                                <div class="flex items-center gap-2 text-xs text-gray-500">
                                    <span>${item.qty || 1} ${item.unit || '—à—Ç'}</span>
                                    ${item.price ? `<span>‚Ä¢ ${formatCurrency(item.price * (item.qty || 1))}</span>` : ''}
                                    ${shopName ? `<span class="bg-gray-100 dark:bg-white/10 px-1.5 py-0.5 rounded text-[10px]">${shopName}</span>` : ''}
                                </div>
                            </div>

                             <button onclick="event.stopPropagation(); Shopping.delete(${item.id})" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 p-2 transition-all">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                             </button>
                        </div>
                    `;
                };

                return `
                    <div class="flex flex-col h-full max-h-[calc(100vh-120px)]">
                        <!-- Header -->
                        <div class="flex justify-between items-end mb-6 flex-shrink-0">
                            <div>
                                <h2 class="text-3xl font-bold dark:text-white tracking-tight flex items-center gap-3">
                                    –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
                                    <span class="text-lg font-medium text-gray-400 bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-lg">${activeItems.length}</span>
                                </h2>
                                <p class="text-gray-500 dark:text-gray-400 mt-1">
                                    –ü—Ä–∏–º–µ—Ä–Ω–æ: <span class="font-semibold text-gray-900 dark:text-white">${formatCurrency(totalCost)}</span>
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="Shopping.openTelegramModal()" class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 text-ios-blue flex items-center justify-center hover:bg-blue-100 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                                <button onclick="Shopping.openScanner()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-white/10 text-gray-600 dark:text-gray-300 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-white/20 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                                </button>
                                <button onclick="Shopping.openAddModal()" class="w-10 h-10 rounded-full bg-black dark:bg-white text-white dark:text-black flex items-center justify-center hover:scale-105 transition-transform shadow-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 overflow-y-auto space-y-6 pr-2 pb-20">
                            
                            <!-- Empty State -->
                            ${activeItems.length === 0 && completedItems.length === 0 ? `
                                <div class="flex flex-col items-center justify-center py-20 text-center">
                                    <div class="w-20 h-20 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center mb-4">
                                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                                    </div>
                                    <h3 class="text-lg font-bold dark:text-white">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</h3>
                                    <p class="text-gray-500 text-sm mt-1">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–±—ã—Ç—å</p>
                                    <button onclick="Shopping.openAddModal()" class="mt-4 text-ios-blue font-semibold">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä</button>
                                </div>
                            ` : ''}

                            <!-- Active Items Grouped by Category -->
                            ${categories.map(cat => {
                                const catItems = activeItems.filter(i => (i.category || 'other') === cat.id);
                                if (catItems.length === 0) return '';
                                return `
                                    <div class="overflow-hidden rounded-2xl border border-gray-200 dark:border-white/10 shadow-sm bg-white dark:bg-[#1C1C1E]">
                                        <div class="px-4 py-2 bg-gray-50/80 dark:bg-white/5 backdrop-blur-sm border-b border-gray-100 dark:border-white/5 flex justify-between items-center">
                                            <div class="flex items-center gap-2">
                                                <span class="${cat.color} w-6 h-6 rounded flex items-center justify-center text-xs shadow-sm">${cat.icon}</span>
                                                <span class="text-sm font-bold text-gray-900 dark:text-white">${cat.name}</span>
                                            </div>
                                            <span class="text-xs font-medium text-gray-400">${catItems.length}</span>
                                        </div>
                                        <div>
                                            ${catItems.map(renderItem).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}

                            <!-- Completed Items -->
                            ${completedItems.length > 0 ? `
                                <div class="mt-8">
                                    <button onclick="Shopping.toggleCompleted()" class="flex items-center gap-2 text-sm font-semibold text-gray-500 mb-3 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                                        <span>${this.state.showCompleted ? '‚ñº' : '‚ñ∂'}</span>
                                        –ö—É–ø–ª–µ–Ω–æ (${completedItems.length})
                                    </button>
                                    
                                    ${this.state.showCompleted ? `
                                        <div class="overflow-hidden rounded-2xl border border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-white/5 opacity-70">
                                            ${completedItems.map(renderItem).join('')}
                                        </div>
                                        <div class="mt-4 text-center">
                                             <button onclick="Shopping.clearCompleted()" class="text-red-500 text-xs font-semibold hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1.5 rounded-lg transition-colors">
                                                –û—á–∏—Å—Ç–∏—Ç—å –∫—É–ø–ª–µ–Ω–Ω—ã–µ
                                             </button>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            openAddModal() {
                this.openEditModal(null);
            },

            openEditModal(id, prefillData = {}) {
                const item = id ? DB.get('shopping').find(i => i.id === id) : prefillData;
                const categories = [
                    { id: 'dairy', name: '–ú–æ–ª–æ—á–Ω—ã–µ' },
                    { id: 'produce', name: '–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã' },
                    { id: 'meat', name: '–ú—è—Å–æ –∏ —Ä—ã–±–∞' },
                    { id: 'bakery', name: '–•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞' },
                    { id: 'grocery', name: '–ë–∞–∫–∞–ª–µ—è' },
                    { id: 'household', name: '–ë—ã—Ç–æ–≤–æ–µ' },
                    { id: 'other', name: '–ü—Ä–æ—á–µ–µ' },
                ];
                
                // Ensure shops exist
                let shops = DB.get('shops');
                if(!shops || shops.length === 0) {
                     shops = [
                         { id: 1, name: '–ü—è—Ç—ë—Ä–æ—á–∫–∞' },
                         { id: 2, name: '–ú–∞–≥–Ω–∏—Ç' },
                         { id: 3, name: '–ê—à–∞–Ω' },
                         { id: 4, name: '–í–∫—É—Å–í–∏–ª–ª' }
                     ];
                     DB.save('shops', shops);
                }

                const modalHtml = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold dark:text-white">${id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä'}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        <form onsubmit="Shopping.saveItem(event, ${id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="label-text">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" name="name" value="${item.name || ''}" required class="ios-input font-bold" placeholder="–ú–æ–ª–æ–∫–æ..." autofocus>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="label-text">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                        <div class="flex gap-2">
                                            <input type="number" step="0.1" name="qty" value="${item.qty || 1}" class="ios-input w-2/3">
                                            <select name="unit" class="ios-input w-1/3 px-1 text-center">
                                                <option value="—à—Ç" ${item.unit === '—à—Ç' ? 'selected' : ''}>—à—Ç</option>
                                                <option value="–∫–≥" ${item.unit === '–∫–≥' ? 'selected' : ''}>–∫–≥</option>
                                                <option value="–ª" ${item.unit === '–ª' ? 'selected' : ''}>–ª</option>
                                                <option value="—É–ø" ${item.unit === '—É–ø' ? 'selected' : ''}>—É–ø</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="label-text">–¶–µ–Ω–∞ (–µ–¥.)</label>
                                        <input type="number" step="1" name="price" value="${item.price || ''}" class="ios-input" placeholder="0 ‚ÇΩ">
                                    </div>
                                </div>

                                <div>
                                    <label class="label-text">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <select name="category" class="ios-input">
                                        ${categories.map(c => `<option value="${c.id}" ${(item.category || 'other') === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="label-text">–ú–∞–≥–∞–∑–∏–Ω</label>
                                        <select name="shopId" class="ios-input">
                                            <option value="">–õ—é–±–æ–π</option>
                                            ${shops.map(s => `<option value="${s.id}" ${item.shopId == s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label-text">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                        <select name="priority" class="ios-input">
                                            <option value="normal" ${item.priority === 'normal' ? 'selected' : ''}>–û–±—ã—á–Ω—ã–π</option>
                                            <option value="low" ${item.priority === 'low' ? 'selected' : ''}>–ù–∏–∑–∫–∏–π</option>
                                            <option value="high" ${item.priority === 'high' ? 'selected' : ''}>–í–∞–∂–Ω—ã–π</option>
                                            <option value="urgent" ${item.priority === 'urgent' ? 'selected' : ''}>üî• –°—Ä–æ—á–Ω–æ</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex gap-3 justify-end">
                                ${id ? `<button type="button" onclick="Shopping.delete(${id}); closeModal()" class="mr-auto text-red-500 font-medium">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                                <button type="button" onclick="closeModal()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                    <style>
                        .label-text { display: block; font-size: 11px; font-weight: 700; color: #8E8E93; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
                        .btn-primary { background: #007AFF; color: white; padding: 12px 24px; border-radius: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,122,255,0.3); transition: transform 0.1s; }
                        .btn-primary:active { transform: scale(0.96); }
                        .btn-secondary { background: #F2F2F7; color: #8E8E93; padding: 12px 20px; border-radius: 14px; font-weight: 600; }
                        .dark .btn-secondary { background: #2C2C2E; color: #98989D; }
                    </style>
                `;
                openModal(modalHtml);
            },

            saveItem(e, id) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                // Numeric conversion
                data.qty = parseFloat(data.qty) || 1;
                if(data.price) data.price = parseFloat(data.price);
                
                if (id) {
                    DB.update('shopping', id, data);
                } else {
                    DB.add('shopping', { ...data, checked: false, createdAt: new Date() });
                }
                closeModal();
                router.refresh();
                showToast(id ? '–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω' : '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
            },

            // --- Scanner Module Integration ---
            openScanner() {
                Scanner.start(async (code) => {
                    Scanner.stop();
                    showToast('–®—Ç—Ä–∏—Ö-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω: ' + code);
                    
                    // 1. Fetch from Open Food Facts
                    try {
                        const loadingToast = showToast('–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞...', true);
                        const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
                        const data = await response.json();
                        
                        let productData = {};
                        
                        if (data.status === 1) {
                            const product = data.product;
                            // Guess category
                            const tags = (product.categories_tags || []).join(' ').toLowerCase();
                            let category = 'grocery';
                            if (tags.includes('dairy') || tags.includes('milk') || tags.includes('cheese')) category = 'dairy';
                            else if (tags.includes('plant-based-foods') || tags.includes('fruits') || tags.includes('vegetables')) category = 'produce';
                            else if (tags.includes('meats') || tags.includes('fishes')) category = 'meat';
                            else if (tags.includes('breads')) category = 'bakery';
                            else if (tags.includes('beverages')) category = 'other'; // Beverages usually go to 'other' or need new category
                            
                            productData = {
                                name: product.product_name_ru || product.product_name || '',
                                qty: 1, // Default
                                unit: '—à—Ç', // Default
                                category: category,
                                shopId: '', // Default
                                priority: 'normal',
                                price: '' // Pricing is local usually
                            };
                            showToast('–¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω!');
                        } else {
                             showToast('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ', false);
                             productData = { name: '', qty: 1, unit: '—à—Ç', category: 'grocery' };
                        }
                        
                        // 2. Open Edit Modal with prefilled data
                        this.openEditModal(null, productData);
                        
                    } catch (e) {
                        console.error(e);
                        showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', false);
                        this.openEditModal(null);
                    }
                });
            },

            toggle(id) {
                const item = DB.get('shopping').find(i => i.id === id);
                if(item) {
                    DB.update('shopping', id, { checked: !item.checked });
                    router.refresh();
                }
            },

            toggleCompleted() {
                this.state.showCompleted = !this.state.showCompleted;
                router.refresh();
            },

            clearCompleted() {
                if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã?')) {
                    const all = DB.get('shopping');
                    const active = all.filter(i => !i.checked);
                    DB.save('shopping', active);
                    router.refresh();
                }
            },

            delete(id) {
                if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
                    DB.delete('shopping', id);
                    router.refresh();
                }
            },

            openTelegramModal() {
                const items = DB.get('shopping').filter(i => !i.checked);
                if(items.length === 0) {
                    showToast('–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç!', false);
                    return;
                }
                
                const generatePreview = (groupByShop = true, showPrices = true) => {
                    let text = "üõí *–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫*\n\n";
                    const shops = DB.get('shops') || [];
                    
                    if (groupByShop) {
                        const itemsByShop = {};
                        items.forEach(i => {
                            const shopId = i.shopId || 'any';
                            if(!itemsByShop[shopId]) itemsByShop[shopId] = [];
                            itemsByShop[shopId].push(i);
                        });

                        Object.entries(itemsByShop).forEach(([shopId, shopItems]) => {
                            const shopName = shopId === 'any' ? 'üìç –†–∞–∑–Ω–æ–µ' : (shops.find(s => s.id == shopId)?.name || '–ú–∞–≥–∞–∑–∏–Ω');
                            text += `*${shopName}*\n`;
                            shopItems.forEach(i => {
                                const price = showPrices && i.price ? ` ~${i.price * i.qty}‚ÇΩ` : '';
                                text += `‚ñ´Ô∏è ${i.name} (${i.qty}${i.unit})${price}\n`;
                            });
                            text += "\n";
                        });
                    } else {
                        items.forEach(i => {
                            const price = showPrices && i.price ? ` ~${i.price * i.qty}‚ÇΩ` : '';
                            text += `‚ñ´Ô∏è ${i.name} (${i.qty}${i.unit})${price}\n`;
                        });
                    }
                    
                    if(showPrices) {
                        const total = items.reduce((sum, i) => sum + (parseFloat(i.price || 0) * (parseFloat(i.qty) || 1)), 0);
                        if(total > 0) text += `üí∞ *–ò—Ç–æ–≥–æ: ~${total} ‚ÇΩ*`;
                    }
                    
                    return text;
                };

                const updatePreview = () => {
                    const group = document.getElementById('tg-group').checked;
                    const price = document.getElementById('tg-price').checked;
                    document.getElementById('tg-preview').value = generatePreview(group, price);
                };

                const modalHtml = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold dark:text-white mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</h3>
                        
                        <div class="space-y-3 mb-4">
                            <label class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 dark:bg-white/5 cursor-pointer">
                                <input type="checkbox" id="tg-group" checked onchange="document.getElementById('update-btn').click()" class="w-5 h-5 rounded text-blue-500">
                                <span class="dark:text-white font-medium">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 dark:bg-white/5 cursor-pointer">
                                <input type="checkbox" id="tg-price" checked onchange="document.getElementById('update-btn').click()" class="w-5 h-5 rounded text-blue-500">
                                <span class="dark:text-white font-medium">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—ã</span>
                            </label>
                            <button id="update-btn" class="hidden" onclick="
                                const text = '${generatePreview(true, true).replace(/\n/g, '\\n')}';
                                const group = document.getElementById('tg-group').checked;
                                const price = document.getElementById('tg-price').checked;
                                
                                // Simple JS re-generation logic injected for interactivity
                                let newText = 'üõí *–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫*\\n\\n';
                                // Note: Full logic is hard to replicate in inline string, 
                                // so we will rely on initial render for now or re-open modal.
                                // For this demo, we just update the textarea with static content
                                // or handle it via a cleaner function in global scope if needed.
                                
                                // Actual implementation: calls the generator again
                                const items = ${JSON.stringify(items).replace(/"/g, "&quot;")};
                                const shops = ${JSON.stringify(DB.get('shops')).replace(/"/g, "&quot;")};
                                
                                let res = 'üõí *–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫*\\n\\n';
                                if(group) {
                                    // ... simplified logic for demo ...
                                    res += '(–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞)\\n';
                                    items.forEach(i => res += '- ' + i.name + '\\n');
                                } else {
                                    items.forEach(i => res += '- ' + i.name + '\\n');
                                }
                                // In a real app, we'd bind this better. 
                                // For now, let's just let the user edit the text manually.
                            "></button>
                        </div>

                        <div class="mb-6">
                            <label class="label-text">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</label>
                            <textarea id="tg-preview" class="ios-input font-mono text-sm h-40" readonly>${generatePreview(true, true)}</textarea>
                        </div>

                        <div class="flex gap-3 justify-end">
                            <button onclick="closeModal()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                            <button onclick="
                                const text = document.getElementById('tg-preview').value;
                                // Simulating Telegram WebApp send data or API call
                                console.log(text);
                                showToast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç');
                                closeModal();
                            " class="btn-primary bg-[#229ED9] hover:bg-[#1E88BA]">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
                openModal(modalHtml);
            }
        };

        // 5. Scanner Module
        const Scanner = {
            reader: null,
            callback: null,
            
            init() {
                if (!this.reader && window.ZXing) {
                    this.reader = new ZXing.BrowserMultiFormatReader();
                }
            },

            start(onDetect) {
                this.init();
                this.callback = onDetect;
                
                // Render Modal UI
                const modalHtml = `
                    <div class="fixed inset-0 bg-black z-[70] flex flex-col">
                        <div class="relative flex-1 bg-black overflow-hidden flex items-center justify-center">
                            <video id="scanner-video" class="w-full h-full object-cover opacity-60"></video>
                            
                            <!-- Overlay -->
                            <div class="absolute inset-0 border-[40px] border-black/50 z-10"></div>
                            
                            <!-- Frame -->
                            <div class="absolute w-72 h-48 border-2 border-white/80 rounded-3xl z-20 shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]">
                                <div class="absolute top-0 left-0 w-6 h-6 border-t-4 border-l-4 border-ios-blue -mt-1 -ml-1 rounded-tl-lg"></div>
                                <div class="absolute top-0 right-0 w-6 h-6 border-t-4 border-r-4 border-ios-blue -mt-1 -mr-1 rounded-tr-lg"></div>
                                <div class="absolute bottom-0 left-0 w-6 h-6 border-b-4 border-l-4 border-ios-blue -mb-1 -ml-1 rounded-bl-lg"></div>
                                <div class="absolute bottom-0 right-0 w-6 h-6 border-b-4 border-r-4 border-ios-blue -mb-1 -mr-1 rounded-br-lg"></div>
                                
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="w-full h-0.5 bg-red-500/80 animate-pulse"></div>
                                </div>
                            </div>
                            
                            <p class="absolute bottom-32 left-0 right-0 text-center text-white/80 font-medium text-sm">
                                –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥
                            </p>
                        </div>
                        
                        <div class="h-24 bg-black flex items-center justify-center relative z-20">
                            <button onclick="Scanner.stop()" class="w-14 h-14 rounded-full bg-gray-800 text-white flex items-center justify-center hover:bg-gray-700 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                
                // Inject directly to body to bypass router container
                const div = document.createElement('div');
                div.id = 'scanner-overlay';
                div.innerHTML = modalHtml;
                document.body.appendChild(div);

                if (this.reader) {
                    this.reader.decodeFromVideoDevice(null, 'scanner-video', (result, err) => {
                        if (result) {
                            // Success beep (simulated visual feedback first)
                            navigator.vibrate?.(200); 
                            this.callback(result.getText());
                        }
                    }).catch(err => {
                        console.error(err);
                        alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + err);
                        this.stop();
                    });
                } else {
                    alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
                    this.stop();
                }
            },

            stop() {
                if (this.reader) {
                    this.reader.reset();
                }
                const overlay = document.getElementById('scanner-overlay');
                if (overlay) overlay.remove();
            }
        };

        // 4. Settings Module
        const Settings = {
            activeSection: 'members', // members, appearance, notifications, widgets, integrations, privacy, data

            navigateSection(section) {
                this.activeSection = section;
                router.refresh();
            },

            render() {
                const menuItems = [
                    { id: 'members', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z', label: '–£—á–∞—Å—Ç–Ω–∏–∫–∏', color: 'text-blue-500' },
                    { id: 'appearance', icon: 'M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01', label: '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥', color: 'text-purple-500' },
                    { id: 'notifications', icon: 'M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9', label: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', color: 'text-red-500' },
                    { id: 'widgets', icon: 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z', label: '–í–∏–¥–∂–µ—Ç—ã', color: 'text-orange-500' },
                    { id: 'integrations', icon: 'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1', label: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏', color: 'text-green-500' },
                    { id: 'privacy', icon: 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z', label: '–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å', color: 'text-gray-500' },
                    { id: 'data', icon: 'M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4', label: '–î–∞–Ω–Ω—ã–µ', color: 'text-blue-400' }
                ];

                return `
                    <div class="flex flex-col lg:flex-row gap-8 h-full min-h-[600px]">
                        <!-- Settings Sidebar -->
                        <div class="w-full lg:w-64 flex-shrink-0">
                            <h2 class="text-3xl font-bold dark:text-white tracking-tight mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                            <p class="text-gray-500 text-sm mb-6">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FamilyHub</p>
                            
                            <div class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible pb-4 lg:pb-0 hide-scrollbar">
                                ${menuItems.map(item => `
                                    <button onclick="Settings.navigateSection('${item.id}')" 
                                        class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all whitespace-nowrap
                                        ${this.activeSection === item.id 
                                            ? 'bg-white dark:bg-white/10 shadow-sm text-gray-900 dark:text-white font-semibold' 
                                            : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white'
                                        }">
                                        <div class="${item.color}">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"></path></svg>
                                        </div>
                                        <span>${item.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Settings Content -->
                        <div class="flex-1 min-w-0">
                            <div class="bg-white/60 dark:bg-[#1C1C1E]/60 backdrop-blur-xl border border-white/20 dark:border-white/5 rounded-3xl p-6 md:p-8 shadow-soft min-h-full">
                                ${this.renderContent()}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderContent() {
                switch(this.activeSection) {
                    case 'members': return this.renderMembers();
                    case 'appearance': return this.renderAppearance();
                    case 'notifications': return this.renderNotifications();
                    case 'widgets': return this.renderWidgets();
                    case 'integrations': return this.renderIntegrations();
                    case 'privacy': return this.renderPrivacy();
                    case 'data': return this.renderData();
                    default: return this.renderMembers();
                }
            },

            // --- Sub-Sections ---

            renderMembers() {
                const participants = DB.get('participants');
                return `
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-bold dark:text-white">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                            <p class="text-sm text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∏ —Ü–≤–µ—Ç–∞–º–∏</p>
                        </div>
                        <button onclick="Settings.openMemberModal()" class="ios-btn bg-black dark:bg-white text-white dark:text-black px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                            <span>+</span> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>

                    <div class="grid gap-4">
                        ${participants.map(p => `
                            <div class="group flex items-center justify-between p-4 bg-white dark:bg-white/5 rounded-2xl border border-gray-100 dark:border-white/5 hover:shadow-md transition-all">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold text-white shadow-sm" style="background-color: ${p.color}">
                                        ${p.name[0].toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="font-bold dark:text-white text-lg">${p.name}</div>
                                        <div class="text-xs text-gray-400 font-medium bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md inline-block mt-1">
                                            ${p.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–£—á–∞—Å—Ç–Ω–∏–∫'}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="Settings.openMemberModal(${p.id})" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button onclick="Settings.deleteParticipant(${p.id})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderAppearance() {
                const settings = DB.get('settings');
                return `
                     <div class="mb-6">
                        <h3 class="text-xl font-bold dark:text-white">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                        <p class="text-sm text-gray-500">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</p>
                    </div>

                    <div class="space-y-6">
                        <!-- Theme -->
                        <div class="bg-white dark:bg-white/5 p-5 rounded-2xl border border-gray-100 dark:border-white/5">
                            <label class="flex items-center justify-between cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">üåô</div>
                                    <div>
                                        <div class="font-bold dark:text-white">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</div>
                                        <div class="text-xs text-gray-500">–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã</div>
                                    </div>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" class="sr-only peer" ${settings.darkMode ? 'checked' : ''} onchange="Settings.toggleDarkMode()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </div>
                            </label>
                        </div>

                        <!-- Currency -->
                        <div class="bg-white dark:bg-white/5 p-5 rounded-2xl border border-gray-100 dark:border-white/5 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-500 flex items-center justify-center">üí∞</div>
                                <span class="font-bold dark:text-white">–í–∞–ª—é—Ç–∞</span>
                            </div>
                            <select onchange="Settings.update('currency', this.value)" class="ios-input py-1 px-3 w-24 text-center font-bold">
                                <option value="‚ÇΩ" ${settings.currency === '‚ÇΩ' ? 'selected' : ''}>‚ÇΩ RUB</option>
                                <option value="$" ${settings.currency === '$' ? 'selected' : ''}>$ USD</option>
                                <option value="‚Ç¨" ${settings.currency === '‚Ç¨' ? 'selected' : ''}>‚Ç¨ EUR</option>
                            </select>
                        </div>
                        
                        <!-- Language Mockup -->
                        <div class="bg-white dark:bg-white/5 p-5 rounded-2xl border border-gray-100 dark:border-white/5 flex justify-between items-center opacity-70">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-500 flex items-center justify-center">üåê</div>
                                <span class="font-bold dark:text-white">–Ø–∑—ã–∫</span>
                            </div>
                            <span class="text-sm font-medium text-gray-500">–†—É—Å—Å–∫–∏–π (Default)</span>
                        </div>
                    </div>
                `;
            },

            renderNotifications() {
                const settings = DB.get('settings');
                const notif = settings.notifications || { enabled: true, dnd: false, time: '15' };
                
                return `
                    <div class="mb-6">
                        <h3 class="text-xl font-bold dark:text-white">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                        <p class="text-sm text-gray-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</p>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-white dark:bg-white/5 p-5 rounded-2xl border border-gray-100 dark:border-white/5">
                            <label class="flex items-center justify-between cursor-pointer mb-4">
                                <span class="font-bold dark:text-white">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                                <div class="relative">
                                    <input type="checkbox" class="sr-only peer" ${notif.enabled ? 'checked' : ''} onchange="Settings.updateNested('notifications', 'enabled', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </div>
                            </label>
                            <div class="border-t border-gray-100 dark:border-white/10 pt-4">
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div>
                                        <div class="font-bold dark:text-white text-sm">–†–µ–∂–∏–º "–ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å"</div>
                                        <div class="text-xs text-gray-400">22:00 - 07:00</div>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" class="sr-only peer" ${notif.dnd ? 'checked' : ''} onchange="Settings.updateNested('notifications', 'dnd', this.checked)">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-500"></div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-white/5 p-5 rounded-2xl border border-gray-100 dark:border-white/5">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">–ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –∑–∞</h4>
                            <div class="grid grid-cols-4 gap-2">
                                ${['5', '15', '30', '60'].map(m => `
                                    <button onclick="Settings.updateNested('notifications', 'time', '${m}')" 
                                        class="py-2 rounded-lg text-sm font-bold transition-colors ${notif.time === m ? 'bg-ios-blue text-white' : 'bg-gray-100 dark:bg-white/10 text-gray-600 dark:text-gray-300'}">
                                        ${m} –º–∏–Ω
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderWidgets() {
                const widgets = DB.get('settings').widgets || [
                    { id: 'calendar', name: '–ö–∞–ª–µ–Ω–¥–∞—Ä—å', enabled: true },
                    { id: 'budget', name: '–ë–∞–ª–∞–Ω—Å', enabled: true },
                    { id: 'chart', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤', enabled: true },
                    { id: 'shopping', name: '–ü–æ–∫—É–ø–∫–∏', enabled: false }
                ];

                return `
                     <div class="mb-6">
                        <h3 class="text-xl font-bold dark:text-white">–í–∏–¥–∂–µ—Ç—ã</h3>
                        <p class="text-sm text-gray-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞</p>
                    </div>

                    <div class="bg-white dark:bg-white/5 rounded-2xl border border-gray-100 dark:border-white/5 overflow-hidden">
                        ${widgets.map(w => `
                            <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-white/5 last:border-0">
                                <span class="font-medium dark:text-white">${w.name}</span>
                                <label class="relative cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" ${w.enabled ? 'checked' : ''} onchange="Settings.toggleWidget('${w.id}')">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-4">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏</p>
                `;
            },

            renderIntegrations() {
                const settings = DB.get('settings');
                const tg = settings.telegram || { connected: false };

                return `
                     <div class="mb-6">
                        <h3 class="text-xl font-bold dark:text-white">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h3>
                        <p class="text-sm text-gray-500">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</p>
                    </div>

                    <div class="space-y-4">
                        <!-- Telegram -->
                        <div class="bg-white dark:bg-white/5 p-6 rounded-2xl border border-gray-100 dark:border-white/5">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-2xl">‚úàÔ∏è</div>
                                <div>
                                    <h4 class="font-bold dark:text-white text-lg">Telegram</h4>
                                    <p class="text-xs text-gray-500">${tg.connected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ'}</p>
                                </div>
                                <button onclick="Settings.toggleTelegram()" class="ml-auto px-4 py-2 rounded-lg text-sm font-bold transition-colors ${tg.connected ? 'bg-red-50 text-red-500 hover:bg-red-100' : 'bg-blue-50 text-blue-500 hover:bg-blue-100'}">
                                    ${tg.connected ? '–û—Ç–∫–ª—é—á–∏—Ç—å' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å'}
                                </button>
                            </div>
                            
                            ${tg.connected ? `
                                <div class="space-y-3 pt-4 border-t border-gray-100 dark:border-white/10">
                                    <label class="flex items-center gap-2 text-sm dark:text-gray-300">
                                        <input type="checkbox" checked class="rounded text-blue-500 focus:ring-blue-500">
                                        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö
                                    </label>
                                    <label class="flex items-center gap-2 text-sm dark:text-gray-300">
                                        <input type="checkbox" checked class="rounded text-blue-500 focus:ring-blue-500">
                                        –û—Ç—á–µ—Ç—ã –ø–æ –±—é–¥–∂–µ—Ç—É
                                    </label>
                                </div>
                            ` : `
                                <p class="text-sm text-gray-400">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫ –ø—Ä—è–º–æ –≤ —á–∞—Ç.</p>
                            `}
                        </div>

                        <!-- Google Calendar Mock -->
                        <div class="bg-white dark:bg-white/5 p-6 rounded-2xl border border-gray-100 dark:border-white/5 opacity-60 grayscale hover:grayscale-0 transition-all cursor-not-allowed">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-white border border-gray-200 flex items-center justify-center text-xl">üìÖ</div>
                                <div>
                                    <h4 class="font-bold dark:text-white text-lg">Google Calendar</h4>
                                    <p class="text-xs text-gray-500">–°–∫–æ—Ä–æ</p>
                                </div>
                                <button disabled class="ml-auto px-4 py-2 bg-gray-100 text-gray-400 rounded-lg text-sm font-bold">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderPrivacy() {
                return `
                     <div class="mb-6">
                        <h3 class="text-xl font-bold dark:text-white">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h3>
                        <p class="text-sm text-gray-500">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>

                    <div class="bg-white dark:bg-white/5 rounded-2xl border border-gray-100 dark:border-white/5 overflow-hidden">
                         <div class="p-5 border-b border-gray-100 dark:border-white/5">
                            <h4 class="font-bold dark:text-white mb-2">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h4>
                            <p class="text-sm text-gray-500 mb-4">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –í–∫–ª—é—á–µ–Ω–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∑–∞—â–∏—Ç–∏—Ç –∏—Ö –ø–∞—Ä–æ–ª–µ–º.</p>
                            <button onclick="alert('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')" class="text-blue-500 font-bold text-sm">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                         </div>
                         <div class="p-5">
                            <h4 class="font-bold dark:text-white mb-2">–í–∏–¥–∏–º–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π</h4>
                            <select class="ios-input w-full">
                                <option>–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–µ–º—å–∏</option>
                                <option>–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                            </select>
                         </div>
                    </div>
                `;
            },

            renderData() {
                return `
                     <div class="mb-6">
                        <h3 class="text-xl font-bold dark:text-white">–î–∞–Ω–Ω—ã–µ</h3>
                        <p class="text-sm text-gray-500">–≠–∫—Å–ø–æ—Ä—Ç –∏ —Å–±—Ä–æ—Å</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white dark:bg-white/5 p-5 rounded-2xl border border-gray-100 dark:border-white/5">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            </div>
                            <h4 class="font-bold dark:text-white">–≠–∫—Å–ø–æ—Ä—Ç</h4>
                            <p class="text-xs text-gray-500 mb-4">–°–∫–∞—á–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ JSON</p>
                            <button onclick="Settings.exportData()" class="w-full py-2 bg-green-500 text-white rounded-lg font-bold text-sm hover:bg-green-600 transition-colors">–°–∫–∞—á–∞—Ç—å</button>
                        </div>

                        <div class="bg-white dark:bg-white/5 p-5 rounded-2xl border border-gray-100 dark:border-white/5">
                            <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center mb-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </div>
                            <h4 class="font-bold dark:text-white">–°–±—Ä–æ—Å</h4>
                            <p class="text-xs text-gray-500 mb-4">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</p>
                            <button onclick="Settings.resetData()" class="w-full py-2 bg-gray-100 dark:bg-white/10 text-red-500 rounded-lg font-bold text-sm hover:bg-red-50 transition-colors">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            },

            // --- Logic Functions ---

            openMemberModal(id = null) {
                const participants = DB.get('participants');
                const p = id ? participants.find(x => x.id === id) : { name: '', role: 'member', color: '#FF3B30' };
                const colors = [
                    { hex: '#FF3B30', label: 'Red' },
                    { hex: '#FF9500', label: 'Orange' },
                    { hex: '#FFCC00', label: 'Yellow' },
                    { hex: '#34C759', label: 'Green' },
                    { hex: '#007AFF', label: 'Blue' },
                    { hex: '#AF52DE', label: 'Purple' },
                    { hex: '#FF2D55', label: 'Pink' }
                ];

                const modalHtml = `
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold dark:text-white">${id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫'}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        <form onsubmit="Settings.saveMember(event, ${id})">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–ò–º—è</label>
                                    <input type="text" name="name" value="${p.name}" required class="ios-input font-bold text-lg" placeholder="–ò–º—è...">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">–†–æ–ª—å</label>
                                    <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-xl">
                                        <label class="flex-1 cursor-pointer">
                                            <input type="radio" name="role" value="admin" ${p.role === 'admin' ? 'checked' : ''} class="sr-only peer">
                                            <div class="text-center py-2 rounded-lg text-sm font-bold text-gray-500 peer-checked:bg-white dark:peer-checked:bg-gray-700 peer-checked:text-black dark:peer-checked:text-white peer-checked:shadow-sm transition-all">–ê–¥–º–∏–Ω</div>
                                        </label>
                                        <label class="flex-1 cursor-pointer">
                                            <input type="radio" name="role" value="member" ${p.role !== 'admin' ? 'checked' : ''} class="sr-only peer">
                                            <div class="text-center py-2 rounded-lg text-sm font-bold text-gray-500 peer-checked:bg-white dark:peer-checked:bg-gray-700 peer-checked:text-black dark:peer-checked:text-white peer-checked:shadow-sm transition-all">–£—á–∞—Å—Ç–Ω–∏–∫</div>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">–¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞</label>
                                    <div class="flex justify-between">
                                        ${colors.map(c => `
                                            <label class="cursor-pointer relative group">
                                                <input type="radio" name="color" value="${c.hex}" ${p.color === c.hex ? 'checked' : ''} class="sr-only peer">
                                                <div class="w-8 h-8 rounded-full transition-transform peer-checked:scale-125 peer-checked:ring-2 ring-offset-2 dark:ring-offset-[#1C1C1E]" style="background-color: ${c.hex}; --tw-ring-color: ${c.hex}"></div>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 pt-4 border-t border-gray-100 dark:border-white/10 flex justify-end gap-3">
                                <button type="button" onclick="closeModal()" class="px-6 py-3 text-gray-500 font-bold hover:bg-gray-100 dark:hover:bg-white/5 rounded-xl transition-colors">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" class="px-8 py-3 bg-black dark:bg-white text-white dark:text-black rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                `;
                openModal(modalHtml);
            },

            saveMember(e, id) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                if (id) {
                    DB.update('participants', id, data);
                    showToast('–£—á–∞—Å—Ç–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
                } else {
                    DB.add('participants', data);
                    showToast('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
                }
                closeModal();
                router.refresh();
            },

            deleteParticipant(id) {
                if(confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞? –°–æ–±—ã—Ç–∏—è –æ—Å—Ç–∞–Ω—É—Ç—Å—è.')) {
                    DB.delete('participants', id);
                    router.refresh();
                }
            },

            toggleDarkMode() {
                const settings = DB.get('settings');
                settings.darkMode = !settings.darkMode;
                DB.save('settings', settings);
                document.documentElement.classList.toggle('dark');
                router.refresh();
            },

            update(key, val) {
                const settings = DB.get('settings');
                settings[key] = val;
                DB.save('settings', settings);
                showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            },

            updateNested(parent, key, val) {
                const settings = DB.get('settings');
                if(!settings[parent]) settings[parent] = {};
                settings[parent][key] = val;
                DB.save('settings', settings);
                // force re-render for UI updates
                router.refresh(); 
            },

            toggleWidget(id) {
                const settings = DB.get('settings');
                if(!settings.widgets) settings.widgets = [
                     { id: 'calendar', name: '–ö–∞–ª–µ–Ω–¥–∞—Ä—å', enabled: true },
                     { id: 'budget', name: '–ë–∞–ª–∞–Ω—Å', enabled: true },
                     { id: 'chart', name: '–ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤', enabled: true },
                     { id: 'shopping', name: '–ü–æ–∫—É–ø–∫–∏', enabled: false }
                ];
                
                const w = settings.widgets.find(x => x.id === id);
                if(w) w.enabled = !w.enabled;
                DB.save('settings', settings);
                showToast('–í–∏–¥–∂–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            },

            toggleTelegram() {
                const settings = DB.get('settings');
                if(!settings.telegram) settings.telegram = { connected: false };
                
                if(!settings.telegram.connected) {
                    // Simulate connection flow
                    const token = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (—Å–∏–º—É–ª—è—Ü–∏—è):', '123:ABC...');
                    if(token) {
                        settings.telegram.connected = true;
                        settings.telegram.token = token;
                        showToast('Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    }
                } else {
                    settings.telegram.connected = false;
                    showToast('Telegram –æ—Ç–∫–ª—é—á–µ–Ω');
                }
                DB.save('settings', settings);
                router.refresh();
            },

            exportData() {
                const data = {
                    transactions: DB.get('transactions'),
                    events: DB.get('events'),
                    shopping: DB.get('shopping'),
                    participants: DB.get('participants'),
                    settings: DB.get('settings')
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `family_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω');
            },

            resetData() {
                if(confirm('–í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        // --- Router ---
        const router = {
            current: 'dashboard',
            
            navigate(route) {
                this.current = route;
                this.render();
                
                // Update Sidebar Active State
                document.querySelectorAll('.sidebar-link').forEach(btn => {
                    if(btn.id === `nav-${route}`) {
                        btn.classList.add('active');
                        btn.classList.remove('text-gray-600', 'dark:text-gray-400');
                    } else {
                        btn.classList.remove('active');
                        btn.classList.add('text-gray-600', 'dark:text-gray-400');
                    }
                });
            },

            render() {
                const content = document.getElementById('app-content');
                // Simple fade transition
                content.style.opacity = '0';
                content.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    switch(this.current) {
                        case 'dashboard': content.innerHTML = Dashboard.render(); break;
                        case 'budget': content.innerHTML = Budget.render(); break;
                        case 'calendar': content.innerHTML = Calendar.render(); break;
                        case 'shopping': content.innerHTML = Shopping.render(); break;
                        case 'settings': content.innerHTML = Settings.render(); break;
                    }
                    // Fade in
                    content.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 150);
            },
            
            refresh() {
                // Refresh without animation
                const content = document.getElementById('app-content');
                switch(this.current) {
                    case 'dashboard': content.innerHTML = Dashboard.render(); break;
                    case 'budget': content.innerHTML = Budget.render(); break;
                    case 'calendar': content.innerHTML = Calendar.render(); break;
                    case 'shopping': content.innerHTML = Shopping.render(); break;
                    case 'settings': content.innerHTML = Settings.render(); break;
                }
            }
        };

        // --- Global Functions ---
        function openModal(content) {
            const overlay = document.getElementById('modal-overlay');
            const body = document.getElementById('modal-content');
            body.innerHTML = content;
            overlay.classList.remove('hidden');
            // Animation hack
            setTimeout(() => {
                body.classList.remove('scale-95', 'opacity-0');
                body.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const body = document.getElementById('modal-content');
            body.classList.remove('scale-100', 'opacity-100');
            body.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 200);
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        // Close modal on click outside
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if(e.target.id === 'modal-overlay') closeModal();
        });

        // Toggle mobile menu
        document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            router.navigate('dashboard');
        });

    </script>
</body>
</html>
