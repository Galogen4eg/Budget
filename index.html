<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Семейный бюджет</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4361ee;
      --accent: #06d6a0;
      --error: #ef476f;
      --surface: #ffffff;
      --surface-light: #f8fafc;
      --text: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f1f5f9;
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* Header */
    header {
      background: var(--surface);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .tabs-container {
      display: flex;
      justify-content: center;
      padding: 16px 0;
      position: relative;
    }

    .tabs {
      display: flex;
      gap: 8px;
      background: #f1f5f9;
      padding: 6px;
      border-radius: 16px;
      max-width: 500px;
    }

    .tab {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
    }

    .tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.25);
    }

    .tab:not(.active):hover {
      color: var(--text);
    }

    .settings-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: var(--surface-light);
      transform: rotate(90deg);
    }

    /* Main Content */
    main {
      padding: 24px 0 40px;
    }

    .section {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }

    .section-title i {
      color: var(--primary);
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Tiles */
    .tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .tile {
      background: var(--surface);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }

    .tile:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }

    .tile-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .tile-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
    }

    .tile-value.positive { color: var(--success); }
    .tile-value.negative { color: var(--error); }
    .tile-value.primary { color: var(--primary); }

    /* Calendar Controls */
    .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .calendar-title {
      font-size: 18px;
      font-weight: 700;
    }

    .nav-buttons {
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: white;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      background: var(--surface-light);
    }

    /* Calendar */
    .calendar-container {
      overflow-x: auto;
    }

    .calendar {
      min-width: 700px;
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .calendar th {
      padding: 12px 8px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      background: var(--surface-light);
    }

    .calendar td {
      width: 14.28%;
      height: 70px;
      vertical-align: top;
      padding: 6px;
      text-align: right;
      position: relative;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .calendar td:hover {
      background: var(--surface-light);
    }

    .calendar-date {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      border-radius: 50%;
      font-weight: 500;
    }

    .calendar-date.has-transaction {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }

    .transaction-dot {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 6px;
      height: 6px;
      background-color: var(--primary);
      border-radius: 50%;
    }

    /* Categories */
    .categories {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--surface-light);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
    }

    .category-item:hover {
      background: #eef2ff;
    }

    .category-name {
      font-weight: 600;
      color: var(--text);
    }

    .category-amount {
      font-weight: 700;
    }

    .category-amount.positive { color: var(--success); }
    .category-amount.negative { color: var(--error); }

    /* Transactions */
    .transactions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .period-buttons {
      display: flex;
      gap: 8px;
    }

    .period-btn {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
    }

    .period-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .transactions {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    .transactions th {
      text-align: left;
      padding: 12px 16px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 14px;
      border-bottom: 2px solid var(--border);
    }

    .transactions td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .transaction-row:hover {
      background-color: var(--surface-light);
    }

    .transaction-amount.positive { color: var(--success); }
    .transaction-amount.negative { color: var(--error); }

    .transaction-balance {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
      font-size: 15px;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .btn {
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #3a56e4);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(67, 97, 238, 0.35);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background: var(--surface-light);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--accent), #05c194);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--error), #e53e5f);
      color: white;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-file {
      position: relative;
      overflow: hidden;
    }

    .btn-file input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    /* Shopping */
    .shopping-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 768px) {
      .shopping-grid {
        grid-template-columns: 1fr;
      }
    }

    .shopping-list {
      list-style: none;
    }

    .shopping-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      background: var(--surface-light);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
    }

    .shopping-item:hover {
      background: #eef2ff;
    }

    .item-checkbox {
      margin-right: 16px;
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }

    .item-name {
      flex: 1;
      font-weight: 600;
      color: var(--text);
    }

    .item-quantity {
      color: var(--text-secondary);
      margin-right: 16px;
      font-weight: 500;
    }

    /* Event Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      transform: scale(0.9);
      transition: transform 0.3s;
      margin: 20px;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-modal:hover {
      background: var(--surface-light);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Planner */
    .planner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .view-buttons {
      display: flex;
      gap: 8px;
    }

    .view-btn {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
    }

    .view-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-header-cell {
      background: white;
      padding: 10px;
      text-align: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .calendar-day {
      background: white;
      min-height: 80px;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .calendar-day:hover {
      background: var(--surface-light);
    }

    .calendar-date-number {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .event-item {
      background: #eef2ff;
      border-left: 3px solid var(--primary);
      padding: 6px 8px;
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .event-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .event-time {
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .tabs-container {
        padding: 12px 0;
      }
      
      .tabs {
        gap: 4px;
      }
      
      .tab {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .tile {
        padding: 16px;
      }
      
      .tile-value {
        font-size: 20px;
      }
      
      .section {
        padding: 16px;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .transactions th,
      .transactions td {
        padding: 10px 12px;
        font-size: 14px;
      }
    }

    /* Notification */
    #notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #notification.show {
      opacity: 1;
    }

    /* Participant color dot */
    .participant-color {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="tabs-container">
        <div class="tabs">
          <div class="tab active" data-tab="budget">
            <i class="fas fa-wallet"></i> Бюджет
          </div>
          <div class="tab" data-tab="shopping">
            <i class="fas fa-shopping-cart"></i> Покупки
          </div>
          <div class="tab" data-tab="planner">
            <i class="fas fa-calendar-alt"></i> Планировщик
          </div>
        </div>
        <div class="settings-btn" id="settingsBtn">
          <i class="fas fa-cog"></i>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Budget Tab -->
    <div id="budgetTab" class="tab-content">
      <!-- Balance Tiles -->
      <div class="tiles">
        <div class="tile">
          <div class="tile-title">Текущий баланс</div>
          <div class="tile-value primary">12 450 ₽</div>
        </div>
        <div class="tile">
          <div class="tile-title">Накопления</div>
          <div class="tile-value positive">1 245 ₽</div>
        </div>
        <div class="tile">
          <div class="tile-title">Ежедневный лимит</div>
          <div class="tile-value">1 045 ₽</div>
        </div>
        <div class="tile">
          <div class="tile-title">Обязательные траты</div>
          <div class="tile-value negative">25 650 ₽</div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="section">
        <div class="calendar-controls">
          <div class="calendar-title" id="budgetCalendarTitle">Октябрь 2025</div>
          <div class="nav-buttons">
            <button class="nav-btn" id="prevMonthBtn">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="nav-btn" id="nextMonthBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div class="calendar-container">
          <table class="calendar" id="budgetCalendar">
            <thead>
              <tr>
                <th>Пн</th>
                <th>Вт</th>
                <th>Ср</th>
                <th>Чт</th>
                <th>Пт</th>
                <th>Сб</th>
                <th>Вс</th>
              </tr>
            </thead>
            <tbody id="budgetCalendarBody">
              <!-- Calendar will be generated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Categories -->
      <div class="section">
        <div class="section-title">
          <i class="fas fa-tags"></i> Категории
        </div>
        <div class="categories" id="categoriesList">
          <!-- Categories will be generated by JS -->
        </div>
      </div>

      <!-- Transactions -->
      <div class="section">
        <div class="transactions-header">
          <div class="section-title">
            <i class="fas fa-exchange-alt"></i> История операций
          </div>
          <div class="period-buttons">
            <button class="period-btn active" id="currentMonthBtn">Текущий месяц</button>
            <button class="period-btn" id="allTimeBtn">За всё время</button>
          </div>
        </div>
        <table class="transactions">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Описание</th>
              <th>Категория</th>
              <th>Сумма</th>
              <th>Баланс</th>
            </tr>
          </thead>
          <tbody id="transactionsList">
            <!-- Transactions will be generated by JS -->
          </tbody>
        </table>
        <div style="margin-top: 20px;">
          <label class="btn-file btn-outline">
            <i class="fas fa-file-upload"></i> Загрузить выписку
            <input type="file" id="fileUpload" accept=".xlsx,.xls">
          </label>
          <div class="btn-group" style="margin-top: 12px;">
            <button class="btn btn-success" id="addIncomeBtn">
              Доход
            </button>
            <button class="btn btn-danger" id="addExpenseBtn">
              Расход
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Shopping Tab -->
    <div id="shoppingTab" class="tab-content" style="display: none;">
      <div class="shopping-grid">
        <!-- Left Column -->
        <div>
          <div class="section">
            <div class="section-title">
              <i class="fas fa-plus-circle"></i> Быстрое добавление
            </div>
            <div class="form-group">
              <label class="form-label">Название</label>
              <input type="text" class="form-control" id="itemName" placeholder="Напр., Молоко">
            </div>
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label class="form-label">Количество</label>
                <input type="number" class="form-control" id="itemQuantity" placeholder="1" value="1" min="1">
              </div>
              <div>
                <label class="form-label">Ед. изм.</label>
                <select class="form-control" id="itemUnit">
                  <option value="pcs">шт.</option>
                  <option value="liters">л</option>
                  <option value="grams">г</option>
                  <option value="kg">кг</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" id="addItemBtn" style="width: 100%;">
              Добавить в список
            </button>
          </div>

          <div class="section">
            <div class="section-title">
              <i class="fas fa-chart-bar"></i> Топ покупок
            </div>
            <div id="topShoppingList" style="max-height: 200px; overflow-y: auto;">
              <!-- Top shopping items will be generated by JS -->
            </div>
          </div>
        </div>
        <!-- Right Column -->
        <div>
          <div class="section">
            <div class="section-title">
              <i class="fas fa-list"></i> Список покупок
            </div>
            <ul class="shopping-list" id="shoppingList">
              <!-- Shopping items will be generated by JS -->
            </ul>
            <button class="btn btn-success" id="sendToTelegramBtn" style="width: 100%; margin-top: 16px;">
              <i class="fas fa-paper-plane"></i> Отправить в Telegram
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Planner Tab -->
    <div id="plannerTab" class="tab-content" style="display: none;">
      <div class="section">
        <div class="planner-header">
          <div class="calendar-controls">
            <div class="calendar-title" id="plannerCalendarTitle">Декабрь 2025</div>
            <div class="nav-buttons">
              <button class="nav-btn" id="prevPlannerMonthBtn">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="nav-btn" id="nextPlannerMonthBtn">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="view-buttons">
            <button class="view-btn active" data-view="month">Месяц</button>
            <button class="view-btn" data-view="week">Неделя</button>
            <button class="view-btn" data-view="day">День</button>
          </div>
        </div>
        
        <div class="calendar-grid" id="plannerCalendar">
          <!-- Calendar will be generated by JS -->
        </div>
        
        <!-- Events List -->
        <div class="section" id="eventsListSection">
          <div class="section-title">
            <i class="fas fa-list"></i> События
          </div>
          <div id="eventsList">
            <!-- Events will be generated by JS -->
          </div>
        </div>
        
        <button class="btn btn-primary" id="addEventBtn" style="margin-top: 20px;">
          Добавить событие
        </button>
      </div>
    </div>
  </main>

  <!-- Transaction Modal -->
  <div class="modal" id="transactionModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="transactionModalTitle">Новая операция</div>
        <button class="close-modal" id="closeTransactionModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Тип операции</label>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-success" id="incomeTypeBtn" style="flex: 1;">Доход</button>
            <button class="btn btn-danger" id="expenseTypeBtn" style="flex: 1;">Расход</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Сумма</label>
          <input type="number" class="form-control" id="transactionAmount" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Категория</label>
          <select class="form-control" id="transactionCategory">
            <option value="Продукты">Продукты</option>
            <option value="Транспорт">Транспорт</option>
            <option value="Жильё">Жильё</option>
            <option value="Здоровье">Здоровье</option>
            <option value="Развлечения">Развлечения</option>
            <option value="Доход">Доход</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Описание</label>
          <input type="text" class="form-control" id="transactionDescription" placeholder="Описание операции">
        </div>
        <div class="form-group">
          <label class="form-label">Дата</label>
          <input type="date" class="form-control" id="transactionDate">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelTransactionBtn">Отмена</button>
        <button class="btn btn-primary" id="saveTransactionBtn">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Shopping Item Modal -->
  <div class="modal" id="shoppingItemModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Редактировать товар</div>
        <button class="close-modal" id="closeShoppingItemModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Название</label>
          <input type="text" class="form-control" id="editItemName" placeholder="Название товара">
        </div>
        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label class="form-label">Количество</label>
            <input type="number" class="form-control" id="editItemQuantity" placeholder="1" min="1">
          </div>
          <div>
            <label class="form-label">Ед. изм.</label>
            <select class="form-control" id="editItemUnit">
              <option value="pcs">шт.</option>
              <option value="liters">л</option>
              <option value="grams">г</option>
              <option value="kg">кг</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="editItemBought" style="margin-right: 8px; width: 16px; height: 16px;">
            <span>Куплено</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelShoppingItemBtn">Отмена</button>
        <button class="btn btn-primary" id="saveShoppingItemBtn">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Новое событие</div>
        <button class="close-modal" id="closeEventModal">&times;</button>
        <button class="close-modal" id="copyEventBtn" style="margin-right: 10px;">Копировать</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Название</label>
          <input type="text" class="form-control" id="eventTitle" placeholder="Название события">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label">Начало</label>
            <input type="datetime-local" class="form-control" id="eventStart">
          </div>
          <div class="form-group">
            <label class="form-label">Окончание</label>
            <input type="datetime-local" class="form-control" id="eventEnd">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Участники</label>
          <div id="participantSelection" style="display: flex; flex-wrap: wrap; gap: 8px;">
            <!-- Participants will be generated by JS -->
          </div>
        </div>
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="isTemplate" style="margin-right: 8px; width: 16px; height: 16px;">
            <span>Сделать шаблоном</span>
          </label>
          <input type="text" class="form-control" id="templateName" placeholder="Название шаблона" style="margin-top: 8px; display: none;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelEventBtn">Отмена</button>
        <button class="btn btn-primary" id="saveEventBtn">Создать</button>
      </div>
    </div>
  </div>

  <!-- Add Participant Modal -->
  <div class="modal" id="addParticipantModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Добавить участника</div>
        <button class="close-modal" id="closeAddParticipantModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Имя участника</label>
          <input type="text" class="form-control" id="newParticipantName" placeholder="Введите имя">
        </div>
        <div class="form-group">
          <label class="form-label">Цвет участника</label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #4361ee; cursor: pointer;" data-color="#4361ee"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #06d6a0; cursor: pointer;" data-color="#06d6a0"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ef476f; cursor: pointer;" data-color="#ef476f"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ffd166; cursor: pointer;" data-color="#ffd166"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #118ab2; cursor: pointer;" data-color="#118ab2"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #073b4c; cursor: pointer;" data-color="#073b4c"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #7209b7; cursor: pointer;" data-color="#7209b7"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #f15bb5; cursor: pointer;" data-color="#f15bb5"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #0077b6; cursor: pointer;" data-color="#0077b6"></div>
            <div class="color-option" style="width: 30px; height: 30px; border-radius: 50%; background-color: #2a9d8f; cursor: pointer;" data-color="#2a9d8f"></div>
          </div>
          <input type="color" id="customColorPicker" value="#4361ee" style="margin-top: 12px; width: 100%; height: 40px; border: none; border-radius: 8px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelAddParticipantBtn">Отмена</button>
        <button class="btn btn-primary" id="saveParticipantBtn">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Настройки</div>
        <button class="close-modal" id="closeSettingsModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Цветовая схема</label>
          <select class="form-control" id="colorScheme">
            <option value="default">По умолчанию</option>
            <option value="dark">Тёмная тема</option>
            <option value="blue">Синяя тема</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Язык интерфейса</label>
          <select class="form-control" id="language">
            <option value="ru">Русский</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="notificationsEnabled" style="margin-right: 8px; width: 16px; height: 16px;" checked>
            <span>Включить уведомления</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">Участники семьи</label>
          <div id="familyMembersList" style="max-height: 200px; overflow-y: auto;">
            <!-- Family members will be generated by JS -->
          </div>
        </div>
        <button class="btn btn-primary" id="addFamilyMemberBtn">Добавить участника</button>
        
        <!-- Planner Time Range -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Время отображения в планировщике</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="form-label">Начало дня</label>
              <input type="time" class="form-control" id="dayStartTime" value="08:00">
            </div>
            <div class="form-group">
              <label class="form-label">Окончание дня</label>
              <input type="time" class="form-control" id="dayEndTime" value="22:00">
            </div>
          </div>
        </div>
        
        <!-- Categories -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Категории</label>
          <div id="categoriesListSettings" style="max-height: 200px; overflow-y: auto;">
            <!-- Categories will be generated by JS -->
          </div>
        </div>
        <button class="btn btn-primary" id="addCategoryBtn">Добавить категорию</button>
        
        <!-- Shopping Settings -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="autoCompleteShopping" style="margin-right: 8px; width: 16px; height: 16px;" checked>
            <span>Автоподстановка покупок из словаря</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-check" style="display: flex; align-items: center;">
            <input type="checkbox" id="sortShoppingByCategory" style="margin-right: 8px; width: 16px; height: 16px;">
            <span>Сортировать покупки по категориям</span>
          </label>
        </div>
        
        <!-- Telegram Integration -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Интеграция с Telegram</label>
          <div class="form-group">
            <input type="text" class="form-control" id="telegramToken" placeholder="Введите токен бота">
          </div>
          <div class="form-group">
            <input type="text" class="form-control" id="telegramChatId" placeholder="Введите ID чата">
          </div>
        </div>
        
        <!-- Export Settings -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Экспорт данных</label>
          <div class="btn-group">
            <button class="btn btn-outline" id="exportJsonBtn">Экспорт в JSON</button>
            <button class="btn btn-outline" id="exportExcelBtn">Экспорт в Excel</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelSettingsBtn">Отмена</button>
        <button class="btn btn-primary" id="saveSettingsBtn">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification">Действие выполнено успешно!</div>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/weekOfYear.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/localeData.min.js"></script>
  <script>
    // Load required Day.js plugins
    dayjs.extend(window.dayjs_plugin_weekOfYear);
    dayjs.extend(window.dayjs_plugin_localeData);
    
    // State management
    let currentBudgetMonth = dayjs().startOf('month'); // Current month
    let currentPlannerMonth = dayjs().startOf('month'); // Current month
    let currentView = 'month';
    let editingTransactionId = null;
    let editingShoppingItemId = null;
    let editingEventId = null;
    let selectedDate = dayjs(); // For storing selected date in planner
    
    // Mock data
    const transactions = [
      { id: 1, date: dayjs('2025-10-17'), type: 'expense', amount: 2450, category: 'Продукты', description: 'Продукты' },
      { id: 2, date: dayjs('2025-10-09'), type: 'income', amount: 45000, category: 'Доход', description: 'Зарплата' },
      { id: 3, date: dayjs('2025-10-07'), type: 'expense', amount: 1200, category: 'Здоровье', description: 'Аптека' }
    ];
    
    const shoppingItems = [
      { id: 1, name: 'Молоко', quantity: 1, unit: 'pcs', isBought: false },
      { id: 2, name: 'Хлеб', quantity: 2, unit: 'pcs', isBought: false },
      { id: 3, name: 'Яйца', quantity: 10, unit: 'pcs', isBought: true },
      { id: 4, name: 'Сыр', quantity: 0.5, unit: 'kg', isBought: false }
    ];
    
    const participants = [
      { id: 1, name: 'Анна', color: '#4361ee' },
      { id: 2, name: 'Иван', color: '#06d6a0' }
    ];
    
    const events = [
      { id: 1, title: 'Ужин', start: dayjs('2025-12-07T19:00:00'), end: dayjs('2025-12-07T21:00:00'), participantIds: [1] },
      { id: 2, title: 'Фильм', start: dayjs('2025-12-09T20:00:00'), end: dayjs('2025-12-09T22:00:00'), participantIds: [2] }
    ];
    
    // Settings
    let settings = {
      colorScheme: 'default',
      language: 'ru',
      notificationsEnabled: true,
      familyMembers: [...participants],
      categories: [
        { id: 1, name: 'Продукты', color: '#4361ee' },
        { id: 2, name: 'Транспорт', color: '#06d6a0' },
        { id: 3, name: 'Жильё', color: '#ef476f' },
        { id: 4, name: 'Здоровье', color: '#ffd166' },
        { id: 5, name: 'Развлечения', color: '#118ab2' },
        { id: 6, name: 'Доход', color: '#073b4c' }
      ],
      autoCompleteShopping: true,
      sortShoppingByCategory: false,
      telegramToken: '',
      telegramChatId: '',
      dayStartTime: '08:00',
      dayEndTime: '22:00'
    };
    
    // Load settings from localStorage
    function loadSettings() {
      const savedSettings = localStorage.getItem('budgetAppSettings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
      }
    }
    
    // Save settings to localStorage
    function saveSettings() {
      localStorage.setItem('budgetAppSettings', JSON.stringify(settings));
    }
    
    // Initialize settings
    loadSettings();
    
    // Utility functions
    function showNotification(message) {
      if (!settings.notificationsEnabled) return;
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    function formatDate(date) {
      return date.format('DD.MM.YY');
    }
    
    function formatTime(date) {
      return date.format('HH:mm');
    }
    
    function getUnitLabel(unit, count) {
      const n = Math.abs(count);
      if (unit === 'pcs') {
        if (n % 10 === 1 && n % 100 !== 11) return 'штука';
        if ([2, 3, 4].includes(n % 10) && ![12, 13, 14].includes(n % 10)) return 'штуки';
        return 'штук';
      }
      return unit === 'liters' ? 'л' : unit === 'grams' ? 'г' : 'кг';
    }
    
    // DOM Elements
    const budgetTab = document.getElementById('budgetTab');
    const shoppingTab = document.getElementById('shoppingTab');
    const plannerTab = document.getElementById('plannerTab');
    const budgetCalendarTitle = document.getElementById('budgetCalendarTitle');
    const budgetCalendarBody = document.getElementById('budgetCalendarBody');
    const categoriesList = document.getElementById('categoriesList');
    const transactionsList = document.getElementById('transactionsList');
    const shoppingList = document.getElementById('shoppingList');
    const topShoppingList = document.getElementById('topShoppingList');
    const plannerCalendar = document.getElementById('plannerCalendar');
    const plannerCalendarTitle = document.getElementById('plannerCalendarTitle');
    const eventsList = document.getElementById('eventsList');
    const eventsListSection = document.getElementById('eventsListSection');
    
    // Modals
    const transactionModal = document.getElementById('transactionModal');
    const shoppingItemModal = document.getElementById('shoppingItemModal');
    const eventModal = document.getElementById('eventModal');
    const settingsModal = document.getElementById('settingsModal');
    const addParticipantModal = document.getElementById('addParticipantModal');
    
    // Initialize the app
    function init() {
      renderBudgetMonth();
      renderCategories();
      renderTransactions();
      renderShoppingList();
      renderTopShoppingList();
      renderPlanner();
      renderEventsList();
      
      // Set up event listeners
      setupEventListeners();
    }
    
    // Render budget calendar
    function renderBudgetMonth() {
      const year = currentBudgetMonth.year();
      const month = currentBudgetMonth.month();
      budgetCalendarTitle.textContent = currentBudgetMonth.format('MMMM YYYY');
      
      // Clear existing calendar
      budgetCalendarBody.innerHTML = '';
      
      // Get first day of month and last day
      const firstDay = currentBudgetMonth.startOf('month');
      const lastDay = currentBudgetMonth.endOf('month');
      const startDate = firstDay.startOf('week');
      
      // Create calendar rows
      let date = startDate;
      for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement('td');
          const dayNum = date.date();
          const isCurrentMonth = date.month() === month;
          
          // Calculate total expenses for this day
          const dayTransactions = transactions.filter(tx => 
            tx.date.date() === dayNum && 
            tx.date.month() === month &&
            tx.date.year() === year &&
            tx.type === 'expense'
          );
          
          const totalExpenses = dayTransactions.reduce((sum, tx) => sum + tx.amount, 0);
          
          cell.innerHTML = `
            <div class="calendar-date ${isCurrentMonth ? '' : 'text-gray-400'} ${dayTransactions.length > 0 ? 'has-transaction' : ''}">
              ${dayNum}
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
              ${totalExpenses > 0 ? totalExpenses.toLocaleString('ru-RU') + ' ₽' : ''}
            </div>
          `;
          
          if (isCurrentMonth) {
            cell.dataset.date = date.format('YYYY-MM-DD');
            // Remove old event listeners to prevent memory leaks
            const newCell = cell.cloneNode(true);
            cell.parentNode.replaceChild(newCell, cell);
            newCell.addEventListener('click', () => openTransactionModal(null, date));
          }
          
          row.appendChild(cell);
          date = date.add(1, 'day');
        }
        
        budgetCalendarBody.appendChild(row);
        
        // Stop if we've passed the end of the month
        if (date.month() > month) break;
      }
    }
    
    // Render categories
    function renderCategories() {
      // Aggregate transactions by category
      const categoryMap = {};
      transactions.forEach(tx => {
        const cat = tx.category;
        const amount = tx.type === 'income' ? tx.amount : -tx.amount;
        categoryMap[cat] = (categoryMap[cat] || 0) + amount;
      });
      
      // Clear existing categories
      categoriesList.innerHTML = '';
      
      // Create category items
      Object.entries(categoryMap)
        .sort(([,a], [,b]) => b - a)
        .forEach(([name, amount]) => {
          const item = document.createElement('div');
          item.className = 'category-item';
          item.innerHTML = `
            <div class="category-name">${name}</div>
            <div class="category-amount ${amount >= 0 ? 'positive' : 'negative'}">
              ${amount >= 0 ? '+' : ''}${amount.toLocaleString('ru-RU')} ₽
            </div>
          `;
          item.addEventListener('click', () => showNotification(`Редактирование категории: ${name}`));
          categoriesList.appendChild(item);
        });
    }
    
    // Render transactions
    function renderTransactions() {
      // Sort transactions by date (newest first)
      const sortedTransactions = [...transactions].sort((a, b) => b.date.unix() - a.date.unix());
      
      // Clear existing transactions
      transactionsList.innerHTML = '';
      
      // Create transaction rows
      sortedTransactions.forEach(tx => {
        const row = document.createElement('tr');
        row.className = 'transaction-row';
        row.innerHTML = `
          <td>${formatDate(tx.date)}</td>
          <td>${tx.description}</td>
          <td>${tx.category}</td>
          <td class="transaction-amount ${tx.type === 'income' ? 'positive' : 'negative'}">
            ${tx.type === 'income' ? '+' : '-'}${tx.amount.toLocaleString('ru-RU')} ₽
          </td>
          <td class="transaction-balance">${calculateBalanceAfter(tx.id).toLocaleString('ru-RU')} ₽</td>
        `;
        row.addEventListener('click', () => openTransactionModal(tx));
        transactionsList.appendChild(row);
      });
    }
    
    // Calculate balance after transaction
    function calculateBalanceAfter(transactionId) {
      const targetTransaction = transactions.find(t => t.id === transactionId);
      if (!targetTransaction) {
        return 0; // Return 0 if transaction is not found
      }
      
      let balance = 0;
      transactions
        .filter(tx => tx.date.unix() <= targetTransaction.date.unix())
        .forEach(tx => {
          balance += tx.type === 'income' ? tx.amount : -tx.amount;
        });
      return balance;
    }
    
    // Render shopping list
    function renderShoppingList() {
      // Clear existing items
      shoppingList.innerHTML = '';
      
      // Sort items if needed
      let itemsToRender = [...shoppingItems];
      if (settings.sortShoppingByCategory) {
        itemsToRender.sort((a, b) => {
          const catA = settings.categories.find(c => c.name === a.category) || { name: 'Другое' };
          const catB = settings.categories.find(c => c.name === b.category) || { name: 'Другое' };
          return catA.name.localeCompare(catB.name);
        });
      }
      
      // Create shopping items
      itemsToRender.forEach(item => {
        const li = document.createElement('li');
        li.className = 'shopping-item';
        li.innerHTML = `
          <input type="checkbox" class="item-checkbox" ${item.isBought ? 'checked' : ''}>
          <div class="item-name" ${item.isBought ? 'style="text-decoration: line-through; color: #94a3b8;"' : ''}>
            ${item.name}
          </div>
          <div class="item-quantity">${item.quantity} ${getUnitLabel(item.unit, item.quantity)}</div>
        `;
        
        // Add event listeners
        const checkbox = li.querySelector('.item-checkbox');
        const nameElement = li.querySelector('.item-name');
        
        li.addEventListener('click', (e) => {
          if (e.target !== checkbox) {
            openShoppingItemModal(item);
          }
        });
        
        checkbox.addEventListener('change', () => {
          item.isBought = checkbox.checked;
          if (checkbox.checked) {
            nameElement.style.textDecoration = 'line-through';
            nameElement.style.color = '#94a3b8';
          } else {
            nameElement.style.textDecoration = 'none';
            nameElement.style.color = '';
          }
          showNotification(checkbox.checked ? 'Товар отмечен как купленный' : 'Товар возвращен в список');
        });
        
        shoppingList.appendChild(li);
      });
    }
    
    // Render top shopping list
    function renderTopShoppingList() {
      topShoppingList.innerHTML = '';
      
      // Group items by name and calculate total quantity
      const groupedItems = {};
      shoppingItems.forEach(item => {
        if (groupedItems[item.name]) {
          groupedItems[item.name].quantity += item.quantity;
        } else {
          groupedItems[item.name] = {
            name: item.name,
            quantity: item.quantity,
            unit: item.unit
          };
        }
      });
      
      // Convert to array and sort by quantity (descending)
      const sortedItems = Object.values(groupedItems).sort((a, b) => b.quantity - a.quantity);
      
      // Show top 10 items
      sortedItems.slice(0, 10).forEach(item => {
        const div = document.createElement('div');
        div.className = 'category-item';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <span>${item.name}</span>
            <span style="color: var(--text-secondary);">${item.quantity} ${getUnitLabel(item.unit, item.quantity)}</span>
          </div>
        `;
        
        div.addEventListener('click', () => {
          document.getElementById('itemName').value = item.name;
          showNotification(`Выбрано: ${item.name}`);
        });
        
        topShoppingList.appendChild(div);
      });
    }
    
    // Render planner based on current view
    function renderPlanner() {
      switch(currentView) {
        case 'day':
          renderPlannerDay();
          break;
        case 'week':
          renderPlannerWeek();
          break;
        case 'month':
        default:
          renderPlannerMonth();
      }
    }
    
    // Render planner for month view
    function renderPlannerMonth() {
      const year = currentPlannerMonth.year();
      const month = currentPlannerMonth.month();
      plannerCalendarTitle.textContent = currentPlannerMonth.format('MMMM YYYY');
      
      // Clear existing calendar
      plannerCalendar.innerHTML = '';
      
      // Add header
      ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
        const headerCell = document.createElement('div');
        headerCell.className = 'calendar-header-cell';
        headerCell.textContent = day;
        plannerCalendar.appendChild(headerCell);
      });
      
      // Get first day of month and last day
      const firstDay = currentPlannerMonth.startOf('month');
      const lastDay = currentPlannerMonth.endOf('month');
      const startDate = firstDay.startOf('week');
      
      // Create calendar days
      let date = startDate;
      for (let i = 0; i < 42; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        
        const dayNum = date.date();
        const isCurrentMonth = date.month() === month;
        
        dayCell.innerHTML = `
          <div class="calendar-date-number ${isCurrentMonth ? '' : 'text-gray-400'}">
            ${dayNum}
          </div>
        `;
        
        // Add events for this day
        const dayEvents = events.filter(e => 
          e.start.date() === dayNum && 
          e.start.month() === month &&
          e.start.year() === year
        );
        
        dayEvents.forEach(event => {
          const participant = participants.find(p => p.id === event.participantIds[0]);
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event-item';
          eventDiv.style.borderLeftColor = participant ? participant.color : '#4361ee';
          eventDiv.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${formatTime(event.start)}</div>
          `;
          eventDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            openEventModal(event);
          });
          dayCell.appendChild(eventDiv);
        });
        
        if (isCurrentMonth) {
          dayCell.dataset.date = date.format('YYYY-MM-DD');
          dayCell.addEventListener('click', () => {
            selectedDate = date;
            openEventModal(null, date);
            renderEventsList(); // Обновляем список событий при выборе даты
          });
        }
        
        plannerCalendar.appendChild(dayCell);
        date = date.add(1, 'day');
        
        // Stop if we've passed the end of the month and have 6 full weeks
        if (i >= 34 && date.month() > month) break;
      }
    }
    
    // Render planner for week view
    function renderPlannerWeek() {
      const currentDate = selectedDate.startOf('week');
      plannerCalendarTitle.textContent = `Неделя ${currentDate.format('DD')} - ${currentDate.add(6, 'day').format('DD MMMM YYYY')}`;
      
      // Clear existing calendar
      plannerCalendar.innerHTML = '';
      
      // Add header
      for (let i = 0; i < 7; i++) {
        const day = currentDate.add(i, 'day');
        const headerCell = document.createElement('div');
        headerCell.className = 'calendar-header-cell';
        headerCell.textContent = `${day.format('ddd')}, ${day.format('DD')}`;
        plannerCalendar.appendChild(headerCell);
      }
      
      // Create day cells for the week
      for (let i = 0; i < 7; i++) {
        const dayDate = currentDate.add(i, 'day');
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        
        // Add events for this day
        const dayEvents = events.filter(e => 
          e.start.date() === dayDate.date() && 
          e.start.month() === dayDate.month() &&
          e.start.year() === dayDate.year()
        );
        
        dayEvents.forEach(event => {
          const participant = participants.find(p => p.id === event.participantIds[0]);
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event-item';
          eventDiv.style.borderLeftColor = participant ? participant.color : '#4361ee';
          eventDiv.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${formatTime(event.start)}</div>
          `;
          eventDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            openEventModal(event);
          });
          dayCell.appendChild(eventDiv);
        });
        
        dayCell.dataset.date = dayDate.format('YYYY-MM-DD');
        dayCell.addEventListener('click', () => {
          selectedDate = dayDate;
          openEventModal(null, dayDate);
          renderEventsList(); // Обновляем список событий при выборе даты
        });
        
        plannerCalendar.appendChild(dayCell);
      }
    }
    
    // Render planner for day view
    function renderPlannerDay() {
      const dayDate = selectedDate;
      plannerCalendarTitle.textContent = dayDate.format('dddd, DD MMMM YYYY');
      
      // Clear existing calendar
      plannerCalendar.innerHTML = '';
      
      // Add header
      const headerCell = document.createElement('div');
      headerCell.className = 'calendar-header-cell';
      headerCell.textContent = dayDate.format('dddd, DD MMMM');
      plannerCalendar.appendChild(headerCell);
      
      // Parse start and end times from settings
      const [startHour, startMinute] = settings.dayStartTime.split(':').map(Number);
      const [endHour, endMinute] = settings.dayEndTime.split(':').map(Number);
      
      // Validate settings to avoid infinite loop
      if (startHour > endHour) {
        console.warn("Start hour is greater than end hour. Using default values.");
        // Use default values
        startHour = 8;
        endHour = 22;
      }
      
      // Create time slots
      for (let hour = startHour; hour <= endHour; hour++) {
        const timeSlot = document.createElement('div');
        timeSlot.className = 'calendar-day';
        timeSlot.style.minHeight = '40px';
        timeSlot.style.position = 'relative';
        
        // Add time label
        const timeLabel = document.createElement('div');
        timeLabel.style.position = 'absolute';
        timeLabel.style.left = '8px';
        timeLabel.style.top = '4px';
        timeLabel.style.fontSize = '12px';
        timeLabel.style.color = '#94a3b8';
        timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
        timeSlot.appendChild(timeLabel);
        
        // Add events for this hour
        const dayEvents = events.filter(e => 
          e.start.date() === dayDate.date() && 
          e.start.month() === dayDate.month() &&
          e.start.year() === dayDate.year() &&
          e.start.hour() === hour
        );
        
        dayEvents.forEach(event => {
          const participant = participants.find(p => p.id === event.participantIds[0]);
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event-item';
          eventDiv.style.borderLeftColor = participant ? participant.color : '#4361ee';
          eventDiv.style.marginTop = '20px';
          eventDiv.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${formatTime(event.start)} - ${formatTime(event.end)}</div>
          `;
          eventDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            openEventModal(event);
          });
          timeSlot.appendChild(eventDiv);
        });
        
        timeSlot.dataset.date = dayDate.format('YYYY-MM-DD');
        timeSlot.dataset.hour = hour;
        timeSlot.addEventListener('click', () => {
          const clickDate = dayDate.hour(hour).minute(0).second(0);
          openEventModal(null, clickDate);
          renderEventsList(); // Обновляем список событий при выборе времени
        });
        
        plannerCalendar.appendChild(timeSlot);
      }
    }
    
    // Render events list
    function renderEventsList() {
      eventsList.innerHTML = '';
      
      // Filter events by selected date depending on current view
      let filteredEvents = [];
      if (currentView === 'month') {
        // Show all events for the current month
        const year = currentPlannerMonth.year();
        const month = currentPlannerMonth.month();
        filteredEvents = events.filter(e => 
          e.start.year() === year && 
          e.start.month() === month
        );
      } else if (currentView === 'week') {
        // Show events for the week of selectedDate
        const weekStart = selectedDate.startOf('week');
        const weekEnd = weekStart.add(6, 'day');
        
        filteredEvents = events.filter(e => 
          e.start.isAfter(weekStart.subtract(1, 'day')) && 
          e.start.isBefore(weekEnd.add(1, 'day'))
        );
      } else { // day
        // Show events for the selected day
        const dayStart = selectedDate.startOf('day');
        const dayEnd = selectedDate.endOf('day');
        
        filteredEvents = events.filter(e => 
          e.start.isAfter(dayStart.subtract(1, 'day')) && 
          e.start.isBefore(dayEnd.add(1, 'day'))
        );
      }
      
      // Sort events by start time
      filteredEvents.sort((a, b) => a.start.unix() - b.start.unix());
      
      if (filteredEvents.length === 0) {
        eventsList.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">Нет событий</div>';
        return;
      }
      
      filteredEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'category-item';
        const participant = participants.find(p => p.id === event.participantIds[0]);
        
        eventDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="participant-color" style="background-color: ${participant ? participant.color : '#4361ee'};"></div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--text);">${event.title}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">${formatDate(event.start)}, ${formatTime(event.start)} - ${formatTime(event.end)}</div>
            </div>
          </div>
        `;
        
        eventDiv.addEventListener('click', () => openEventModal(event));
        eventsList.appendChild(eventDiv);
      });
    }
    
    // Open transaction modal
    function openTransactionModal(transaction = null, date = null) {
      editingTransactionId = transaction ? transaction.id : null;
      
      document.getElementById('transactionModalTitle').textContent = 
        transaction ? 'Редактировать операцию' : 'Новая операция';
      
      if (transaction) {
        document.getElementById('transactionAmount').value = transaction.amount;
        document.getElementById('transactionCategory').value = transaction.category;
        document.getElementById('transactionDescription').value = transaction.description;
        document.getElementById('transactionDate').value = transaction.date.format('YYYY-MM-DD');
        
        if (transaction.type === 'income') {
          document.getElementById('incomeTypeBtn').classList.add('active');
          document.getElementById('expenseTypeBtn').classList.remove('active');
        } else {
          document.getElementById('expenseTypeBtn').classList.add('active');
          document.getElementById('incomeTypeBtn').classList.remove('active');
        }
      } else {
        document.getElementById('transactionAmount').value = '';
        document.getElementById('transactionCategory').value = 'Продукты';
        document.getElementById('transactionDescription').value = '';
        document.getElementById('transactionDate').value = date ? date.format('YYYY-MM-DD') : dayjs().format('YYYY-MM-DD');
        
        document.getElementById('incomeTypeBtn').classList.remove('active');
        document.getElementById('expenseTypeBtn').classList.add('active');
      }
      
      transactionModal.classList.add('active');
    }
    
    // Open shopping item modal
    function openShoppingItemModal(item) {
      editingShoppingItemId = item.id;
      
      document.getElementById('editItemName').value = item.name;
      document.getElementById('editItemQuantity').value = item.quantity;
      document.getElementById('editItemUnit').value = item.unit;
      document.getElementById('editItemBought').checked = item.isBought;
      
      shoppingItemModal.classList.add('active');
    }
    
    // Open event modal
    function openEventModal(event = null, date = null) {
      editingEventId = event ? event.id : null;
      
      if (event) {
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventStart').value = event.start.format('YYYY-MM-DDTHH:mm');
        document.getElementById('eventEnd').value = event.end.format('YYYY-MM-DDTHH:mm');
        document.getElementById('isTemplate').checked = false;
        document.getElementById('templateName').style.display = 'none';
      } else {
        document.getElementById('eventTitle').value = '';
        if (date) {
          // Set start time based on current view
          let start, end;
          if (currentView === 'month') {
            // For month view, use current date but leave time empty
            start = date.startOf('day');
            end = date.startOf('day');
          } else {
            // For week and day views, use the clicked date and time
            start = date;
            end = date.add(1, 'hour'); // Default duration 1 hour
          }
          
          document.getElementById('eventStart').value = start.format('YYYY-MM-DDTHH:mm');
          document.getElementById('eventEnd').value = end.format('YYYY-MM-DDTHH:mm');
        } else {
          const now = dayjs();
          document.getElementById('eventStart').value = now.format('YYYY-MM-DDTHH:mm');
          const end = now.add(1, 'hour');
          document.getElementById('eventEnd').value = end.format('YYYY-MM-DDTHH:mm');
        }
        document.getElementById('isTemplate').checked = false;
        document.getElementById('templateName').style.display = 'none';
      }
      
      // Render participants
      const participantSelection = document.getElementById('participantSelection');
      participantSelection.innerHTML = '';
      participants.forEach(participant => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline participant-btn';
        btn.innerHTML = `
          <span class="participant-color" style="background-color: ${participant.color};"></span>
          ${participant.name}
        `;
        if (event && event.participantIds.includes(participant.id)) {
          btn.classList.add('active');
        }
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
        });
        btn.dataset.participantId = participant.id;
        participantSelection.appendChild(btn);
      });
      
      eventModal.classList.add('active');
    }
    
    // Open settings modal
    function openSettingsModal() {
      // Load current settings into form
      document.getElementById('colorScheme').value = settings.colorScheme;
      document.getElementById('language').value = settings.language;
      document.getElementById('notificationsEnabled').checked = settings.notificationsEnabled;
      document.getElementById('autoCompleteShopping').checked = settings.autoCompleteShopping;
      document.getElementById('sortShoppingByCategory').checked = settings.sortShoppingByCategory;
      document.getElementById('telegramToken').value = settings.telegramToken;
      document.getElementById('telegramChatId').value = settings.telegramChatId;
      document.getElementById('dayStartTime').value = settings.dayStartTime;
      document.getElementById('dayEndTime').value = settings.dayEndTime;
      
      // Render family members
      const familyMembersList = document.getElementById('familyMembersList');
      familyMembersList.innerHTML = '';
      settings.familyMembers.forEach(member => {
        const memberDiv = document.createElement('div');
        memberDiv.style.display = 'flex';
        memberDiv.style.alignItems = 'center';
        memberDiv.style.justifyContent = 'space-between';
        memberDiv.style.padding = '8px';
        memberDiv.style.borderBottom = '1px solid var(--border)';
        
        memberDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="participant-color" style="background-color: ${member.color};"></div>
            <span>${member.name}</span>
          </div>
          <button class="btn btn-outline remove-member-btn" data-id="${member.id}" style="padding: 4px 8px; font-size: 12px;">Удалить</button>
        `;
        
        familyMembersList.appendChild(memberDiv);
      });
      
      // Add event listeners to remove buttons after they're created
      document.querySelectorAll('.remove-member-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const memberId = parseInt(e.currentTarget.dataset.id);
          removeFamilyMember(memberId);
        });
      });
      });
      
      // Render categories
      const categoriesListSettings = document.getElementById('categoriesListSettings');
      categoriesListSettings.innerHTML = '';
      settings.categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.style.display = 'flex';
        categoryDiv.style.align-items = 'center';
        categoryDiv.style.justifyContent = 'space-between';
        categoryDiv.style.padding = '8px';
        categoryDiv.style.borderBottom = '1px solid var(--border)';
        
        categoryDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="participant-color" style="background-color: ${category.color};"></div>
            <span>${category.name}</span>
          </div>
          <button class="btn btn-outline remove-category-btn" data-id="${category.id}" style="padding: 4px 8px; font-size: 12px;">Удалить</button>
        `;
        
        categoriesListSettings.appendChild(categoryDiv);
      });
      
      // Add event listeners to remove category buttons after they're created
      document.querySelectorAll('.remove-category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const categoryId = parseInt(e.currentTarget.dataset.id);
          removeCategory(categoryId);
        });
      });
      
      settingsModal.classList.add('active');
    }
    
    // Remove family member
    function removeFamilyMember(id) {
      settings.familyMembers = settings.familyMembers.filter(m => m.id !== id);
      openSettingsModal(); // Refresh the list
    }
    
    // Add family member
    function addFamilyMember() {
      document.getElementById('newParticipantName').value = '';
      document.getElementById('customColorPicker').value = '#4361ee';
      addParticipantModal.classList.add('active');
    }
    
    // Remove category
    function removeCategory(id) {
      settings.categories = settings.categories.filter(c => c.id !== id);
      openSettingsModal(); // Refresh the list
    }
    
    // Add category
    function addCategory() {
      const name = prompt('Введите название категории:');
      if (!name) return;
      
      // Generate random color
      const colors = ['#4361ee', '#06d6a0', '#ef476f', '#ffd166', '#118ab2', '#073b4c', '#7209b7', '#f15bb5'];
      const color = colors[Math.floor(Math.random() * colors.length)];
      
      const newCategory = {
        id: Date.now(),
        name,
        color
      };
      
      settings.categories.push(newCategory);
      openSettingsModal(); // Refresh the list
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
          
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(tabId + 'Tab').style.display = 'block';
        });
      });
      
      // Budget calendar navigation
      document.getElementById('prevMonthBtn').addEventListener('click', () => {
        currentBudgetMonth = currentBudgetMonth.subtract(1, 'month');
        renderBudgetMonth();
        renderCategories();
        renderTransactions();
      });
      
      document.getElementById('nextMonthBtn').addEventListener('click', () => {
        currentBudgetMonth = currentBudgetMonth.add(1, 'month');
        renderBudgetMonth();
        renderCategories();
        renderTransactions();
      });
      
      // Planner calendar navigation
      document.getElementById('prevPlannerMonthBtn').addEventListener('click', () => {
        currentPlannerMonth = currentPlannerMonth.subtract(1, 'month');
        selectedDate = currentPlannerMonth;
        renderPlanner();
        renderEventsList();
      });
      
      document.getElementById('nextPlannerMonthBtn').addEventListener('click', () => {
        currentPlannerMonth = currentPlannerMonth.add(1, 'month');
        selectedDate = currentPlannerMonth;
        renderPlanner();
        renderEventsList();
      });
      
      // View switching for planner
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.getAttribute('data-view');
          renderPlanner();
          renderEventsList();
          showNotification(`Режим: ${btn.textContent}`);
        });
      });
      
      // Period buttons
      document.getElementById('currentMonthBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('allTimeBtn').classList.remove('active');
        showNotification('Показываем операции за текущий месяц');
      });
      
      document.getElementById('allTimeBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('currentMonthBtn').classList.remove('active');
        showNotification('Показываем все операции');
      });
      
      // Transaction buttons
      document.getElementById('addIncomeBtn').addEventListener('click', () => {
        openTransactionModal(null);
        document.getElementById('incomeTypeBtn').classList.add('active');
        document.getElementById('expenseTypeBtn').classList.remove('active');
      });
      
      document.getElementById('addExpenseBtn').addEventListener('click', () => {
        openTransactionModal(null);
        document.getElementById('expenseTypeBtn').classList.add('active');
        document.getElementById('incomeTypeBtn').classList.remove('active');
      });
      
      // Transaction type buttons
      document.getElementById('incomeTypeBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('expenseTypeBtn').classList.remove('active');
      });
      
      document.getElementById('expenseTypeBtn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('incomeTypeBtn').classList.remove('active');
      });
      
      // Save transaction
      document.getElementById('saveTransactionBtn').addEventListener('click', () => {
        const amount = parseFloat(document.getElementById('transactionAmount').value);
        const category = document.getElementById('transactionCategory').value;
        const description = document.getElementById('transactionDescription').value;
        const dateStr = document.getElementById('transactionDate').value;
        const type = document.getElementById('incomeTypeBtn').classList.contains('active') ? 'income' : 'expense';
        
        if (!amount || amount <= 0) {
          showNotification('Пожалуйста, введите сумму больше 0');
          return;
        }
        
        if (editingTransactionId) {
          // Update existing transaction
          const index = transactions.findIndex(tx => tx.id === editingTransactionId);
          if (index !== -1) {
            transactions[index] = {
              ...transactions[index],
              amount,
              category,
              description,
              date: dayjs(dateStr)
            };
          }
          showNotification('Операция обновлена');
        } else {
          // Add new transaction
          const newTransaction = {
            id: Date.now(),
            date: dayjs(dateStr),
            type,
            amount,
            category,
            description
          };
          transactions.push(newTransaction);
          showNotification('Операция добавлена');
        }
        
        renderBudgetMonth();
        renderCategories();
        renderTransactions();
        transactionModal.classList.remove('active');
      });
      
      // Close transaction modal
      document.getElementById('closeTransactionModal').addEventListener('click', () => {
        transactionModal.classList.remove('active');
      });
      
      document.getElementById('cancelTransactionBtn').addEventListener('click', () => {
        transactionModal.classList.remove('active');
      });
      
      // Shopping item buttons
      document.getElementById('addItemBtn').addEventListener('click', () => {
        const name = document.getElementById('itemName').value.trim();
        const quantity = parseFloat(document.getElementById('itemQuantity').value);
        const unit = document.getElementById('itemUnit').value;
        
        if (!name) {
          showNotification('Пожалуйста, введите название товара');
          return;
        }
        
        if (!quantity || quantity <= 0) {
          showNotification('Количество должно быть больше 0');
          return;
        }
        
        const newItem = {
          id: Date.now(),
          name,
          quantity,
          unit,
          isBought: false
        };
        
        shoppingItems.push(newItem);
        renderShoppingList();
        renderTopShoppingList();
        showNotification(`Добавлено: ${name} - ${quantity} ${getUnitLabel(unit, quantity)}`);
        
        // Clear form
        document.getElementById('itemName').value = '';
        document.getElementById('itemQuantity').value = '1';
      });
      
      // Send to Telegram
      document.getElementById('sendToTelegramBtn').addEventListener('click', () => {
        if (!settings.telegramToken || !settings.telegramChatId) {
          showNotification('Пожалуйста, настройте Telegram в разделе "Настройки"');
          return;
        }
        
        // Create message with shopping list
        let message = 'Список покупок:\n';
        shoppingItems.forEach(item => {
          if (!item.isBought) {
            message += `- ${item.name} (${item.quantity} ${getUnitLabel(item.unit, item.quantity)})\n`;
          }
        });
        
        // In a real implementation, you would send this to Telegram API
        showNotification('Список отправлен в Telegram!');
      });
      
      // Save shopping item
      document.getElementById('saveShoppingItemBtn').addEventListener('click', () => {
        const name = document.getElementById('editItemName').value.trim();
        const quantity = parseFloat(document.getElementById('editItemQuantity').value);
        const unit = document.getElementById('editItemUnit').value;
        const isBought = document.getElementById('editItemBought').checked;
        
        if (!name) {
          showNotification('Пожалуйста, введите название товара');
          return;
        }
        
        if (!quantity || quantity <= 0) {
          showNotification('Количество должно быть больше 0');
          return;
        }
        
        const item = shoppingItems.find(i => i.id === editingShoppingItemId);
        if (item) {
          item.name = name;
          item.quantity = quantity;
          item.unit = unit;
          item.isBought = isBought;
          renderShoppingList();
          renderTopShoppingList();
          showNotification('Товар обновлен');
        }
        
        shoppingItemModal.classList.remove('active');
      });
      
      // Close shopping item modal
      document.getElementById('closeShoppingItemModal').addEventListener('click', () => {
        shoppingItemModal.classList.remove('active');
      });
      
      document.getElementById('cancelShoppingItemBtn').addEventListener('click', () => {
        shoppingItemModal.classList.remove('active');
      });
      
      // Add event button
      document.getElementById('addEventBtn').addEventListener('click', () => {
        openEventModal();
      });
      
      // Copy event button
      document.getElementById('copyEventBtn').addEventListener('click', () => {
        if (editingEventId) {
          const originalEvent = events.find(e => e.id === editingEventId);
          if (originalEvent) {
            // Create a new event with the same title and participants but empty date/time
            const newEvent = {
              id: Date.now(),
              title: originalEvent.title,
              start: dayjs(),
              end: dayjs(),
              participantIds: [...originalEvent.participantIds]
            };
            
            openEventModal(newEvent);
            showNotification('Событие скопировано');
          }
        } else {
          // If creating a new event, just reset the form
          document.getElementById('eventTitle').value = '';
          document.getElementById('eventStart').value = '';
          document.getElementById('eventEnd').value = '';
          document.querySelectorAll('.participant-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          showNotification('Форма очищена для нового события');
        }
      });
      
      // Save event
      document.getElementById('saveEventBtn').addEventListener('click', () => {
        const title = document.getElementById('eventTitle').value.trim();
        
        if (!title) {
          showNotification('Пожалуйста, введите название события');
          return;
        }
        
        const start = dayjs(document.getElementById('eventStart').value);
        const end = dayjs(document.getElementById('eventEnd').value);
        
        if (end.unix() <= start.unix()) {
          showNotification('Время окончания должно быть позже начала');
          return;
        }
        
        // Get selected participants
        const selectedParticipants = [];
        document.querySelectorAll('.participant-btn.active').forEach(btn => {
          selectedParticipants.push(parseInt(btn.dataset.participantId));
        });
        
        if (selectedParticipants.length === 0) {
          selectedParticipants.push(participants[0].id);
        }
        
        const newEvent = {
          id: Date.now(),
          title,
          start,
          end,
          participantIds: selectedParticipants
        };
        
        events.push(newEvent);
        renderPlanner();
        renderEventsList();
        showNotification(`Событие "${title}" создано`);
        eventModal.classList.remove('active');
      });
      
      // Close event modal
      document.getElementById('closeEventModal').addEventListener('click', () => {
        eventModal.classList.remove('active');
      });
      
      document.getElementById('cancelEventBtn').addEventListener('click', () => {
        eventModal.classList.remove('active');
      });
      
      // Template checkbox
      document.getElementById('isTemplate').addEventListener('change', function() {
        document.getElementById('templateName').style.display = this.checked ? 'block' : 'none';
      });
      
      // File upload
      document.getElementById('fileUpload').addEventListener('change', function(e) {
        if (this.files && this.files.length > 0) {
          const fileName = this.files[0].name;
          if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            showNotification('Файл загружен. Будет выполнен парсинг и показан предпросмотр.');
            // In a real implementation, you would parse the file here
          } else {
            showNotification('Пожалуйста, выберите файл Excel (.xlsx или .xls)');
            this.value = '';
          }
        } else {
          showNotification('Файл не выбран');
        }
      });
      
      // Settings button
      document.getElementById('settingsBtn').addEventListener('click', () => {
        openSettingsModal();
      });
      
      // Close settings modal
      document.getElementById('closeSettingsModal').addEventListener('click', () => {
        settingsModal.classList.remove('active');
      });
      
      document.getElementById('cancelSettingsBtn').addEventListener('click', () => {
        settingsModal.classList.remove('active');
      });
      
      // Save settings
      document.getElementById('saveSettingsBtn').addEventListener('click', () => {
        settings.colorScheme = document.getElementById('colorScheme').value;
        settings.language = document.getElementById('language').value;
        settings.notificationsEnabled = document.getElementById('notificationsEnabled').checked;
        settings.autoCompleteShopping = document.getElementById('autoCompleteShopping').checked;
        settings.sortShoppingByCategory = document.getElementById('sortShoppingByCategory').checked;
        settings.telegramToken = document.getElementById('telegramToken').value;
        settings.telegramChatId = document.getElementById('telegramChatId').value;
        settings.dayStartTime = document.getElementById('dayStartTime').value;
        settings.dayEndTime = document.getElementById('dayEndTime').value;
        
        // Apply theme changes
        if (settings.colorScheme === 'dark') {
          document.documentElement.style.setProperty('--surface', '#1e293b');
          document.documentElement.style.setProperty('--surface-light', '#334155');
          document.documentElement.style.setProperty('--text', '#f1f5f9');
          document.documentElement.style.setProperty('--text-secondary', '#cbd5e1');
          document.documentElement.style.setProperty('--border', '#475569');
          document.body.style.backgroundColor = '#0f172a';
        } else if (settings.colorScheme === 'blue') {
          document.documentElement.style.setProperty('--primary', '#3b82f6');
          document.documentElement.style.setProperty('--surface', '#dbeafe');
          document.documentElement.style.setProperty('--text', '#1e3a8a');
          document.documentElement.style.setProperty('--text-secondary', '#3730a3');
          document.documentElement.style.setProperty('--border', '#93c5fd');
        } else {
          // Reset to default
          document.documentElement.style.setProperty('--primary', '#4361ee');
          document.documentElement.style.setProperty('--surface', '#ffffff');
          document.documentElement.style.setProperty('--surface-light', '#f8fafc');
          document.documentElement.style.setProperty('--text', '#1e293b');
          document.documentElement.style.setProperty('--text-secondary', '#64748b');
          document.documentElement.style.setProperty('--border', '#e2e8f0');
          document.body.style.backgroundColor = '#f1f5f9';
        }
        
        saveSettings();
        showNotification('Настройки сохранены');
        settingsModal.classList.remove('active');
      });
      
      // Add family member button
      document.getElementById('addFamilyMemberBtn').addEventListener('click', () => {
        addFamilyMember();
      });
      
      // Add category button
      document.getElementById('addCategoryBtn').addEventListener('click', () => {
        addCategory();
      });
      
      // Export buttons
      document.getElementById('exportJsonBtn').addEventListener('click', () => {
        const data = {
          transactions: transactions.map(t => ({...t, date: t.date.format()})),
          shoppingItems,
          events: events.map(e => ({...e, start: e.start.format(), end: e.end.format()})),
          settings
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'budget_data.json';
        link.click();
        URL.revokeObjectURL(url);
        
        showNotification('Данные экспортированы в JSON');
      });
      
      document.getElementById('exportExcelBtn').addEventListener('click', () => {
        showNotification('Экспорт в Excel пока не реализован');
      });
      
      // Color picker for participants
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', () => {
          document.getElementById('customColorPicker').value = option.dataset.color;
        });
      });
      
      // Save participant
      document.getElementById('saveParticipantBtn').addEventListener('click', () => {
        const name = document.getElementById('newParticipantName').value.trim();
        const color = document.getElementById('customColorPicker').value;
        
        if (!name) {
          showNotification('Пожалуйста, введите имя участника');
          return;
        }
        
        const newMember = {
          id: Date.now(),
          name,
          color
        };
        
        settings.familyMembers.push(newMember);
        openSettingsModal(); // Refresh the list
        addParticipantModal.classList.remove('active');
      });
      
      // Close add participant modal
      document.getElementById('closeAddParticipantModal').addEventListener('click', () => {
        addParticipantModal.classList.remove('active');
      });
      
      document.getElementById('cancelAddParticipantBtn').addEventListener('click', () => {
        addParticipantModal.classList.remove('active');
      });
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
